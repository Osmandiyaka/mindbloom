<div class="mb-auth-page">
    <header class="mb-auth-header">
        <div class="mb-auth-container">
            <div class="auth-logo">
                <span class="auth-logo__mark" aria-hidden="true"></span>
                <span class="auth-logo__text">MindBloom</span>
            </div>
            <a class="auth-link" href="mailto:support@mindbloom.com">Help</a>
        </div>
    </header>

    <main class="mb-auth-main">
        <div class="mb-auth-container">
            <section class="mb-auth-hero">
                <p class="hero-eyebrow">MindBloom Secure Access</p>
                <h2 class="hero-title">Confident sign-in for every campus.</h2>
                <p class="hero-body">
                    Tenant-aware authentication, SSO readiness, and audit-friendly access logs in one unified flow.
                </p>
                <div class="hero-trust">
                    <div>Tenant-aware authentication</div>
                    <div>SSO-ready (SAML/OIDC)</div>
                    <div>Audit-friendly access logs</div>
                </div>
                <ul class="hero-list">
                    <li>Encrypted sessions</li>
                    <li>Secure account recovery</li>
                    <li>Role-based access control</li>
                </ul>
            </section>

            <section class="auth-panel">
                <mb-card class="mb-auth-card">
                    <div class="auth-card__header">
                        <div class="auth-card__title">
                            <h1>
                                @if (tenantStep() === 'login' && tenantName()) {
                                Sign in to {{ tenantName() }}
                                } @else {
                                Sign in
                                }
                            </h1>
                            <p>
                                @if (tenantStep() === 'login') {
                                Use your work email to continue.
                                } @else {
                                Find your organization to continue.
                                }
                            </p>
                        </div>
                    </div>

                    @if (resetSuccess() || errorMessage()) {
                    <div class="auth-alert" tabindex="-1" #alertRef>
                        @if (errorMessage()) {
                        <mb-alert variant="danger">{{ errorMessage() }}</mb-alert>
                        } @else {
                        <mb-alert variant="success">Password reset successfully. Please sign in.</mb-alert>
                        }
                    </div>
                    }

                    @if (tenantStep() === 'select') {
                    <div class="auth-section">
                        <mb-form-field label="Organization" [controlId]="'tenant-org'" [error]="tenantErrorMessage()" hint="Search by school, district, or tenant code.">
                            <mb-input
                                #firstFieldRef
                                id="tenant-org"
                                [value]="organizationQuery()"
                                (valueChange)="organizationQuery.set($event); tenantErrorMessage.set('')"
                                (keydown)="onTenantKeyDown($event, 'org')"
                                placeholder="Enter your organization"
                                ariaLabel="Organization"
                                [disabled]="isValidatingTenant()"
                            ></mb-input>
                        </mb-form-field>

                        <mb-button size="lg" variant="primary" [disabled]="isValidatingTenant() || !organizationQuery().trim()" (click)="onConfirmTenant()">
                            {{ isValidatingTenant() ? 'Checking...' : 'Continue' }}
                        </mb-button>

                        <button class="auth-text-button" type="button" (click)="toggleTenantCode()">
                            {{ showTenantCode() ? 'Hide tenant URL' : 'I have a tenant URL instead' }}
                        </button>

                        @if (showTenantCode()) {
                        <mb-form-field label="Tenant URL" [controlId]="'tenant-code'" hint="This is the subdomain of your MindBloom URL.">
                            <mb-input
                                id="tenant-code"
                                [value]="tenantCode()"
                                (valueChange)="tenantCode.set($event); tenantErrorMessage.set('')"
                                (keydown)="onTenantKeyDown($event, 'code')"
                                placeholder="your-school"
                                ariaLabel="Tenant URL"
                                [disabled]="isValidatingTenant()"
                            ></mb-input>
                        </mb-form-field>

                        <mb-button size="lg" variant="secondary" [disabled]="isValidatingTenant() || !tenantCode().trim()" (click)="onConfirmTenantCode()">
                            Continue with tenant URL
                        </mb-button>
                        }

                        <div class="auth-links">
                            <a href="#" (click)="onRegisterTenant($event)">Create an organization</a>
                            <a href="mailto:support@mindbloom.com">Need help signing in?</a>
                        </div>
                    </div>
                    }

                    @if (tenantStep() === 'login') {
                    <div class="auth-section">
                        <div class="mb-org-context">
                            <div>
                                <p class="mb-org-context__label">Organization</p>
                                <p class="mb-org-context__name">{{ tenantName() || tenantCode() }}</p>
                                <p class="mb-org-context__meta">{{ tenantCode() }}</p>
                            </div>
                            <button class="auth-text-button" type="button" (click)="onChangeTenant()" [disabled]="tenantLocked()">
                                Switch organization
                            </button>
                        </div>

                        @if (ssoMode() !== 'password') {
                        <mb-button size="lg" variant="secondary" (click)="onSsoContinue()">
                            Continue with SSO
                        </mb-button>
                        <p class="auth-note">SSO enabled for this tenant. Use your organization account to continue.</p>
                        }

                        @if (ssoMode() !== 'sso-only') {
                        <form class="auth-form" (ngSubmit)="onSubmit()">
                            <mb-form-field label="Email" [controlId]="'login-email'">
                                <mb-input
                                    #firstFieldRef
                                    type="email"
                                    placeholder="you@school.edu"
                                    id="login-email"
                                    [value]="username()"
                                    (valueChange)="username.set($event); errorMessage.set('')"
                                    ariaLabel="Email"
                                    [disabled]="isLoading()"
                                ></mb-input>
                            </mb-form-field>

                            <div class="auth-password-row">
                                <label class="auth-label" for="login-password">Password</label>
                                <a class="auth-link" routerLink="/auth/forgot">Forgot password?</a>
                            </div>
                            <mb-form-field [controlId]="'login-password'">
                                <mb-input
                                    [type]="showPassword() ? 'text' : 'password'"
                                    placeholder="Enter your password"
                                    id="login-password"
                                    [value]="password()"
                                    (valueChange)="password.set($event); errorMessage.set('')"
                                    (keydown)="handleCapsLock($event)"
                                    ariaLabel="Password"
                                    [disabled]="isLoading()"
                                ></mb-input>
                                <span mbSuffix>
                                    <button class="icon-button" type="button" (click)="togglePassword()" [attr.aria-label]="showPassword() ? 'Hide password' : 'Show password'">
                                        {{ showPassword() ? 'Hide' : 'Show' }}
                                    </button>
                                </span>
                            </mb-form-field>

                            @if (capsLockOn()) {
                            <p class="auth-note">Caps lock is on.</p>
                            }

                            <div class="auth-inline">
                                <mb-checkbox [checked]="rememberMe()" (checkedChange)="rememberMe.set($event)">
                                    Remember me
                                </mb-checkbox>
                            </div>

                            <mb-button type="submit" size="lg" variant="primary" [disabled]="isLoading()">
                                {{ isLoading() ? 'Signing in...' : 'Sign in' }}
                            </mb-button>

                            <p class="auth-security">Protected by encrypted connections and audit logging.</p>
                        </form>
                        }
                    </div>
                    }
                </mb-card>
            </section>
        </div>
    </main>

    <footer class="mb-auth-footer">
        <div class="mb-auth-container">
            <a href="#">Privacy</a>
            <span>•</span>
            <a href="#">Terms</a>
            <span>•</span>
            <a href="#">Status</a>
        </div>
    </footer>
</div>

@if (showRegistration()) {
<app-tenant-registration (cancelled)="onRegistrationCancelled()" (registered)="onRegistrationCompleted($event)"></app-tenant-registration>
}
