<mb-stack gap="var(--mb-space-3)">
  <host-page-header
    title="Staff directory"
    description="Search, filter, and manage staff profiles."
  >
    <mb-inline gap="var(--mb-space-2)" align="center" justify="end" [wrap]="true">
      <mb-button size="sm" variant="secondary" cdkOverlayOrigin #exportOrigin="cdkOverlayOrigin"
        (click)="exportMenuOpen = !exportMenuOpen">
        Export
      </mb-button>
      <mb-popover
        [open]="exportMenuOpen"
        [origin]="exportOrigin"
        [hasBackdrop]="true"
        (closed)="closeExportMenu()"
        [panelClass]="['mb-popover-panel', 'mb-popover-panel--above-modal']"
      >
        <mb-stack gap="var(--mb-space-2)">
          <mb-button size="sm" variant="tertiary" (click)="onExportAction('CSV')">Export CSV</mb-button>
          <mb-button size="sm" variant="tertiary" (click)="onExportAction('Excel')">Export Excel</mb-button>
          <mb-button size="sm" variant="tertiary" (click)="onExportAction('PDF')">Export PDF</mb-button>
          <mb-button size="sm" variant="tertiary" (click)="onExportAction('Print')">Print</mb-button>
        </mb-stack>
      </mb-popover>
      <mb-button size="sm" variant="primary" (click)="openAdd()">+ Add staff</mb-button>
    </mb-inline>
  </host-page-header>

  <mb-inline *ngIf="showSummary" class="staff-summary" gap="var(--mb-space-2)" align="center" [wrap]="true">
    <ng-container *ngFor="let item of summaryItems; let i = index">
      <span>{{ item }}</span>
      <span *ngIf="i < summaryItems.length - 1">•</span>
    </ng-container>
  </mb-inline>

  <mb-card style="--mb-card-padding: 16px;">
    <mb-alert *ngIf="error" variant="danger">
      {{ error }}
      <mb-button size="sm" variant="tertiary" (click)="reload()">Retry</mb-button>
    </mb-alert>

    <mb-stack gap="var(--mb-space-3)">
      <div class="staff-toolbar">
        <mb-inline gap="var(--mb-space-2)" align="center" class="staff-toolbar__left" [wrap]="true">
          <app-search-input
            class="staff-toolbar__search"
            [value]="searchValue"
            [debounceMs]="300"
            placeholder="Search staff by name, staff code, or email…"
            (search)="onSearch($event)"
          ></app-search-input>
          <mb-inline gap="var(--mb-space-2)" align="center">
            <span class="staff-toolbar__label">Status</span>
            <mb-select
              ariaLabel="Filter by status"
              [options]="statusOptions"
              [value]="filters.status"
              (valueChange)="onStatusChange($event)"
            ></mb-select>
          </mb-inline>
        </mb-inline>
        <mb-inline gap="var(--mb-space-2)" align="center" class="staff-toolbar__right" [wrap]="true">
          <div class="staff-density" role="group" aria-label="Table density">
            <mb-button size="sm" variant="tertiary" [class.is-active]="density === 'comfortable'"
              (click)="onDensityChange('comfortable')">Comfortable</mb-button>
            <mb-button size="sm" variant="tertiary" [class.is-active]="density === 'compact'"
              (click)="onDensityChange('compact')">Compact</mb-button>
          </div>
          <mb-button size="sm" variant="tertiary" cdkOverlayOrigin #columnsOrigin="cdkOverlayOrigin"
            (click)="columnsMenuOpen = !columnsMenuOpen">☰ Columns</mb-button>
          <mb-popover
            [open]="columnsMenuOpen"
            [origin]="columnsOrigin"
            [hasBackdrop]="true"
            (closed)="closeColumnsMenu()"
            [panelClass]="['mb-popover-panel', 'mb-popover-panel--above-modal']"
          >
            <mb-stack gap="var(--mb-space-2)">
              <mb-checkbox
                *ngFor="let col of staffTableColumns"
                [checked]="isColumnVisible(col)"
                (checkedChange)="toggleColumn(columnKey(col))"
              >
                {{ col.label }}
              </mb-checkbox>
            </mb-stack>
          </mb-popover>
          <mb-select
            ariaLabel="Rows per page"
            [options]="rowsPerPageOptions"
            [value]="pageSize.toString()"
            (valueChange)="changePageSize($event)"
          ></mb-select>
          <mb-button size="sm" variant="tertiary" *ngIf="hasActiveFilters" (click)="clearFilters()">
            Clear filters
          </mb-button>
        </mb-inline>
      </div>

      <mb-inline class="staff-table-meta" justify="end" *ngIf="helperText">
        {{ helperText }}
      </mb-inline>
      <mb-table
        [columns]="visibleColumns"
        [rows]="pagedStaff"
        [rowKey]="rowKey"
        [rowClass]="rowClass"
        [selectable]="true"
        [sortLocal]="true"
        [density]="density"
        [isLoading]="loading"
        [isFiltered]="hasActiveFilters"
        [isError]="!!error"
        [onRetry]="onRetry"
        [emptyState]="tableEmptyState"
        (emptyAction)="onEmptyAction($event)"
        (rowClick)="viewProfile($event)"
        (selectionChange)="onSelectionChange($event)"
      >
        <ng-template mbTableActions let-row>
          <mb-inline gap="var(--mb-space-2)" align="center">
            <mb-button size="sm" variant="tertiary" class="staff-action-kebab" ariaLabel="Row actions"
              cdkOverlayOrigin #rowMenuOrigin="cdkOverlayOrigin" (click)="toggleRowMenu($event, row)">
              ⋯
            </mb-button>
            <mb-popover
              [open]="openRowMenuId === (row.id || row._id)"
              [origin]="rowMenuOrigin"
              [hasBackdrop]="true"
              (closed)="closeRowMenu()"
              [panelClass]="['mb-popover-panel', 'mb-popover-panel--above-modal']"
            >
              <mb-stack gap="var(--mb-space-2)">
                <mb-button size="sm" variant="tertiary" (click)="viewProfile(row); closeRowMenu()">View profile</mb-button>
                <mb-button size="sm" variant="tertiary" (click)="notify('Edit staff coming soon.'); closeRowMenu()">Edit</mb-button>
                <mb-button size="sm" variant="tertiary"
                  (click)="notify(statusToggleLabel(row) + ' staff coming soon.'); closeRowMenu()">
                  {{ statusToggleLabel(row) }}
                </mb-button>
                <mb-button size="sm" variant="danger" (click)="notify('Archive staff coming soon.'); closeRowMenu()">Archive</mb-button>
                <mb-button size="sm" variant="danger" (click)="notify('Delete staff coming soon.'); closeRowMenu()">Delete</mb-button>
              </mb-stack>
            </mb-popover>
          </mb-inline>
        </ng-template>
      </mb-table>

      <mb-inline *ngIf="staffList.length" gap="var(--mb-space-2)" align="center" justify="space-between" [wrap]="true">
        <div>Page {{ pageIndex }} of {{ pageCount }}</div>
        <mb-inline gap="var(--mb-space-2)" align="center">
          <mb-button size="sm" variant="tertiary" [disabled]="pageIndex === 1" (click)="prevPage()">Prev</mb-button>
          <mb-button size="sm" variant="tertiary" [disabled]="pageIndex === pageCount" (click)="nextPage()">Next</mb-button>
        </mb-inline>
      </mb-inline>
    </mb-stack>
  </mb-card>

  <div *ngIf="toast">{{ toast }}</div>
</mb-stack>
