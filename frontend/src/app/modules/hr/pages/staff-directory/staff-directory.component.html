<mb-stack gap="var(--mb-space-3)">
  <host-page-header
    title="Staff directory"
    description="Search, filter, and manage staff profiles."
  >
    <mb-inline gap="var(--mb-space-2)" align="center" justify="end" [wrap]="true">
      <mb-button size="sm" variant="secondary" cdkOverlayOrigin #exportOrigin="cdkOverlayOrigin"
        (click)="exportMenuOpen = !exportMenuOpen">
        Export
      </mb-button>
      <mb-popover
        [open]="exportMenuOpen"
        [origin]="exportOrigin"
        [hasBackdrop]="true"
        (closed)="closeExportMenu()"
        [panelClass]="['mb-popover-panel', 'mb-popover-panel--above-modal']"
      >
        <mb-stack gap="var(--mb-space-2)">
          <mb-button size="sm" variant="tertiary" (click)="onExportAction('CSV')">Export CSV</mb-button>
          <mb-button size="sm" variant="tertiary" (click)="onExportAction('Excel')">Export Excel</mb-button>
          <mb-button size="sm" variant="tertiary" (click)="onExportAction('PDF')">Export PDF</mb-button>
          <mb-button size="sm" variant="tertiary" (click)="onExportAction('Print')">Print</mb-button>
        </mb-stack>
      </mb-popover>
      <mb-button size="sm" variant="primary" (click)="openAdd()">+ Add staff</mb-button>
    </mb-inline>
  </host-page-header>

  <mb-inline *ngIf="showSummary" class="staff-summary" gap="var(--mb-space-2)" align="center" [wrap]="true">
    <ng-container *ngFor="let item of summaryItems; let i = index">
      <span>{{ item }}</span>
      <span *ngIf="i < summaryItems.length - 1">•</span>
    </ng-container>
  </mb-inline>

  <mb-card style="--mb-card-padding: 16px;">
    <mb-alert *ngIf="error" variant="danger">
      {{ error }}
      <mb-button size="sm" variant="tertiary" (click)="reload()">Retry</mb-button>
    </mb-alert>

    <mb-stack gap="var(--mb-space-3)">
      <div class="staff-toolbar">
        <mb-inline gap="var(--mb-space-2)" align="center" class="staff-toolbar__left" [wrap]="true">
          <app-search-input
            class="staff-toolbar__search"
            [value]="searchValue"
            [debounceMs]="300"
            placeholder="Search staff by name, staff code, or email…"
            (search)="onSearch($event)"
          ></app-search-input>
          <mb-inline gap="var(--mb-space-2)" align="center">
            <span class="staff-toolbar__label">Status</span>
            <mb-select
              ariaLabel="Filter by status"
              [options]="statusOptions"
              [value]="filters.status"
              (valueChange)="onStatusChange($event)"
            ></mb-select>
          </mb-inline>
        </mb-inline>
        <mb-inline gap="var(--mb-space-2)" align="center" class="staff-toolbar__right" [wrap]="true">
          <div class="staff-density" role="group" aria-label="Table density">
            <mb-button size="sm" variant="tertiary" [class.is-active]="density === 'comfortable'"
              (click)="onDensityChange('comfortable')">Comfortable</mb-button>
            <mb-button size="sm" variant="tertiary" [class.is-active]="density === 'compact'"
              (click)="onDensityChange('compact')">Compact</mb-button>
          </div>
          <mb-button size="sm" variant="tertiary" cdkOverlayOrigin #columnsOrigin="cdkOverlayOrigin"
            (click)="columnsMenuOpen = !columnsMenuOpen">☰ Columns</mb-button>
          <mb-popover
            [open]="columnsMenuOpen"
            [origin]="columnsOrigin"
            [hasBackdrop]="true"
            (closed)="closeColumnsMenu()"
            [panelClass]="['mb-popover-panel', 'mb-popover-panel--above-modal']"
          >
            <mb-stack gap="var(--mb-space-2)">
              <mb-checkbox
                *ngFor="let col of staffTableColumns"
                [checked]="isColumnVisible(col)"
                (checkedChange)="toggleColumn(columnKey(col))"
              >
                {{ col.label }}
              </mb-checkbox>
            </mb-stack>
          </mb-popover>
          <mb-select
            ariaLabel="Rows per page"
            [options]="rowsPerPageOptions"
            [value]="pageSize.toString()"
            (valueChange)="changePageSize($event)"
          ></mb-select>
          <mb-button size="sm" variant="tertiary" *ngIf="hasActiveFilters" (click)="clearFilters()">
            Clear filters
          </mb-button>
        </mb-inline>
      </div>

      <mb-inline class="staff-table-meta" justify="end" *ngIf="helperText">
        {{ helperText }}
      </mb-inline>
      <mb-table
        [columns]="visibleColumns"
        [rows]="pagedStaff"
        [rowKey]="rowKey"
        [rowClass]="rowClass"
        [selectable]="true"
        [sortLocal]="true"
        [density]="density"
        [isLoading]="loading"
        [isFiltered]="hasActiveFilters"
        [isError]="!!error"
        [onRetry]="onRetry"
        [emptyState]="tableEmptyState"
        (emptyAction)="onEmptyAction($event)"
        (rowClick)="viewProfile($event)"
        (selectionChange)="onSelectionChange($event)"
      >
        <ng-template mbTableActions let-row>
          <mb-inline gap="var(--mb-space-2)" align="center">
            <mb-button size="sm" variant="tertiary" class="staff-action-kebab" ariaLabel="Row actions"
              cdkOverlayOrigin #rowMenuOrigin="cdkOverlayOrigin" (click)="toggleRowMenu($event, row)">
              ⋯
            </mb-button>
            <mb-popover
              [open]="openRowMenuId === (row.id || row._id)"
              [origin]="rowMenuOrigin"
              [hasBackdrop]="true"
              (closed)="closeRowMenu()"
              [panelClass]="['mb-popover-panel', 'mb-popover-panel--above-modal']"
            >
              <mb-stack gap="var(--mb-space-2)">
                <mb-button size="sm" variant="tertiary" (click)="viewProfile(row); closeRowMenu()">View profile</mb-button>
                <mb-button size="sm" variant="tertiary" (click)="notify('Edit staff coming soon.'); closeRowMenu()">Edit</mb-button>
                <mb-button size="sm" variant="tertiary"
                  (click)="notify(statusToggleLabel(row) + ' staff coming soon.'); closeRowMenu()">
                  {{ statusToggleLabel(row) }}
                </mb-button>
                <mb-button size="sm" variant="danger" (click)="notify('Archive staff coming soon.'); closeRowMenu()">Archive</mb-button>
                <mb-button size="sm" variant="danger" (click)="notify('Delete staff coming soon.'); closeRowMenu()">Delete</mb-button>
              </mb-stack>
            </mb-popover>
          </mb-inline>
        </ng-template>
      </mb-table>

      <mb-inline *ngIf="staffList.length" gap="var(--mb-space-2)" align="center" justify="space-between" [wrap]="true">
        <div>Page {{ pageIndex }} of {{ pageCount }}</div>
        <mb-inline gap="var(--mb-space-2)" align="center">
          <mb-button size="sm" variant="tertiary" [disabled]="pageIndex === 1" (click)="prevPage()">Prev</mb-button>
          <mb-button size="sm" variant="tertiary" [disabled]="pageIndex === pageCount" (click)="nextPage()">Next</mb-button>
        </mb-inline>
      </mb-inline>
    </mb-stack>
  </mb-card>

  <div *ngIf="toast">{{ toast }}</div>
</mb-stack>

<mb-modal class="staff-modal-shell" [open]="createStaffOpen" [closeable]="false" size="lg"
  (closed)="requestCloseCreateStaff()">
  <div class="staff-modal__layout">
    <div class="staff-modal__header">
      <div class="staff-modal__header-main">
        <div class="staff-modal__icon" aria-hidden="true">
          <svg viewBox="0 0 24 24" role="img" aria-hidden="true" focusable="false">
            <path
              d="M16 11a4 4 0 1 0-8 0M12 15c-3.3 0-6 2.2-6 5h12c0-2.8-2.7-5-6-5Z"
              fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round"
              stroke-linejoin="round" />
            <path d="M18 8a3 3 0 1 0-3-3" fill="none" stroke="currentColor" stroke-width="1.5"
              stroke-linecap="round" stroke-linejoin="round" />
          </svg>
        </div>
        <div>
          <div class="staff-modal__title">Add staff</div>
          <div class="staff-modal__subtitle">Add a staff member to start managing their profile.</div>
        </div>
      </div>
      <button type="button" class="staff-modal__close" aria-label="Close modal"
        (click)="requestCloseCreateStaff()">x</button>
    </div>

    <div class="staff-modal__error" *ngIf="createError">
      <div class="staff-modal__error-title">{{ createError }}</div>
    </div>

    <div class="staff-modal__scroll">
      <div class="staff-modal__columns">
        <div class="staff-modal__section">
          <div class="staff-modal__section-label">IDENTITY</div>
          <div class="staff-modal__section-title">Staff identity</div>
          <div class="staff-modal__section-helper">Core identity details for staff records.</div>
          <div class="staff-modal__grid">
            <mb-form-field class="staff-modal__field" label="Staff code" [required]="true"
              [controlId]="'staff-form-code'" [error]="createFieldError('staffCode')">
              <mb-input id="staff-form-code" cdkFocusInitial [value]="createForm.staffCode"
                placeholder="e.g. ST-001" (valueChange)="createForm.staffCode = $event"
                (blurEvent)="createTouched.staffCode = true"></mb-input>
            </mb-form-field>
            <mb-form-field class="staff-modal__field" label="Status" [controlId]="'staff-form-status'">
              <mb-select id="staff-form-status" ariaLabel="Staff status"
                [options]="createStatusOptions" [value]="createForm.status || ''"
                (valueChange)="onCreateStatusChange($event)"></mb-select>
            </mb-form-field>
            <mb-form-field class="staff-modal__field" label="First name" [required]="true"
              [controlId]="'staff-form-first-name'" [error]="createFieldError('firstName')">
              <mb-input id="staff-form-first-name" [value]="createForm.firstName"
                placeholder="First name" (valueChange)="createForm.firstName = $event"
                (blurEvent)="createTouched.firstName = true"></mb-input>
            </mb-form-field>
            <mb-form-field class="staff-modal__field" label="Last name" [required]="true"
              [controlId]="'staff-form-last-name'" [error]="createFieldError('lastName')">
              <mb-input id="staff-form-last-name" [value]="createForm.lastName"
                placeholder="Last name" (valueChange)="createForm.lastName = $event"
                (blurEvent)="createTouched.lastName = true"></mb-input>
            </mb-form-field>
            <mb-form-field class="staff-modal__field staff-modal__field--full"
              label="Preferred name" [controlId]="'staff-form-preferred-name'">
              <mb-input id="staff-form-preferred-name" [value]="createForm.preferredName"
                placeholder="Preferred name" (valueChange)="createForm.preferredName = $event"></mb-input>
            </mb-form-field>
          </div>
        </div>
      </div>
    </div>

    <div class="staff-modal__footer">
      <div class="staff-modal__footer-note">Required fields are marked.</div>
      <div class="staff-modal__footer-actions">
        <mb-button size="sm" variant="tertiary" (click)="requestCloseCreateStaff()">Cancel</mb-button>
        <mb-button size="sm" variant="primary" [disabled]="createSaving" (click)="submitCreateStaff()">
          Add staff
        </mb-button>
      </div>
    </div>
  </div>
</mb-modal>

<mb-modal [open]="createDiscardOpen" title="Discard changes?" size="sm" (closed)="closeCreateDiscard()">
  <div>Any unsaved changes will be lost.</div>
  <div mbModalFooter>
    <mb-button size="sm" variant="tertiary" (click)="closeCreateDiscard()">Keep editing</mb-button>
    <mb-button size="sm" variant="primary" (click)="confirmDiscardCreate()">Discard</mb-button>
  </div>
</mb-modal>
