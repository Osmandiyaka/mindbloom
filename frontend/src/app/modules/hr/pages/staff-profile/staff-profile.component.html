<div class="profile-page">
  <header class="page-header">
    <div>
      <p class="eyebrow">HR · Profile</p>
      <h1>{{ staff()?.fullName || (staff()?.firstName + ' ' + staff()?.lastName) || 'Loading...' }}</h1>
      <p class="muted">Manage personal, employment, compensation, and supporting documents.</p>
    </div>
    <div class="header-actions">
      <app-button variant="secondary" size="sm" (click)="backToDirectory()">Back to Directory</app-button>
      <app-button variant="primary" size="sm" (click)="saveForms()" [disabled]="saving()">Save Changes</app-button>
    </div>
  </header>

  <div class="toast" *ngIf="toast() as t" [class.success]="t.type === 'success'" [class.error]="t.type === 'error'">
    {{ t.message }}
  </div>

  <div class="content-grid" *ngIf="!loading(); else loadingState">
    <app-card class="summary-card">
      <div class="summary-top">
        <div class="avatar">
          {{ (staff()?.fullName || staff()?.firstName || '?') | slice:0:2 | uppercase }}
        </div>
        <div class="summary-info">
          <h3>{{ staff()?.fullName || (staff()?.firstName + ' ' + staff()?.lastName) }}</h3>
          <p class="muted">{{ staff()?.designationCode || 'Role pending' }} · {{ staff()?.departmentCode || 'Department' }}</p>
          <span class="pill status">{{ staff()?.status || 'active' }}</span>
        </div>
      </div>
      <div class="summary-meta">
        <div><p class="label">Employee ID</p><p class="value">{{ staff()?.employeeId || '-' }}</p></div>
        <div><p class="label">Joined</p><p class="value">{{ staff()?.joinDate || '-' }}</p></div>
        <div><p class="label">Contract</p><p class="value">{{ staff()?.contractType || '-' }}</p></div>
        <div><p class="label">Email</p><p class="value">{{ staff()?.email || '-' }}</p></div>
      </div>
    </app-card>

    <app-card class="tabs-card">
      <nav class="tabs">
        <button type="button" [class.active]="activeTab() === 'overview'" (click)="setTab('overview')">Overview</button>
        <button type="button" [class.active]="activeTab() === 'employment'" (click)="setTab('employment')">Employment</button>
        <button type="button" [class.active]="activeTab() === 'comp'" (click)="setTab('comp')">Compensation</button>
        <button type="button" [class.active]="activeTab() === 'docs'" (click)="setTab('docs')">Documents</button>
        <button type="button" [class.active]="activeTab() === 'leave'" (click)="setTab('leave')">Leave Summary</button>
        <button type="button" [class.active]="activeTab() === 'attendance'" (click)="setTab('attendance')">Attendance</button>
      </nav>

      <section class="tab-panel" *ngIf="activeTab() === 'overview'">
        <form [formGroup]="personalForm" class="form-grid">
          <label>First Name
            <input formControlName="firstName" />
            <span class="error" *ngIf="controlInvalid(personalForm, 'firstName')">First name is required.</span>
          </label>
          <label>Last Name
            <input formControlName="lastName" />
            <span class="error" *ngIf="controlInvalid(personalForm, 'lastName')">Last name is required.</span>
          </label>
          <label>Email
            <input type="email" formControlName="email" />
            <span class="error" *ngIf="controlInvalid(personalForm, 'email')">Enter a valid email.</span>
          </label>
          <label>Phone
            <input formControlName="phone" />
          </label>
          <label>Date of Birth
            <input type="date" formControlName="dateOfBirth" />
          </label>
        </form>
      </section>

      <section class="tab-panel" *ngIf="activeTab() === 'employment'">
        <form [formGroup]="employmentForm" class="form-grid">
          <label>Department
            <input formControlName="departmentCode" placeholder="Dept code" />
          </label>
          <label>Designation
            <input formControlName="designationCode" placeholder="Role code" />
          </label>
          <label>Employee ID
            <input formControlName="employeeId" />
          </label>
          <label>Join Date
            <input type="date" formControlName="joinDate" />
          </label>
          <label>Contract Type
            <select formControlName="contractType">
              <option value="full-time">Full-time</option>
              <option value="part-time">Part-time</option>
              <option value="contract">Contract</option>
            </select>
          </label>
        </form>
      </section>

      <section class="tab-panel" *ngIf="activeTab() === 'comp'">
        <div class="muted" *ngIf="!canViewComp">Compensation details are masked for your role.</div>
        <form *ngIf="canViewComp" [formGroup]="compensationForm" class="form-grid narrow">
          <label>Amount
            <input type="number" min="0" step="0.01" formControlName="amount" />
            <span class="error" *ngIf="controlInvalid(compensationForm, 'amount')">Amount must be zero or more.</span>
          </label>
          <label>Currency
            <input formControlName="currency" />
          </label>
          <label>Frequency
            <select formControlName="frequency">
              <option value="monthly">Monthly</option>
              <option value="hourly">Hourly</option>
              <option value="annual">Annual</option>
            </select>
          </label>
          <p class="muted small">Masked for non-HR roles; requires permission to view.</p>
        </form>
      </section>

      <section class="tab-panel" *ngIf="activeTab() === 'docs'">
        <div class="docs-head">
          <div>
            <p class="strong">Documents</p>
            <p class="muted small">Upload contracts, IDs, certifications.</p>
          </div>
          <label class="upload-chip">
            <input type="file" (change)="uploadDoc($event)" multiple />
            Upload
          </label>
        </div>
        <div class="docs-list">
          <div class="doc-row" *ngFor="let doc of docs()">
            <div>
              <p class="strong">{{ doc.name }}</p>
              <p class="muted small">{{ doc.size }} · {{ doc.type }}</p>
              <div class="progress" *ngIf="doc.status === 'uploading'">
                <div class="bar" [style.width.%]="doc.progress || 0"></div>
              </div>
            </div>
            <div class="doc-actions">
              <span class="pill" [class.muted]="doc.status !== 'complete'">{{ doc.status }}</span>
              <button type="button" (click)="viewDoc(doc)">Preview</button>
              <button type="button" (click)="deleteDoc(doc.id)">Delete</button>
            </div>
          </div>
          <div *ngIf="!docs().length" class="muted">No documents uploaded.</div>
        </div>
      </section>

      <section class="tab-panel" *ngIf="activeTab() === 'leave'">
        <div class="muted" *ngIf="loading()">Loading leave summary…</div>
        <div class="empty" *ngIf="!loading() && !(staff()?.leaveSummary)">No leave summary available.</div>
        <div class="summary-grid" *ngIf="!loading() && staff()?.leaveSummary">
          <div class="summary-pill" *ngFor="let item of staff()?.leaveSummary">
            <p class="label">{{ item.name }}</p>
            <p class="value">{{ item.remaining }} days left</p>
            <p class="muted small">Used {{ item.used }} of {{ item.total }}</p>
          </div>
        </div>
      </section>

      <section class="tab-panel" *ngIf="activeTab() === 'attendance'">
        <div class="muted" *ngIf="loading()">Loading attendance…</div>
        <div class="empty" *ngIf="!loading() && !(staff()?.attendanceSummary)">No attendance summary available.</div>
        <div class="summary-grid" *ngIf="!loading() && staff()?.attendanceSummary">
          <div class="summary-pill">
            <p class="label">On-time %</p>
            <p class="value">{{ staff()?.attendanceSummary?.onTime || 0 }}%</p>
          </div>
          <div class="summary-pill">
            <p class="label">Late</p>
            <p class="value">{{ staff()?.attendanceSummary?.late || 0 }} days</p>
          </div>
          <div class="summary-pill">
            <p class="label">Absent</p>
            <p class="value">{{ staff()?.attendanceSummary?.absent || 0 }} days</p>
          </div>
        </div>
      </section>
    </app-card>
  </div>

  <ng-template #loadingState>
    <div class="skeleton-card">
      <div class="skeleton-line wide"></div>
      <div class="skeleton-line"></div>
      <div class="skeleton-line"></div>
    </div>
  </ng-template>
</div>
