<div class="onboarding-page">
    <mb-card class="onboarding-card">
        <div class="onboarding-header">
            <h1>{{ stepTitle() }}</h1>
            <p>{{ stepSubtitle() }}</p>
        </div>

        <div class="onboarding-steps" role="list">
            <div class="step" [class.active]="step() === 1" role="listitem">
                <span class="step-dot" aria-hidden="true"></span>
                <span class="step-label">Organization</span>
            </div>
            <div class="step" [class.active]="step() === 2 || step() === 3" role="listitem">
                <span class="step-dot" aria-hidden="true"></span>
                <span class="step-label">Administrator</span>
            </div>
            <div class="step" [class.active]="step() === 4" role="listitem">
                <span class="step-dot" aria-hidden="true"></span>
                <span class="step-label">Verification</span>
            </div>
        </div>

        @if (validationSummary().length > 1) {
        <mb-alert variant="warning" class="onboarding-alert">
            <div class="alert-title">Please review the information below</div>
            <ul class="alert-list">
                @for (message of validationSummary(); track message) {
                <li>{{ message }}</li>
                }
            </ul>
        </mb-alert>
        }

        <mb-alert *ngIf="errorMessage()" variant="danger">{{ errorMessage() }}</mb-alert>

        @if (isLoading()) {
        <div class="onboarding-loading">Loading onboarding details…</div>
        } @else {
        <div class="onboarding-body">
            @if (step() === 1) {
            <div class="step-section">
                <mb-form-field label="Organization name" [controlId]="'org-name'"
                    [hint]="'This will be the primary name of your MindBloom workspace.'" [error]="orgNameError()">
                    <mb-input id="org-name" [value]="tenantName()" (valueChange)="tenantName.set($event)"></mb-input>
                </mb-form-field>

                <mb-form-field label="Workspace URL" [controlId]="'org-code'" [hint]="codeHint()" [error]="codeError()">
                    <mb-input id="org-code" [value]="tenantCode()" (valueChange)="onTenantCodeInput($event)"></mb-input>
                    <div class="tenant-url-preview">https://[your-name].mindbloom.app</div>
                </mb-form-field>

                <mb-form-field label="Country or region" [controlId]="'org-country'"
                    [hint]="'Used for regional settings and compliance.'" [error]="countryError()">
                    <mb-combobox id="org-country" [options]="countryOptions" [value]="orgCountry()"
                        placeholder="Select a country or region" (valueChange)="onCountryInput($event)"
                        (blurEvent)="onCountryBlur()"></mb-combobox>
                </mb-form-field>

                <mb-form-field label="Primary contact email" [controlId]="'org-contact-email'"
                    [hint]="'We’ll use this email for important account notifications.'" [error]="contactEmailError()">
                    <mb-input id="org-contact-email" type="email" [value]="orgContactEmail()"
                        (valueChange)="orgContactEmail.set($event)"></mb-input>
                </mb-form-field>
            </div>
            }

            @if (step() === 2) {
            <div class="step-section">
                <div class="mode-selector">
                    <button type="button" class="mode-card" [class.active]="schoolMode() === 'single'"
                        (click)="setSchoolMode('single')">
                        <div class="mode-title">Single school</div>
                        <div class="mode-subtitle">One school operating under this organization.</div>
                    </button>
                    <button type="button" class="mode-card" [class.active]="schoolMode() === 'multi'"
                        (click)="setSchoolMode('multi')">
                        <div class="mode-title">Multiple schools</div>
                        <div class="mode-subtitle">Districts or groups managing more than one school.</div>
                    </button>
                </div>

                <div class="school-list">
                    @for (row of schoolRows(); track $index) {
                    <div class="school-row" [class.readonly]="row.existing">
                        <mb-form-field label="School name" [controlId]="'school-name-' + $index">
                            <mb-input [id]="'school-name-' + $index" [value]="row.name" [disabled]="!!row.existing"
                                (valueChange)="updateSchoolName($index, $event)">
                            </mb-input>
                        </mb-form-field>

                        <mb-form-field label="School code (optional)" [controlId]="'school-code-' + $index">
                            <mb-input [id]="'school-code-' + $index" [value]="row.code || ''"
                                [disabled]="!!row.existing" (valueChange)="updateSchoolCode($index, $event)">
                            </mb-input>
                        </mb-form-field>

                        <button type="button" class="remove-row" *ngIf="!row.existing && schoolRows().length > 1"
                            (click)="removeSchoolRow($index)">
                            Remove
                        </button>
                    </div>
                    }
                </div>

                <button type="button" class="add-row" (click)="addSchoolRow()">Add another school</button>
            </div>
            }

            @if (step() === 3) {
            <div class="step-section">
                <div class="edition-grid">
                    @for (edition of editions(); track edition.id) {
                    <button type="button" class="edition-card" [class.selected]="selectedEditionId() === edition.id"
                        (click)="selectEdition(edition)">
                        <div class="edition-title">{{ edition.displayName || edition.name }}</div>
                        <div class="edition-description">{{ edition.description || 'Configured for your organization.'
                            }}</div>
                        @if (editionFeatures(edition).length) {
                        <ul class="edition-features">
                            @for (feature of editionFeatures(edition); track feature) {
                            <li>{{ feature }}</li>
                            }
                        </ul>
                        }
                    </button>
                    }
                </div>
            </div>
            }

            @if (step() === 4) {
            <div class="step-section">
                <div class="review-grid">
                    <div class="review-card">
                        <div class="review-title">Organization</div>
                        <div class="review-item">{{ tenantName() }}</div>
                        <div class="review-sub">{{ tenantCode() }}</div>
                        <div class="review-sub" *ngIf="orgContactEmail()">{{ orgContactEmail() }}</div>
                    </div>
                    <div class="review-card">
                        <div class="review-title">Schools</div>
                        @for (name of reviewSchools(); track name) {
                        <div class="review-item">{{ name }}</div>
                        }
                    </div>
                    <div class="review-card">
                        <div class="review-title">Edition</div>
                        <div class="review-item">{{ selectedEditionName() || 'Not selected' }}</div>
                    </div>
                </div>

                <mb-checkbox [checked]="createExtraAdmin()" (checkedChange)="createExtraAdmin.set($event)">
                    Add another administrator
                </mb-checkbox>

                @if (createExtraAdmin()) {
                <div class="admin-form">
                    <mb-form-field label="First name" [controlId]="'admin-first-name'">
                        <mb-input id="admin-first-name" [value]="adminFirstName()"
                            (valueChange)="adminFirstName.set($event)"></mb-input>
                    </mb-form-field>
                    <mb-form-field label="Last name" [controlId]="'admin-last-name'">
                        <mb-input id="admin-last-name" [value]="adminLastName()"
                            (valueChange)="adminLastName.set($event)"></mb-input>
                    </mb-form-field>
                    <mb-form-field label="Admin email" [controlId]="'admin-email'">
                        <mb-input id="admin-email" type="email" [value]="adminEmail()"
                            (valueChange)="adminEmail.set($event)"></mb-input>
                    </mb-form-field>
                    <mb-form-field label="Temporary password" [controlId]="'admin-password'">
                        <mb-input id="admin-password" type="password" [value]="adminPassword()"
                            (valueChange)="adminPassword.set($event)">
                        </mb-input>
                    </mb-form-field>
                </div>
                }
            </div>
            }
        </div>
        }

        <div class="onboarding-actions">
            <mb-button variant="tertiary" (click)="back()" [disabled]="step() === 1 || isSaving()">Back</mb-button>
            <mb-button variant="tertiary" (click)="saveAndExit()" [disabled]="isSaving()">Save &amp; exit</mb-button>
            <mb-button variant="primary" [loading]="isSaving()" [fullWidth]="true" [disabled]="!canContinue()"
                [attr.title]="!canContinue() ? 'Complete all required fields to continue.' : null" (click)="next()">
                {{ step() === 4 ? 'Create organization' : 'Continue' }}
            </mb-button>
        </div>
    </mb-card>
</div>