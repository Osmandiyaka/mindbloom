<div class="setup-page">
    <mb-card class="setup-card">
        <div class="setup-loading" *ngIf="isLoading()">Loading workspace setup…</div>

        <ng-container *ngIf="!isLoading()">
            <div class="setup-entry" *ngIf="step() === 0">
                <div class="setup-header">
                    <div class="setup-entry-title">
                        <span class="setup-icon" aria-hidden="true">✓</span>
                        <h1>Finish setting up your workspace</h1>
                    </div>
                    <p class="setup-entry-body">
                        Set up your schools, academic structure, and staff so your team can start working right away.
                    </p>
                    <p class="setup-entry-meta">Takes about 5–10 minutes · You can pause and continue anytime from
                        Settings.</p>
                </div>

                <div class="setup-body">
                    <div class="setup-actions setup-entry-actions">
                        <mb-button variant="primary" (click)="startSetup()">Start setup</mb-button>
                        <div class="setup-skip-block">
                            <mb-button variant="tertiary" (click)="skipSetup()">Skip for now</mb-button>
                            <p class="setup-skip-hint">Resume later from Settings → Workspace setup.</p>
                        </div>
                    </div>
                </div>
            </div>

            <div class="workspace-setup-grid" *ngIf="step() > 0 && !isDoneStep()">
                <div class="workspace-setup-nav">
                    <mb-card class="setup-nav-card">
                        <div class="setup-progress__content">
                            <div class="setup-progress__header">
                                <div class="setup-progress__kicker">Workspace configuration</div>
                                <h2>Setup progress</h2>
                                <p>Complete the setup to enable all features. You can return at any time from Settings.
                                </p>
                            </div>
                            <div class="setup-progress__meta">Step {{ progressIndex() < 0 ? 0 : progressIndex() + 1 }}
                                    of {{ stepLabels.length }}</div>
                                    <div class="setup-progress__bar" aria-hidden="true">
                                        <div class="setup-progress__bar-fill" [style.width.%]="progressPercent()"></div>
                                    </div>
                                    <div class="setup-progress__list">
                                        <button type="button" class="setup-progress__item"
                                            *ngFor="let label of stepLabels; let i = index"
                                            [class.is-complete]="i < progressIndex()"
                                            [class.is-current]="i === progressIndex()" (click)="goToStep(i + 1)">
                                            <span class="setup-progress__icon" aria-hidden="true">{{ i < progressIndex()
                                                    ? '✓' : (i===progressIndex() ? '●' : '○' ) }}</span>
                                                    <span class="setup-progress__label">{{ label }}</span>
                                        </button>
                                    </div>
                                    <div class="setup-progress__actions">
                                        <mb-button variant="primary" (click)="continueFromPanel()">Continue
                                            setup</mb-button>
                                        <button type="button" class="setup-progress__dismiss"
                                            (click)="skipSetup()">Dismiss for now</button>
                                        <span class="setup-progress__hint">
                                            You can resume anytime from Settings → Workspace setup.
                                            <span class="setup-progress__info" aria-hidden="true"
                                                title="Setup is saved automatically.">i</span>
                                        </span>
                                    </div>
                            </div>
                    </mb-card>
                </div>
                <div class="workspace-setup-content">
                    <mb-card class="setup-content-card">
                        <mb-alert *ngIf="errorMessage()" variant="danger">{{ errorMessage() }}</mb-alert>

                        <div class="setup-body" id="setup-step-content" *ngIf="step() === 1">
                            <div class="setup-section">
                                <h2>Schools</h2>
                                <p>Manage the schools under your organization. You can add, edit, or deactivate schools
                                    at any time.</p>

                                <div class="schools-grid">
                                    <div class="schools-table-wrap">
                                        <div class="schools-table__titlebar">
                                            <div class="schools-table__title">Schools</div>
                                            <mb-button variant="primary" (click)="openAddSchool()">+ Add
                                                school</mb-button>
                                        </div>
                                        <mb-table class="schools-table" *ngIf="schoolRows().length; else emptySchools"
                                            [columns]="schoolTableColumns" [rows]="schoolRows()"
                                            (cellClick)="handleSchoolCellClick($event)">
                                            <ng-template mbTableActions let-row>
                                                <div class="schools-table__actions">
                                                    <button type="button" class="schools-menu__toggle" #schoolMenuOrigin
                                                        aria-label="More actions"
                                                        [attr.aria-expanded]="schoolMenuOpenIndex() === getSchoolRowIndex(row)"
                                                        (click)="toggleSchoolMenu(getSchoolRowIndex(row), $event)">⋯</button>
                                                    <mb-popover
                                                        [open]="schoolMenuOpenIndex() === getSchoolRowIndex(row)"
                                                        [origin]="schoolMenuOrigin"
                                                        [hasBackdrop]="true"
                                                        [panelClass]="['mb-popover-panel', 'mb-popover-panel--above-modal', 'schools-menu__panel']"
                                                        (closed)="closeSchoolMenu()"
                                                    >
                                                        <div class="schools-menu__panel-content" role="menu">
                                                            <button type="button" class="schools-menu__item"
                                                                (click)="openEditSchool(getSchoolRowIndex(row)); closeSchoolMenu()">
                                                                Edit school
                                                            </button>
                                                            <button type="button" class="schools-menu__item"
                                                                (click)="toggleSchoolStatus(getSchoolRowIndex(row)); closeSchoolMenu()">
                                                                {{ row.status === 'Active' ? 'Deactivate school' :
                                                                'Activate school' }}
                                                            </button>
                                                            <button type="button" class="schools-menu__item"
                                                                (click)="deleteSchool(getSchoolRowIndex(row)); closeSchoolMenu()">
                                                                Delete school
                                                            </button>
                                                        </div>
                                                    </mb-popover>
                                                </div>
                                            </ng-template>
                                        </mb-table>

                                        <ng-template #emptySchools>
                                            <div class="schools-empty">
                                                <div class="schools-empty__icon" aria-hidden="true">
                                                    <svg viewBox="0 0 24 24" role="img" focusable="false">
                                                        <path
                                                            d="M4 10.5l8-5 8 5v8.5a1 1 0 0 1-1 1H5a1 1 0 0 1-1-1v-8.5Z"
                                                            fill="none" stroke="currentColor" stroke-width="1.5"
                                                            stroke-linejoin="round" />
                                                        <path d="M9 20v-6h6v6" fill="none" stroke="currentColor"
                                                            stroke-width="1.5" stroke-linecap="round" />
                                                    </svg>
                                                </div>
                                                <div class="schools-empty__title">No schools added yet</div>
                                                <div class="schools-empty__text">
                                                    Add your first school to continue setup.
                                                </div>
                                                <mb-button variant="primary" (click)="openAddSchool()">+ Add
                                                    school</mb-button>
                                            </div>
                                        </ng-template>
                                    </div>
                                </div>
                                <div class="schools-modal" *ngIf="isSchoolModalOpen()" role="presentation">
                                    <div class="schools-modal__backdrop"></div>
                                    <div class="schools-modal__dialog" role="dialog" aria-modal="true"
                                        aria-labelledby="school-modal-title" tabindex="0"
                                        (keydown.escape)="closeSchoolModal()">
                                        <div class="schools-modal__header">
                                            <div>
                                                <div id="school-modal-title" class="schools-modal__title">
                                                    {{ editingSchoolIndex() === null ? 'Add school' : 'Edit school' }}
                                                </div>
                                                <div class="schools-modal__subtitle">
                                                    Add a school to your organization. You can update details later.
                                                </div>
                                            </div>
                                            <button type="button" class="schools-modal__close"
                                                (click)="closeSchoolModal()" aria-label="Close dialog">×</button>
                                        </div>
                                        <div class="schools-modal__body">
                                            <div class="schools-modal__section">
                                                <div class="schools-modal__section-title">Identity</div>
                                                <mb-form-field label="School name" [controlId]="'school-form-name'"
                                                    hint="This is the name shown across the platform."
                                                    [error]="schoolFormTouched() && !schoolFormName().trim() ? 'School name is required.' : ''">
                                                    <mb-input id="school-form-name" [value]="schoolFormName()"
                                                        (valueChange)="onSchoolFormNameChange($event)"
                                                        (blur)="markSchoolFormTouched()"></mb-input>
                                                </mb-form-field>

                                                <mb-form-field label="School code" [controlId]="'school-form-code'"
                                                    hint="Used internally for identifiers and integrations."
                                                    [error]="schoolFormCodeError()">
                                                    <mb-input id="school-form-code" [value]="schoolFormCode()"
                                                        (valueChange)="onSchoolFormCodeChange($event)"
                                                        (blur)="markSchoolFormTouched()"></mb-input>
                                                </mb-form-field>
                                            </div>

                                            <div class="schools-modal__section">
                                                <div class="schools-modal__section-title">Location & time</div>
                                                <mb-form-field label="Country or region"
                                                    [controlId]="'school-form-country'"
                                                    [error]="schoolFormCountryError()">
                                                    <app-country-select id="school-form-country"
                                                        [value]="schoolFormCountry()"
                                                        (valueChange)="onSchoolFormCountryChange($event)"
                                                        (blurEvent)="markSchoolFormTouched()"></app-country-select>
                                                </mb-form-field>

                                                <app-address [value]="schoolFormAddress()"
                                                    [showCopy]="!!tenantAddress()"
                                                    [copyLabel]="'Copy from organization'" [title]="'Address'"
                                                    [controlPrefix]="'school-form-address'"
                                                    (valueChange)="schoolFormAddress.set($event)"
                                                    (copyFromTenant)="copySchoolAddressFromTenant()"></app-address>

                                                <mb-form-field label="Time zone" [controlId]="'school-form-timezone'"
                                                    hint="Used for schedules, attendance, and reports."
                                                    [error]="schoolFormTimezoneError()">
                                                    <app-timezone-select id="school-form-timezone"
                                                        [value]="schoolFormTimezone()"
                                                        (valueChange)="schoolFormTimezone.set($event)"
                                                        (blurEvent)="markSchoolFormTouched()"></app-timezone-select>
                                                </mb-form-field>
                                            </div>
                                        </div>
                                        <div class="schools-modal__footer">
                                            <div class="schools-modal__hint">Configuration changes are saved
                                                automatically.</div>
                                            <div class="schools-modal__actions">
                                                <mb-button variant="secondary"
                                                    (click)="closeSchoolModal()">Cancel</mb-button>
                                                <mb-button variant="primary" [disabled]="!canSaveSchool()"
                                                    (click)="saveSchool()">
                                                    {{ editingSchoolIndex() === null ? 'Add school' : 'Save changes' }}
                                                </mb-button>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="setup-footer">
                                <div class="setup-footer__actions">
                                    <mb-button variant="secondary" (click)="back()">Back</mb-button>
                                    <mb-button variant="primary" [disabled]="!canContinue()"
                                        (click)="next()">Continue</mb-button>
                                </div>
                                <div class="setup-footer__aside">
                                    <button type="button" class="setup-skip-link" (click)="skipSetup()">Skip for
                                        now</button>
                                    <div class="setup-footer__hint">You can change this later from Settings.</div>
                                </div>
                            </div>
                            <div class="setup-auto-save"><span aria-hidden="true">✓</span> Configuration changes are
                                saved automatically.</div>
                        </div>

                        <div class="setup-body" *ngIf="step() === 3">
                            <div class="setup-section">
                                <h2>Organizational units</h2>
                                <p>Build a hierarchy of schools, divisions, and departments for access and reporting.
                                </p>

                                <div class="ou-layout">
                                    <div class="ou-nav">
                                        <div class="ou-nav__header">
                                            <div class="ou-nav__kicker">Organization</div>
                                            <div class="ou-nav__title-row">
                                                <div class="ou-nav__title">Units</div>
                                                <mb-button class="ou-nav__add" variant="tertiary"
                                                    (click)="startAddRootUnit()">
                                                    <span class="ou-nav__add-icon" aria-hidden="true">+</span>
                                                    <span>Add root unit</span>
                                                </mb-button>
                                            </div>
                                        </div>

                                        <ng-container *ngIf="orgUnitTree().length; else ouEmptyTree">
                                            <div class="ou-tree" role="tree">
                                                <ng-container *ngFor="let node of orgUnitTree(); trackBy: trackOrgUnit">
                                                    <ng-container
                                                        *ngTemplateOutlet="orgUnitNode; context: { $implicit: node, depth: 0 }"></ng-container>
                                                </ng-container>
                                            </div>
                                        </ng-container>
                                        <ng-template #ouEmptyTree>
                                            <div class="ou-empty">
                                                <div class="ou-empty__title">No organizational units yet</div>
                                                <div class="ou-empty__text">Create a root unit to start building your
                                                    hierarchy.</div>
                                            </div>
                                        </ng-template>
                                    </div>

                                    <div class="ou-canvas">
                                        <ng-container *ngIf="selectedOrgUnit(); else ouEmptyDetail">
                                            <div class="ou-canvas__header">
                                                <div>
                                                    <div class="ou-breadcrumb">{{ selectedOrgUnitPath() }}</div>
                                                    <div class="ou-canvas__title">{{ selectedOrgUnit()!.name }}</div>
                                                    <div class="ou-canvas__meta">{{ selectedOrgUnit()!.type }} ·
                                                        {{ selectedOrgUnit()!.status }}</div>
                                                    <div class="ou-breadcrumb">
                                                        Organization / {{ selectedOrgUnitPath() }}
                                                    </div>
                                                </div>
                                                <div class="ou-canvas__actions">
                                                    <mb-button class="ou-action-btn" variant="secondary"
                                                        (click)="startAddChildUnit()">Add child unit</mb-button>
                                                    <button type="button" class="ou-actions-menu__toggle"
                                                        #ouActionsMenuOrigin aria-label="More actions"
                                                        title="More actions"
                                                        [attr.aria-expanded]="ouActionsMenuOpen()"
                                                        (click)="toggleOuActionsMenu($event)">⋯</button>
                                                    <mb-popover
                                                        [open]="ouActionsMenuOpen()"
                                                        [origin]="ouActionsMenuOrigin"
                                                        [hasBackdrop]="true"
                                                        [panelClass]="['mb-popover-panel', 'mb-popover-panel--above-modal', 'ou-actions-menu__panel']"
                                                        (closed)="closeOuActionsMenu()"
                                                    >
                                                        <div class="ou-actions-menu__panel-content" role="menu">
                                                            <button type="button" class="ou-actions-menu__item"
                                                                [disabled]="!selectedOrgUnit()"
                                                                (click)="openRenameOrgUnit(); closeOuActionsMenu()">
                                                                Rename unit
                                                            </button>
                                                            <button type="button" class="ou-actions-menu__item"
                                                                [disabled]="!selectedOrgUnit()"
                                                                (click)="openMoveOrgUnit(); closeOuActionsMenu()">
                                                                Move unit
                                                            </button>
                                                            <button type="button" class="ou-actions-menu__item"
                                                                [disabled]="!selectedOrgUnit()"
                                                                (click)="openChangeParentOrgUnit(); closeOuActionsMenu()">
                                                                Change parent
                                                            </button>
                                                            <button type="button" class="ou-actions-menu__item"
                                                                [disabled]="!canDeactivateSelectedOrgUnit()"
                                                                [attr.title]="selectedOrgUnit()?.status === 'Inactive' ? 'Unit is already inactive.' : null"
                                                                (click)="openDeactivateOrgUnit(); closeOuActionsMenu()">
                                                                Deactivate unit
                                                            </button>
                                                            <div class="ou-actions-menu__divider"></div>
                                                            <button type="button"
                                                                class="ou-actions-menu__item ou-actions-menu__item--danger"
                                                                [disabled]="!canDeleteSelectedOrgUnit()"
                                                                [attr.title]="getOrgUnitDeleteDisabledReason()"
                                                                (click)="openDeleteOrgUnit(); closeOuActionsMenu()">
                                                                Delete unit
                                                            </button>
                                                        </div>
                                                    </mb-popover>
                                                </div>
                                            </div>

                                            <div class="ou-tabs" role="tablist">
                                                <button type="button" class="ou-tab"
                                                    [class.is-active]="activeOrgUnitTab() === 'members'" role="tab"
                                                    [attr.aria-selected]="activeOrgUnitTab() === 'members'"
                                                    (click)="setOrgUnitTab('members')">
                                                    Members <span class="ou-tab__count">({{ selectedOrgUnitMemberCount() }})</span>
                                                </button>
                                                <button type="button" class="ou-tab"
                                                    [class.is-active]="activeOrgUnitTab() === 'roles'" role="tab"
                                                    [attr.aria-selected]="activeOrgUnitTab() === 'roles'"
                                                    (click)="setOrgUnitTab('roles')">
                                                    Roles <span class="ou-tab__count">({{ selectedOrgUnitRoleCount() }})</span>
                                                </button>
                                            </div>

                                            <div *ngIf="activeOrgUnitTab() === 'members'" class="ou-members">
                                                <div class="ou-toolbar">
                                                    <div class="ou-search">
                                                        <mb-input [value]="orgUnitMemberSearch()"
                                                            (valueChange)="orgUnitMemberSearch.set($event)"
                                                            placeholder="Search members..."></mb-input>
                                                    </div>
                                                    <mb-button class="ou-action-btn" variant="primary"
                                                        [disabled]="!users().length" (click)="openAssignMembers()">Add
                                                        members</mb-button>
                                                </div>
                                                <div class="ou-toolbar__hint">
                                                    Members assigned here inherit this unit’s access.
                                                </div>

                                                <div class="ou-assign" *ngIf="assignMembersOpen()">
                                                    <div class="ou-assign__title">Assign members</div>
                                                    <div class="ou-assign__list"
                                                        *ngIf="users().length; else ouAssignEmpty">
                                                        <label class="ou-assign__row"
                                                            *ngFor="let user of users(); trackBy: trackUserRow">
                                                            <input type="checkbox"
                                                                [checked]="assignMemberIds().includes(user.id)"
                                                                (change)="toggleAssignMember(user.id, $event)" />
                                                            <span class="ou-assign__name">{{ user.name || user.email
                                                                }}</span>
                                                            <span class="ou-assign__meta">{{ user.email }}</span>
                                                        </label>
                                                    </div>
                                                    <ng-template #ouAssignEmpty>
                                                        <div class="ou-assign__empty">Add staff in the previous step to
                                                            assign
                                                            them here.</div>
                                                    </ng-template>
                                                    <div class="ou-assign__actions">
                                                        <mb-button variant="secondary"
                                                            (click)="cancelAssignMembers()">Cancel</mb-button>
                                                        <mb-button variant="primary"
                                                            (click)="saveAssignMembers()">Save</mb-button>
                                                    </div>
                                                </div>

                                                <ng-container
                                                    *ngIf="selectedOrgUnitMembers().length; else ouMembersEmpty">
                                                    <div class="ou-members-table">
                                                        <div class="ou-members-table__header">
                                                            <div>Name</div>
                                                            <div>Role</div>
                                                            <div>Status</div>
                                                            <div class="ou-members-table__actions">Actions</div>
                                                        </div>
                                                        <div class="ou-members-table__row"
                                                            *ngFor="let member of selectedOrgUnitMembers(); trackBy: trackUserRow">
                                                            <div class="ou-members-table__name">
                                                                <div class="ou-members-table__name-text">
                                                                    {{ member.name || '—' }}
                                                                </div>
                                                                <div class="ou-members-table__email"
                                                                    [attr.title]="member.email">
                                                                    {{ member.email }}
                                                                </div>
                                                            </div>
                                                            <div>{{ member.role }}</div>
                                                            <div>
                                                                <span class="ou-status-pill"
                                                                    [class.ou-status-pill--active]="member.status === 'Active'"
                                                                    [class.ou-status-pill--invited]="member.status === 'Invited'">
                                                                    {{ member.status }}
                                                                </span>
                                                            </div>
                                                            <div class="ou-members-table__actions">
                                                                <button type="button" class="ou-row-action ou-row-action--subtle"
                                                                    title="Remove from unit (does not delete user)"
                                                                    (click)="confirmRemoveMemberFromOrgUnit(member)">
                                                                    Remove
                                                                </button>
                                                            </div>
                                                        </div>
                                                    </div>
                                                </ng-container>
                                                <ng-template #ouMembersEmpty>
                                                    <div class="ou-empty ou-empty--inline">
                                                        <div class="ou-empty__text">
                                                            Assign members to control access and responsibilities.
                                                        </div>
                                                    </div>
                                                </ng-template>
                                            </div>

                                            <div *ngIf="activeOrgUnitTab() === 'roles'" class="ou-roles">
                                                <div class="ou-toolbar">
                                                    <div class="ou-search">
                                                        <mb-input [value]="orgUnitRoleSearch()"
                                                            (valueChange)="orgUnitRoleSearch.set($event)"
                                                            placeholder="Search roles..."></mb-input>
                                                    </div>
                                                    <mb-button class="ou-action-btn" variant="primary"
                                                        (click)="openAssignRoles()">Add roles</mb-button>
                                                </div>

                                                <div class="ou-assign" *ngIf="assignRolesOpen()">
                                                    <div class="ou-assign__title">Assign roles</div>
                                                    <div class="ou-assign__selector">
                                                        <mb-role-selector [value]="assignRoleIds()" label=""
                                                            placeholder="Select roles..."
                                                            (change)="handleAssignRoleChange($event)">
                                                        </mb-role-selector>
                                                    </div>
                                                    <div class="ou-assign__actions">
                                                        <mb-button variant="secondary"
                                                            (click)="cancelAssignRoles()">Cancel</mb-button>
                                                        <mb-button variant="primary"
                                                            (click)="saveAssignRoles()">Save</mb-button>
                                                    </div>
                                                </div>

                                                <ng-container *ngIf="selectedOrgUnitRoles().length; else ouRolesEmpty">
                                                    <div class="ou-roles-table">
                                                        <div class="ou-roles-table__header">
                                                            <div>Role</div>
                                                            <div>Description</div>
                                                            <div class="ou-roles-table__actions">Actions</div>
                                                        </div>
                                                        <div class="ou-roles-table__row"
                                                            *ngFor="let role of selectedOrgUnitRoles(); trackBy: trackOrgUnitRole">
                                                            <div class="ou-roles-table__name">
                                                                {{ role.name }}
                                                            </div>
                                                            <div class="ou-roles-table__description">
                                                                {{ role.description || '—' }}
                                                            </div>
                                                            <div class="ou-roles-table__actions">
                                                                <button type="button" class="ou-row-action"
                                                                    (click)="removeRoleFromOrgUnit(role)">
                                                                    Remove
                                                                </button>
                                                            </div>
                                                        </div>
                                                    </div>
                                                </ng-container>
                                                <ng-template #ouRolesEmpty>
                                                    <div class="ou-empty ou-empty--inline ou-empty--roles">
                                                        <div class="ou-empty__title">No roles assigned</div>
                                                        <div class="ou-empty__text">
                                                            Assign roles to control access for this unit.
                                                        </div>
                                                        <mb-button variant="secondary" (click)="openAssignRoles()">Assign roles</mb-button>
                                                    </div>
                                                </ng-template>
                                                <div class="ou-helper">
                                                    Roles assigned here inherit to child units. Add overrides at
                                                    specific
                                                    units when needed.
                                                </div>
                                            </div>
                                        </ng-container>

                                        <ng-template #ouEmptyDetail>
                                            <div class="ou-empty ou-empty--detail">
                                                <div class="ou-empty__title">Select an organizational unit</div>
                                                <div class="ou-empty__text">Choose a unit from the tree to manage
                                                    members
                                                    and roles.</div>
                                            </div>
                                        </ng-template>
                                    </div>
                                </div>

                                <ng-template #orgUnitNode let-node let-depth="depth">
                                    <button type="button" class="ou-tree__node"
                                        [style.--ou-depth]="depth"
                                        [class.ou-tree__node--child]="depth > 0"
                                        [class.is-active]="activeOrgUnitId() === node.id" role="treeitem"
                                        [attr.aria-expanded]="node.children.length ? isOrgUnitExpanded(node.id) : null"
                                        (click)="selectOrgUnit(node.id)">
                                        <span class="ou-tree__caret" *ngIf="node.children.length"
                                            (click)="toggleOrgUnitExpanded(node.id); $event.stopPropagation()">
                                            {{ isOrgUnitExpanded(node.id) ? '▾' : '▸' }}
                                        </span>
                                        <span class="ou-tree__spacer" *ngIf="!node.children.length"></span>
                                        <span class="ou-tree__indent" *ngIf="depth > 0 && !node.children.length">›</span>
                                        <span class="ou-tree__label">{{ node.name }}</span>
                                        <span class="ou-tree__badge" *ngIf="node.children.length">
                                            {{ node.children.length }}
                                        </span>
                                    </button>
                                    <div class="ou-tree__children" role="group"
                                        *ngIf="node.children.length && isOrgUnitExpanded(node.id)">
                                        <ng-container *ngFor="let child of node.children; trackBy: trackOrgUnit">
                                            <ng-container
                                                *ngTemplateOutlet="orgUnitNode; context: { $implicit: child, depth: depth + 1 }"></ng-container>
                                        </ng-container>
                                    </div>
                                </ng-template>

                                <mb-modal [open]="orgUnitFormOpen()" title="Add organizational unit" size="md"
                                    [hasFooter]="true" (closed)="requestCloseOrgUnitForm()">
                                    <div class="ou-modal">
                                        <div class="ou-modal__subtitle"
                                            *ngIf="orgUnitFormParentId(); else ouRootSubtitle">
                                            Create a child unit under {{ selectedOrgUnit()?.name || 'Selected unit' }}.
                                        </div>
                                        <ng-template #ouRootSubtitle>
                                            <div class="ou-modal__subtitle">Create a new root unit for your
                                                organization.</div>
                                        </ng-template>

                                        <div class="ou-modal__section">
                                            <div class="ou-modal__section-label">Parent unit</div>
                                            <div class="ou-modal__context-value">
                                                {{ selectedOrgUnit()?.name || 'Organization' }}
                                            </div>
                                        </div>

                                        <div class="ou-modal__section">
                                            <div class="ou-modal__section-label">Identity</div>
                                            <div class="ou-modal__fields">
                                                <mb-form-field label="Unit name" [controlId]="'org-unit-name'">
                                                    <mb-input id="org-unit-name" [value]="orgUnitFormName()"
                                                        (valueChange)="orgUnitFormName.set($event)">
                                                    </mb-input>
                                                </mb-form-field>
                                                <mb-form-field label="Unit type" [controlId]="'org-unit-type'">
                                                    <mb-select id="org-unit-type" [value]="orgUnitFormType()"
                                                        (valueChange)="setOrgUnitFormType($event)">
                                                        <option *ngFor="let type of orgUnitTypes" [value]="type">
                                                            {{ type }}
                                                        </option>
                                                    </mb-select>
                                                </mb-form-field>
                                            </div>
                                            <div class="ou-modal__helper">Used for access control and reporting.</div>
                                        </div>

                                        <div class="ou-modal__section">
                                            <div class="ou-modal__section-label">Status</div>
                                            <div class="ou-modal__radios">
                                                <label class="ou-modal__radio">
                                                    <input type="radio" name="org-unit-status" value="Active"
                                                        [checked]="orgUnitFormStatus() === 'Active'"
                                                        (change)="orgUnitFormStatus.set('Active')" />
                                                    <span>Active</span>
                                                </label>
                                                <label class="ou-modal__radio">
                                                    <input type="radio" name="org-unit-status" value="Inactive"
                                                        [checked]="orgUnitFormStatus() === 'Inactive'"
                                                        (change)="orgUnitFormStatus.set('Inactive')" />
                                                    <span>Inactive</span>
                                                </label>
                                            </div>
                                        </div>

                                        <div class="ou-form__error" *ngIf="orgUnitFormError()">
                                            {{ orgUnitFormError() }}
                                        </div>
                                    </div>

                                    <div mbModalFooter class="ou-modal__footer">
                                        <mb-button variant="secondary"
                                            (click)="requestCloseOrgUnitForm()">Cancel</mb-button>
                                        <mb-button variant="primary" (click)="saveOrgUnitForm()"
                                            [disabled]="!orgUnitFormName().trim()">Create unit</mb-button>
                                    </div>
                                </mb-modal>

                                <mb-modal [open]="isOrgUnitDeleteOpen()" title="Delete organizational unit" size="sm"
                                    [hasFooter]="true" [closeable]="!orgUnitDeleteSubmitting()"
                                    [closeOnBackdrop]="!orgUnitDeleteSubmitting()"
                                    (closed)="requestCloseDeleteOrgUnit()">
                                    <div class="ou-delete">
                                        <div class="ou-delete__subtitle">
                                            This action will permanently delete this unit and all of its child units.
                                        </div>
                                        <mb-alert *ngIf="orgUnitDeleteError()" variant="danger">
                                            {{ orgUnitDeleteError() }}
                                        </mb-alert>
                                        <div class="ou-delete__loading" *ngIf="orgUnitDeleteImpactLoading()">
                                            Loading delete impact…
                                        </div>
                                        <div class="ou-delete__impact" *ngIf="!orgUnitDeleteImpactLoading()">
                                            <div class="ou-delete__row">
                                                <span>Unit</span>
                                                <span>{{ orgUnitDeleteTarget()?.name }}</span>
                                            </div>
                                            <div class="ou-delete__row">
                                                <span>Child units</span>
                                                <span>{{ orgUnitDeleteImpact()?.childUnits ?? 0 }}</span>
                                            </div>
                                            <div class="ou-delete__row">
                                                <span>Members affected</span>
                                                <span>{{ orgUnitDeleteImpact()?.members ?? 0 }}</span>
                                            </div>
                                            <div class="ou-delete__row">
                                                <span>Roles removed</span>
                                                <span>{{ orgUnitDeleteImpact()?.roles ?? 0 }}</span>
                                            </div>
                                            <div class="ou-delete__warning" id="ou-delete-warning">
                                                This action cannot be undone.
                                            </div>
                                        </div>

                                        <mb-form-field *ngIf="orgUnitDeleteRequiresConfirm()"
                                            label="Type the unit name to confirm"
                                            [controlId]="'ou-delete-confirm'"
                                            hint="Enter '{{ orgUnitDeleteTarget()?.name }}' to enable deletion.">
                                            <mb-input id="ou-delete-confirm" [value]="orgUnitDeleteConfirm()"
                                                (valueChange)="orgUnitDeleteConfirm.set($event)"
                                                [placeholder]="orgUnitDeleteTarget()?.name || ''"></mb-input>
                                        </mb-form-field>
                                    </div>

                                    <div mbModalFooter class="ou-delete__footer">
                                        <mb-button variant="secondary" cdkFocusInitial
                                            (click)="requestCloseDeleteOrgUnit()"
                                            [disabled]="orgUnitDeleteSubmitting()">Cancel</mb-button>
                                        <mb-button variant="danger" [loading]="orgUnitDeleteSubmitting()"
                                            [disabled]="orgUnitDeleteRequiresConfirm() && !isOrgUnitDeleteConfirmValid()"
                                            [attr.aria-describedby]="'ou-delete-warning'"
                                            (click)="deleteSelectedOrgUnit()">
                                            Delete unit
                                        </mb-button>
                                    </div>
                                </mb-modal>

                                <mb-modal [open]="isOrgUnitRenameOpen()" title="Rename organizational unit" size="sm"
                                    [hasFooter]="true" [closeable]="!orgUnitRenameSubmitting()"
                                    [closeOnBackdrop]="!orgUnitRenameSubmitting()"
                                    (closed)="requestCloseRenameOrgUnit()">
                                    <div class="ou-rename">
                                        <div class="ou-rename__subtitle">
                                            Update the unit name. Changes apply immediately.
                                        </div>
                                        <mb-alert *ngIf="orgUnitRenameError()" variant="danger">
                                            {{ orgUnitRenameError() }}
                                        </mb-alert>
                                        <mb-form-field label="Unit name" [controlId]="'ou-rename-name'">
                                            <mb-input id="ou-rename-name" [value]="orgUnitRenameName()"
                                                (valueChange)="orgUnitRenameName.set($event)" cdkFocusInitial>
                                            </mb-input>
                                        </mb-form-field>
                                    </div>

                                    <div mbModalFooter class="ou-rename__footer">
                                        <mb-button variant="secondary" (click)="requestCloseRenameOrgUnit()"
                                            [disabled]="orgUnitRenameSubmitting()">Cancel</mb-button>
                                        <mb-button variant="primary" [loading]="orgUnitRenameSubmitting()"
                                            (click)="saveRenameOrgUnit()">
                                            Save changes
                                        </mb-button>
                                    </div>
                                </mb-modal>

                                <mb-modal [open]="isOrgUnitMoveOpen()" title="Move organizational unit" size="sm"
                                    [hasFooter]="true" [closeable]="!orgUnitMoveSubmitting()"
                                    [closeOnBackdrop]="!orgUnitMoveSubmitting()"
                                    (closed)="requestCloseMoveOrgUnit()">
                                    <div class="ou-move">
                                        <div class="ou-move__subtitle">
                                            Choose a new parent for this unit.
                                        </div>
                                        <mb-alert *ngIf="orgUnitMoveError()" variant="danger">
                                            {{ orgUnitMoveError() }}
                                        </mb-alert>
                                        <mb-form-field label="Parent unit" [controlId]="'ou-move-parent'">
                                            <mb-select id="ou-move-parent" [value]="orgUnitMoveParentId() || ''"
                                                (valueChange)="setOrgUnitMoveParent($event)">
                                                <option *ngFor="let option of orgUnitParentOptions()"
                                                    [value]="option.id || ''">
                                                    {{ option.label }}
                                                </option>
                                            </mb-select>
                                        </mb-form-field>
                                    </div>

                                    <div mbModalFooter class="ou-move__footer">
                                        <mb-button variant="secondary" (click)="requestCloseMoveOrgUnit()"
                                            [disabled]="orgUnitMoveSubmitting()">Cancel</mb-button>
                                        <mb-button variant="primary" [loading]="orgUnitMoveSubmitting()"
                                            (click)="saveMoveOrgUnit()">
                                            Move unit
                                        </mb-button>
                                    </div>
                                </mb-modal>

                                <mb-modal [open]="isOrgUnitChangeParentOpen()" title="Change parent" size="sm"
                                    [hasFooter]="true" [closeable]="!orgUnitMoveSubmitting()"
                                    [closeOnBackdrop]="!orgUnitMoveSubmitting()"
                                    (closed)="requestCloseChangeParentOrgUnit()">
                                    <div class="ou-move">
                                        <div class="ou-move__subtitle">
                                            Update the parent for this unit.
                                        </div>
                                        <mb-alert *ngIf="orgUnitMoveError()" variant="danger">
                                            {{ orgUnitMoveError() }}
                                        </mb-alert>
                                        <mb-form-field label="Parent unit" [controlId]="'ou-change-parent'">
                                            <mb-select id="ou-change-parent" [value]="orgUnitMoveParentId() || ''"
                                                (valueChange)="setOrgUnitMoveParent($event)">
                                                <option *ngFor="let option of orgUnitParentOptions()"
                                                    [value]="option.id || ''">
                                                    {{ option.label }}
                                                </option>
                                            </mb-select>
                                        </mb-form-field>
                                    </div>

                                    <div mbModalFooter class="ou-move__footer">
                                        <mb-button variant="secondary" (click)="requestCloseChangeParentOrgUnit()"
                                            [disabled]="orgUnitMoveSubmitting()">Cancel</mb-button>
                                        <mb-button variant="primary" [loading]="orgUnitMoveSubmitting()"
                                            (click)="saveChangeParentOrgUnit()">
                                            Save changes
                                        </mb-button>
                                    </div>
                                </mb-modal>

                                <mb-modal [open]="isOrgUnitDeactivateOpen()" title="Deactivate organizational unit" size="sm"
                                    [hasFooter]="true" [closeable]="!orgUnitDeactivateSubmitting()"
                                    [closeOnBackdrop]="!orgUnitDeactivateSubmitting()"
                                    (closed)="requestCloseDeactivateOrgUnit()">
                                    <div class="ou-deactivate">
                                        <div class="ou-deactivate__subtitle">
                                            Deactivating a unit hides it from assignments and scheduling.
                                        </div>
                                        <mb-alert *ngIf="orgUnitDeactivateError()" variant="danger">
                                            {{ orgUnitDeactivateError() }}
                                        </mb-alert>
                                        <div class="ou-deactivate__impact">
                                            <div class="ou-deactivate__row">
                                                <span>Unit</span>
                                                <span>{{ selectedOrgUnit()?.name }}</span>
                                            </div>
                                            <div class="ou-deactivate__row">
                                                <span>Status</span>
                                                <span>Active → Inactive</span>
                                            </div>
                                        </div>
                                    </div>

                                    <div mbModalFooter class="ou-deactivate__footer">
                                        <mb-button variant="secondary" (click)="requestCloseDeactivateOrgUnit()"
                                            [disabled]="orgUnitDeactivateSubmitting()">Cancel</mb-button>
                                        <mb-button variant="danger" [loading]="orgUnitDeactivateSubmitting()"
                                            (click)="deactivateSelectedOrgUnit()">
                                            Deactivate unit
                                        </mb-button>
                                    </div>
                                </mb-modal>
                            </div>

                            <div class="setup-footer">
                                <div class="setup-footer__actions">
                                    <mb-button variant="secondary" (click)="back()">Back</mb-button>
                                    <mb-button variant="primary" (click)="next()">Continue</mb-button>
                                </div>
                                <div class="setup-footer__aside">
                                    <button type="button" class="setup-skip-link" (click)="skipSetup()">Skip for
                                        now</button>
                                </div>
                            </div>
                            <div class="setup-auto-save"><span aria-hidden="true">✓</span> Configuration changes are
                                saved automatically.</div>
                        </div>

                        <div class="setup-body" *ngIf="step() === 4">
                            <div class="setup-section">
                                <h2>Academic levels</h2>
                                <p>Choose a template, then adjust the list to match your structure.</p>

                                <div class="choice-grid">
                                    <button type="button" class="choice-card"
                                        [class.active]="levelsTemplate() === 'k12'" (click)="setLevelsTemplate('k12')">
                                        <div class="choice-title">K–12</div>
                                        <div class="choice-text">Kindergarten through Grade 12.</div>
                                    </button>
                                    <button type="button" class="choice-card"
                                        [class.active]="levelsTemplate() === 'primary_secondary'"
                                        (click)="setLevelsTemplate('primary_secondary')">
                                        <div class="choice-title">Primary / Secondary</div>
                                        <div class="choice-text">Split primary and secondary levels.</div>
                                    </button>
                                    <button type="button" class="choice-card"
                                        [class.active]="levelsTemplate() === 'custom'"
                                        (click)="setLevelsTemplate('custom')">
                                        <div class="choice-title">Custom</div>
                                        <div class="choice-text">Build your own list of levels.</div>
                                    </button>
                                </div>

                                <div class="list-stack">
                                    <div class="list-row" *ngFor="let level of levels(); let i = index">
                                        <mb-form-field label="Level" [controlId]="'level-' + i">
                                            <mb-input [id]="'level-' + i" [value]="level"
                                                (valueChange)="updateLevel(i, $event)"></mb-input>
                                        </mb-form-field>
                                        <button type="button" class="list-remove" *ngIf="levels().length > 1"
                                            (click)="removeLevel(i)">Remove</button>
                                    </div>
                                </div>

                                <div class="setup-error" *ngIf="levelsError()">{{ levelsError() }}</div>

                                <button type="button" class="list-add" (click)="addLevel()">Add level</button>
                            </div>

                            <div class="setup-footer">
                                <div class="setup-footer__actions">
                                    <mb-button variant="secondary" (click)="back()">Back</mb-button>
                                    <mb-button variant="primary" [disabled]="!canContinue()"
                                        (click)="next()">Continue</mb-button>
                                </div>
                                <div class="setup-footer__aside">
                                    <button type="button" class="setup-skip-link" (click)="skipSetup()">Skip for
                                        now</button>
                                </div>
                            </div>
                            <div class="setup-auto-save"><span aria-hidden="true">✓</span> Configuration changes are
                                saved automatically.</div>
                        </div>

                        <div class="setup-body" *ngIf="step() === 5">
                            <div class="setup-section">
                                <div class="classes-header">
                                    <div>
                                        <h2>Classes & sections</h2>
                                        <p>Set up the classes/grades and sections your institution uses for enrollment,
                                            attendance, and reporting.</p>
                                        <div class="classes-filter" *ngIf="hasMultipleSchools()">
                                            <span class="classes-filter__label">School:</span>
                                            <mb-select class="classes-filter__select" id="class-school-filter"
                                                [value]="classSchoolFilter()"
                                                (valueChange)="classSchoolFilter.set($event)">
                                                <option value="all">All schools</option>
                                                <option *ngFor="let school of activeSchoolNames()" [value]="school">
                                                    {{ school }}
                                                </option>
                                            </mb-select>
                                        </div>
                                    </div>
                                    <div class="classes-header__actions">
                                        <mb-button variant="primary" (click)="openAddClass()">Add class</mb-button>
                                    </div>
                                </div>

                                <div class="classes-shell">
                                    <div class="classes-split">
                                        <div class="classes-panel classes-panel--list">
                                        <div class="classes-panel__header">
                                            <div class="classes-panel__title">Classes</div>
                                            <mb-input [value]="classSearch()" (valueChange)="classSearch.set($event)"
                                                placeholder="Search classes..."></mb-input>
                                        </div>

                                        <div class="classes-list" *ngIf="filteredClassRows().length; else emptyClasses">
                                            <div class="class-row" role="button" tabindex="0"
                                                *ngFor="let row of filteredClassRows(); trackBy: trackClassRow"
                                                [class.is-active]="selectedClassId() === row.id"
                                                (click)="selectClass(row)"
                                                (keydown.enter)="selectClass(row)"
                                                (keydown.space)="selectClass(row); $event.preventDefault()">
                                                <div class="class-row__content">
                                                    <div class="class-row__name">{{ row.name }}</div>
                                                    <div class="class-row__code" *ngIf="row.code || row.levelType">
                                                        {{ row.code || row.levelType }}
                                                    </div>
                                                </div>
                                                <div class="class-row__badge">
                                                    {{ classSectionCountMap().get(row.id) || 0 }}
                                                </div>
                                                <div class="class-row__actions">
                                                    <button type="button" class="class-row__action"
                                                        (click)="openEditClass(row); $event.stopPropagation()"
                                                        aria-label="Edit class">
                                                        ✎
                                                    </button>
                                                    <button type="button" class="class-row__action"
                                                        #classMenuOrigin aria-label="More actions"
                                                        [attr.aria-expanded]="classMenuOpenId() === row.id"
                                                        (click)="toggleClassMenu(row.id, $event)">⋯</button>
                                                    <mb-popover
                                                        [open]="classMenuOpenId() === row.id"
                                                        [origin]="classMenuOrigin"
                                                        [hasBackdrop]="true"
                                                        [panelClass]="['mb-popover-panel', 'mb-popover-panel--above-modal', 'class-row__menu-panel']"
                                                        (closed)="closeClassMenu()"
                                                    >
                                                        <div class="class-row__menu-content" role="menu">
                                                            <button type="button" class="class-row__menu-item"
                                                                (click)="openViewClass(row); closeClassMenu()">
                                                                View details
                                                            </button>
                                                            <button type="button" class="class-row__menu-item"
                                                                (click)="openEditClass(row); closeClassMenu()">
                                                                Edit class
                                                            </button>
                                                            <button type="button" class="class-row__menu-item"
                                                                (click)="duplicateClass(row); closeClassMenu()">
                                                                Duplicate class
                                                            </button>
                                                            <button type="button" class="class-row__menu-item"
                                                                (click)="openClassReorder(); closeClassMenu()">
                                                                Reorder classes
                                                            </button>
                                                            <button type="button" class="class-row__menu-item"
                                                                (click)="toggleClassActive(row); closeClassMenu()">
                                                                {{ row.active ? 'Deactivate class' : 'Activate class' }}
                                                            </button>
                                                            <div class="class-row__menu-divider"></div>
                                                            <button type="button"
                                                                class="class-row__menu-item class-row__menu-item--danger"
                                                                (click)="openClassDelete(row); closeClassMenu()">
                                                                Delete class
                                                            </button>
                                                        </div>
                                                    </mb-popover>
                                                </div>
                                            </div>
                                        </div>
                                        <ng-template #emptyClasses>
                                            <div class="classes-empty">
                                                <div class="classes-empty__title">No classes yet</div>
                                                <div class="classes-empty__text">
                                                    Classes describe grade levels. Sections are groups within a class.
                                                </div>
                                                <mb-button variant="primary" (click)="openAddClass()">Add class</mb-button>
                                            </div>
                                        </ng-template>
                                        </div>

                                        <div class="classes-panel classes-panel--detail">
                                        <ng-container *ngIf="selectedClass() as selected; else emptySectionState">
                                            <div class="sections-header">
                                                <div>
                                                    <div class="sections-header__title">{{ selected.name }}</div>
                                                    <div class="sections-header__meta">
                                                        {{ selected.levelType || 'Grade' }} ·
                                                        {{ selected.active ? 'Active' : 'Inactive' }} ·
                                                        {{ sectionCountForSelectedClass() }} sections
                                                    </div>
                                                </div>
                                                <div class="sections-header__actions">
                                                    <mb-button variant="secondary" (click)="openAddSection(selected)">Add
                                                        section</mb-button>
                                                    <button type="button" class="sections-menu__toggle"
                                                        #sectionsMenuOrigin aria-label="More actions"
                                                        title="More actions"
                                                        [attr.aria-expanded]="sectionsMenuOpen()"
                                                        (click)="toggleSectionsMenu($event)">⋯</button>
                                                    <mb-popover
                                                        [open]="sectionsMenuOpen()"
                                                        [origin]="sectionsMenuOrigin"
                                                        [hasBackdrop]="true"
                                                        [panelClass]="['mb-popover-panel', 'mb-popover-panel--above-modal', 'sections-menu__panel']"
                                                        (closed)="closeSectionsMenu()"
                                                    >
                                                        <div class="sections-menu__panel-content" role="menu">
                                                            <button type="button" class="sections-menu__item"
                                                                (click)="openImportModal('classes'); closeSectionsMenu()">
                                                                Import CSV
                                                            </button>
                                                            <button type="button" class="sections-menu__item"
                                                                (click)="downloadImportTemplate('classes'); closeSectionsMenu()">
                                                                Download template
                                                            </button>
                                                            <button type="button" class="sections-menu__item"
                                                                (click)="exportCsv('classes'); closeSectionsMenu()">
                                                                Export CSV
                                                            </button>
                                                            <div class="sections-menu__divider"></div>
                                                            <button type="button" class="sections-menu__item"
                                                                (click)="openSectionGenerator(); closeSectionsMenu()">
                                                                Create multiple sections
                                                            </button>
                                                            <button type="button" class="sections-menu__item"
                                                                (click)="openSectionReorder(); closeSectionsMenu()">
                                                                Reorder sections
                                                            </button>
                                                            <button type="button" class="sections-menu__item"
                                                                (click)="openEditClass(selected); closeSectionsMenu()">
                                                                Edit class
                                                            </button>
                                                            <button type="button" class="sections-menu__item"
                                                                (click)="toggleClassActive(selected); closeSectionsMenu()">
                                                                {{ selected.active ? 'Deactivate class' : 'Activate class' }}
                                                            </button>
                                                            <div class="sections-menu__divider"></div>
                                                            <button type="button"
                                                                class="sections-menu__item sections-menu__item--danger"
                                                                (click)="openClassDelete(selected); closeSectionsMenu()">
                                                                Delete class
                                                            </button>
                                                        </div>
                                                    </mb-popover>
                                                </div>
                                            </div>

                                            <div class="sections-table" *ngIf="filteredSections().length; else emptySections">
                                                <div class="sections-table__header">
                                                    <div>Section</div>
                                                    <div class="sections-table__capacity">Capacity</div>
                                                    <div>Homeroom teacher</div>
                                                    <div>Status</div>
                                                    <div class="sections-table__actions">Actions</div>
                                                </div>
                                                <div class="sections-table__row"
                                                    *ngFor="let section of filteredSections(); trackBy: trackSectionRow">
                                                    <div class="sections-table__name">
                                                        <div class="sections-table__name-text">{{ section.name }}</div>
                                                        <div class="sections-table__code" *ngIf="section.code">
                                                            {{ section.code }}
                                                        </div>
                                                    </div>
                                                    <div class="sections-table__capacity">
                                                        {{ section.capacity ?? '—' }}
                                                    </div>
                                                    <div class="sections-table__teacher">
                                                        {{ teacherLabel(section.homeroomTeacherId) }}
                                                    </div>
                                                    <div>
                                                        <span class="ou-status-pill"
                                                            [class.ou-status-pill--active]="section.active">
                                                            {{ section.active ? 'Active' : 'Inactive' }}
                                                        </span>
                                                    </div>
                                                    <div class="sections-table__actions">
                                                        <button type="button" class="sections-row-menu__toggle"
                                                            #sectionMenuOrigin aria-label="Row actions"
                                                            [attr.aria-expanded]="sectionMenuOpenId() === section.id"
                                                            (click)="toggleSectionMenu(section.id, $event)">⋯</button>
                                                        <mb-popover
                                                            [open]="sectionMenuOpenId() === section.id"
                                                            [origin]="sectionMenuOrigin"
                                                            [hasBackdrop]="true"
                                                            [panelClass]="['mb-popover-panel', 'mb-popover-panel--above-modal', 'sections-row-menu__panel']"
                                                            (closed)="closeSectionMenu()"
                                                        >
                                                            <div class="sections-row-menu__panel-content" role="menu">
                                                                <button type="button" class="sections-row-menu__item"
                                                                    (click)="openViewSection(section); closeSectionMenu()">
                                                                    View
                                                                </button>
                                                                <button type="button" class="sections-row-menu__item"
                                                                    (click)="openEditSection(section); closeSectionMenu()">
                                                                    Edit
                                                                </button>
                                                                <button type="button" class="sections-row-menu__item"
                                                                    (click)="openEditSection(section); closeSectionMenu()">
                                                                    Assign homeroom teacher
                                                                </button>
                                                                <button type="button" class="sections-row-menu__item"
                                                                    (click)="toggleSectionActive(section); closeSectionMenu()">
                                                                    {{ section.active ? 'Deactivate' : 'Activate' }}
                                                                </button>
                                                                <div class="sections-row-menu__divider"></div>
                                                                <button type="button"
                                                                    class="sections-row-menu__item sections-row-menu__item--danger"
                                                                    (click)="openSectionDelete(section); closeSectionMenu()">
                                                                    Delete section
                                                                </button>
                                                            </div>
                                                        </mb-popover>
                                                    </div>
                                                </div>
                                            </div>
                                            <ng-template #emptySections>
                                                <div class="sections-empty">
                                                    <div class="sections-empty__title">No sections yet</div>
                                                    <div class="sections-empty__text">
                                                        Add at least one section so you can enroll students and take
                                                        attendance.
                                                    </div>
                                                </div>
                                            </ng-template>
                                        </ng-container>
                                        <ng-template #emptySectionState>
                                            <div class="sections-empty sections-empty--detail">
                                                <div class="sections-empty__title">Select a class</div>
                                                <div class="sections-empty__text">
                                                    Choose a class to manage its sections.
                                                </div>
                                            </div>
                                        </ng-template>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <div class="setup-footer">
                                <div class="setup-footer__actions">
                                    <mb-button variant="secondary" (click)="back()">Back</mb-button>
                                    <mb-button variant="primary" [disabled]="!canContinue()"
                                        (click)="next()">Continue</mb-button>
                                </div>
                                <div class="setup-footer__aside">
                                    <button type="button" class="setup-skip-link" (click)="skipSetup()">Skip for
                                        now</button>
                                </div>
                            </div>
                            <div class="setup-auto-save"><span aria-hidden="true">✓</span> Configuration changes are
                                saved automatically.</div>

                            <mb-modal [open]="classFormOpen()" [title]="classFormMode() === 'add' ? 'Add class' : (classFormMode() === 'edit' ? 'Edit class' : 'Class details')"
                                size="md" [hasFooter]="true" (closed)="requestCloseClassForm()">
                                <div class="class-modal">
                                    <div class="class-modal__subtitle">
                                        {{ classFormMode() === 'add' ? 'Create a class/grade level. You can add sections next.' : 'Update class details.' }}
                                    </div>
                                    <mb-alert *ngIf="classFormError()" variant="danger">{{ classFormError() }}</mb-alert>
                                    <mb-form-field label="Class name" [controlId]="'class-name'">
                                        <mb-input id="class-name" [value]="classFormName()"
                                            [disabled]="classFormMode() === 'view'"
                                            cdkFocusInitial
                                            (valueChange)="classFormName.set($event)"></mb-input>
                                    </mb-form-field>
                                    <mb-form-field label="Code" [controlId]="'class-code'"
                                        hint="Short identifier used in reports and integrations.">
                                        <mb-input id="class-code" [value]="classFormCode()"
                                            [disabled]="classFormMode() === 'view'"
                                            (valueChange)="classFormCode.set($event)"></mb-input>
                                    </mb-form-field>
                                    <mb-form-field label="Level" [controlId]="'class-level'"
                                        hint="Used for grouping and analytics.">
                                        <mb-select id="class-level" [value]="classFormLevel()"
                                            [disabled]="classFormMode() === 'view'"
                                            (valueChange)="classFormLevel.set($any($event))">
                                            <option value="">Select level</option>
                                            <option value="Early Years">Early Years</option>
                                            <option value="Primary">Primary</option>
                                            <option value="JHS">JHS</option>
                                            <option value="SHS">SHS</option>
                                            <option value="College">College</option>
                                            <option value="Other">Other</option>
                                        </mb-select>
                                    </mb-form-field>
                                    <mb-form-field *ngIf="hasMultipleSchools()" label="School scope"
                                        [controlId]="'class-scope'">
                                        <div class="class-modal__scope">
                                            <label class="class-modal__radio">
                                                <input type="radio" name="class-scope" value="all"
                                                    [disabled]="classFormMode() === 'view'"
                                                    [checked]="classFormSchoolScope() === 'all'"
                                                    (change)="classFormSchoolScope.set('all')" />
                                                <span>All schools</span>
                                            </label>
                                            <label class="class-modal__radio">
                                                <input type="radio" name="class-scope" value="specific"
                                                    [disabled]="classFormMode() === 'view'"
                                                    [checked]="classFormSchoolScope() === 'specific'"
                                                    (change)="classFormSchoolScope.set('specific')" />
                                                <span>Specific schools</span>
                                            </label>
                                        </div>
                                        <div class="class-modal__schools"
                                            *ngIf="classFormSchoolScope() === 'specific'">
                                            <mb-checkbox *ngFor="let school of activeSchoolNames()"
                                                [checked]="classFormSchoolIds().includes(school)"
                                                [disabled]="classFormMode() === 'view'"
                                                (checkedChange)="toggleClassSchoolSelection(school, $event)">
                                                {{ school }}
                                            </mb-checkbox>
                                        </div>
                                    </mb-form-field>
                                    <mb-form-field label="Notes" [controlId]="'class-notes'">
                                        <mb-textarea id="class-notes" [value]="classFormNotes()"
                                            [disabled]="classFormMode() === 'view'"
                                            (valueChange)="classFormNotes.set($event)"></mb-textarea>
                                    </mb-form-field>
                                    <label class="class-modal__toggle">
                                        <input type="checkbox" [checked]="classFormActive()"
                                            [disabled]="classFormMode() === 'view'"
                                            (change)="classFormActive.set($any($event.target).checked)" />
                                        <span>Active</span>
                                    </label>
                                </div>
                                <div mbModalFooter class="class-modal__footer">
                                    <mb-button variant="secondary" (click)="requestCloseClassForm()">Cancel</mb-button>
                                    <mb-button variant="primary" *ngIf="classFormMode() !== 'view'"
                                        [loading]="classFormSubmitting()"
                                        [disabled]="classFormSubmitting()"
                                        (click)="saveClassForm()">Save class</mb-button>
                                </div>
                            </mb-modal>

                            <mb-modal [open]="sectionFormOpen()" [title]="sectionFormMode() === 'add' ? 'Add section' : (sectionFormMode() === 'edit' ? 'Edit section' : 'Section details')"
                                size="md" [hasFooter]="true" (closed)="requestCloseSectionForm()">
                                <div class="section-modal">
                                    <div class="section-modal__subtitle">
                                        {{ sectionFormMode() === 'add' ? 'Create a section under the selected class.' : 'Update section details.' }}
                                    </div>
                                    <mb-alert *ngIf="sectionFormError()" variant="danger">{{ sectionFormError() }}</mb-alert>
                                    <mb-form-field label="Class" [controlId]="'section-class'">
                                        <mb-class-selector
                                            [value]="sectionFormClassId()"
                                            [options]="classSelectorOptions()"
                                            [disabled]="sectionFormMode() === 'view'"
                                            (valueChange)="sectionFormClassId.set($event)">
                                        </mb-class-selector>
                                    </mb-form-field>
                                    <mb-form-field label="Section name" [controlId]="'section-name'">
                                        <mb-input id="section-name" [value]="sectionFormName()"
                                            [disabled]="sectionFormMode() === 'view'"
                                            cdkFocusInitial
                                            (valueChange)="sectionFormName.set($event)"></mb-input>
                                    </mb-form-field>
                                    <mb-form-field label="Section code" [controlId]="'section-code'">
                                        <mb-input id="section-code" [value]="sectionFormCode()"
                                            [disabled]="sectionFormMode() === 'view'"
                                            (valueChange)="sectionFormCode.set($event)"></mb-input>
                                    </mb-form-field>
                                    <mb-form-field label="Capacity" [controlId]="'section-capacity'">
                                        <mb-input id="section-capacity" [value]="sectionFormCapacity()"
                                            [disabled]="sectionFormMode() === 'view'"
                                            (valueChange)="sectionFormCapacity.set($event)"
                                            placeholder="Optional"></mb-input>
                                    </mb-form-field>
                                    <mb-form-field label="Homeroom teacher" [controlId]="'section-teacher'">
                                        <mb-staff-selector
                                            [value]="sectionFormTeacherId()"
                                            [options]="staffSelectorOptions()"
                                            [disabled]="sectionFormMode() === 'view'"
                                            placeholder="Unassigned"
                                            (valueChange)="sectionFormTeacherId.set($event)">
                                        </mb-staff-selector>
                                    </mb-form-field>
                                    <label class="section-modal__toggle">
                                        <input type="checkbox" [checked]="sectionFormActive()"
                                            [disabled]="sectionFormMode() === 'view'"
                                            (change)="sectionFormActive.set($any($event.target).checked)" />
                                        <span>Active</span>
                                    </label>
                                </div>
                                <div mbModalFooter class="section-modal__footer">
                                    <mb-button variant="secondary" (click)="requestCloseSectionForm()">Cancel</mb-button>
                                    <mb-button variant="primary" *ngIf="sectionFormMode() !== 'view'"
                                        (click)="saveSectionForm()">Save section</mb-button>
                                </div>
                            </mb-modal>

                            <mb-modal [open]="classDeleteOpen()" title="Delete class" size="sm" [hasFooter]="true"
                                (closed)="requestCloseClassDelete()">
                                <div class="class-delete">
                                    <div class="class-delete__subtitle">
                                        Deleting a class deletes its sections.
                                    </div>
                                    <mb-alert *ngIf="classDeleteError()" variant="danger">{{ classDeleteError() }}</mb-alert>
                                    <div class="class-delete__impact">
                                        <div>
                                            <div class="class-delete__label">Class</div>
                                            <div class="class-delete__value">{{ classDeleteTarget()?.name }}</div>
                                        </div>
                                        <div>
                                            <div class="class-delete__label">Sections</div>
                                            <div class="class-delete__value">
                                                {{ classSectionCountMap().get(classDeleteTarget()?.id || '') || 0 }}
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                <div mbModalFooter class="class-delete__footer">
                                    <mb-button variant="secondary" (click)="requestCloseClassDelete()">Cancel</mb-button>
                                    <mb-button variant="danger" (click)="deleteClass()">Delete class</mb-button>
                                </div>
                            </mb-modal>

                            <mb-modal [open]="sectionDeleteOpen()" title="Delete section" size="sm" [hasFooter]="true"
                                (closed)="requestCloseSectionDelete()">
                                <div class="section-delete">
                                    <div class="section-delete__subtitle">
                                        This action cannot be undone.
                                    </div>
                                    <mb-alert *ngIf="sectionDeleteError()" variant="danger">{{ sectionDeleteError() }}</mb-alert>
                                    <div class="section-delete__impact">
                                        <div class="section-delete__label">Section</div>
                                        <div class="section-delete__value">{{ sectionDeleteTarget()?.name }}</div>
                                    </div>
                                </div>
                                <div mbModalFooter class="section-delete__footer">
                                    <mb-button variant="secondary" (click)="requestCloseSectionDelete()">Cancel</mb-button>
                                    <mb-button variant="danger" (click)="deleteSection()">Delete section</mb-button>
                                </div>
                            </mb-modal>

                            <mb-modal [open]="sectionGeneratorOpen()" title="Create multiple sections" size="md"
                                [hasFooter]="true" (closed)="requestCloseSectionGenerator()">
                                <div class="section-generator">
                                    <div class="section-generator__subtitle">
                                        Generate sections quickly using a pattern.
                                    </div>
                                    <mb-alert *ngIf="sectionGeneratorError()" variant="danger">
                                        {{ sectionGeneratorError() }}
                                    </mb-alert>
                                    <mb-form-field label="Pattern" [controlId]="'section-pattern'">
                                        <mb-select id="section-pattern" [value]="sectionGeneratorPattern()"
                                            (valueChange)="sectionGeneratorPattern.set($any($event))">
                                            <option value="letters">Letters (A-F)</option>
                                            <option value="numbers">Numbers (1-10)</option>
                                            <option value="custom">Custom list</option>
                                        </mb-select>
                                    </mb-form-field>
                                    <mb-form-field *ngIf="sectionGeneratorPattern() !== 'custom'"
                                        label="Range" [controlId]="'section-range'">
                                        <mb-input id="section-range" [value]="sectionGeneratorRange()"
                                            (valueChange)="sectionGeneratorRange.set($event)"
                                            placeholder="A-F or 1-10"></mb-input>
                                    </mb-form-field>
                                    <mb-form-field *ngIf="sectionGeneratorPattern() === 'custom'"
                                        label="Custom list" [controlId]="'section-custom'">
                                        <mb-textarea id="section-custom" [value]="sectionGeneratorCustom()"
                                            (valueChange)="sectionGeneratorCustom.set($event)"
                                            placeholder="A, B, C"></mb-textarea>
                                    </mb-form-field>
                                    <mb-form-field label="Capacity (optional)" [controlId]="'section-capacity-all'">
                                        <mb-input id="section-capacity-all" [value]="sectionGeneratorCapacity()"
                                            (valueChange)="sectionGeneratorCapacity.set($event)"
                                            placeholder="Apply to all"></mb-input>
                                    </mb-form-field>
                                    <div class="section-generator__preview">
                                        <div class="section-generator__label">Preview</div>
                                        <div class="section-generator__list">
                                            <span class="section-generator__pill"
                                                *ngFor="let item of generateSectionsPreview()">{{ item }}</span>
                                        </div>
                                    </div>
                                </div>
                                <div mbModalFooter class="section-generator__footer">
                                    <mb-button variant="secondary"
                                        (click)="requestCloseSectionGenerator()">Cancel</mb-button>
                                    <mb-button variant="primary" (click)="createGeneratedSections()">Create sections</mb-button>
                                </div>
                            </mb-modal>

                            <mb-modal [open]="classReorderOpen()" title="Reorder classes" size="sm" [hasFooter]="true"
                                (closed)="requestCloseClassReorder()">
                                <div class="reorder-modal">
                                    <div class="reorder-modal__list" cdkDropList
                                        (cdkDropListDropped)="handleClassReorderDrop($event)">
                                        <div class="reorder-modal__row" *ngFor="let row of classReorderDraft()"
                                            cdkDrag>
                                            <span class="reorder-modal__handle" cdkDragHandle>⋮⋮</span>
                                            <span>{{ row.name }}</span>
                                        </div>
                                    </div>
                                </div>
                                <div mbModalFooter class="reorder-modal__footer">
                                    <mb-button variant="secondary" (click)="requestCloseClassReorder()">Cancel</mb-button>
                                    <mb-button variant="primary" (click)="saveClassReorder()">Save order</mb-button>
                                </div>
                            </mb-modal>

                            <mb-modal [open]="sectionReorderOpen()" title="Reorder sections" size="sm" [hasFooter]="true"
                                (closed)="requestCloseSectionReorder()">
                                <div class="reorder-modal">
                                    <div class="reorder-modal__list" cdkDropList
                                        (cdkDropListDropped)="handleSectionReorderDrop($event)">
                                        <div class="reorder-modal__row" *ngFor="let row of sectionReorderDraft()"
                                            cdkDrag>
                                            <span class="reorder-modal__handle" cdkDragHandle>⋮⋮</span>
                                            <span>{{ row.name }}</span>
                                        </div>
                                    </div>
                                </div>
                                <div mbModalFooter class="reorder-modal__footer">
                                    <mb-button variant="secondary" (click)="requestCloseSectionReorder()">Cancel</mb-button>
                                    <mb-button variant="primary" (click)="saveSectionReorder()">Save order</mb-button>
                                </div>
                            </mb-modal>

                            <mb-modal [open]="classImportOpen()" title="Import CSV" size="md" [hasFooter]="true"
                                (closed)="requestCloseImportModal()">
                                <div class="import-modal">
                                    <div class="import-modal__subtitle">
                                        Upload a CSV file to import {{ classImportType() }}.
                                    </div>
                                    <input type="file" accept=".csv" class="import-modal__file"
                                        (change)="handleImportFile($event)" />
                                    <div class="import-modal__file-name" *ngIf="classImportFileName()">
                                        {{ classImportFileName() }}
                                    </div>
                                    <div class="import-modal__errors" *ngIf="classImportErrors().length">
                                        <div *ngFor="let error of classImportErrors()">{{ error }}</div>
                                    </div>
                                    <div class="import-modal__preview" *ngIf="classImportRows().length">
                                        <div class="import-modal__preview-title">Preview rows</div>
                                        <div class="import-modal__preview-table">
                                            <div class="import-modal__preview-row"
                                                *ngFor="let row of classImportRows() | slice:0:5">
                                                <span *ngFor="let key of objectKeys(row)">
                                                    {{ row[key] }}
                                                </span>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                <div mbModalFooter class="import-modal__footer">
                                    <mb-button variant="secondary" (click)="requestCloseImportModal()">Cancel</mb-button>
                                    <mb-button variant="primary" [disabled]="!classImportRows().length"
                                        (click)="confirmImport()">Import</mb-button>
                                </div>
                            </mb-modal>
                        </div>

                        <div class="setup-body" *ngIf="step() === 6">
                            <div class="setup-section">
                                <div class="grading-header">
                                    <div>
                                        <h2>Grading system</h2>
                                        <p>Define how grades are recorded and calculated across your institution.</p>
                                        <div class="grading-filter" *ngIf="hasMultipleSchools()">
                                            <span class="grading-filter__label">School:</span>
                                            <mb-select class="grading-filter__select" id="grading-school-filter"
                                                [value]="gradingSchoolFilter()"
                                                (valueChange)="gradingSchoolFilter.set($event)">
                                                <option value="all">All schools</option>
                                                <option *ngFor="let school of activeSchoolNames()" [value]="school">
                                                    {{ school }}
                                                </option>
                                            </mb-select>
                                        </div>
                                    </div>
                                    <div class="grading-header__actions">
                                        <mb-button variant="primary" (click)="openNewGradingScale()">Add grading
                                            scale</mb-button>
                                        <button type="button" class="grading-menu__toggle" #gradingHeaderMenuOrigin
                                            aria-label="More actions"
                                            [attr.aria-expanded]="gradingHeaderMenuOpen()"
                                            (click)="toggleGradingHeaderMenu()">⋯</button>
                                        <mb-popover [open]="gradingHeaderMenuOpen()"
                                            [origin]="gradingHeaderMenuOrigin" [hasBackdrop]="true"
                                            [panelClass]="['mb-popover-panel', 'mb-popover-panel--above-modal', 'grading-menu__panel']"
                                            (closed)="closeGradingHeaderMenu()">
                                            <div class="grading-menu__panel-content">
                                                <button type="button" class="grading-menu__item"
                                                    (click)="importGradingTemplate(); closeGradingHeaderMenu()">
                                                    Import template
                                                </button>
                                                <button type="button" class="grading-menu__item"
                                                    (click)="resetGradingDefaults(); closeGradingHeaderMenu()">
                                                    Reset to defaults
                                                </button>
                                            </div>
                                        </mb-popover>
                                    </div>
                                </div>

                                <div class="grading-card">
                                    <div class="grading-layout">
                                        <div class="grading-panel grading-panel--list">
                                            <div class="grading-panel__header">
                                                <div class="grading-panel__title">Scales</div>
                                                <button type="button" class="grading-panel__link"
                                                    (click)="openNewGradingScale()">+ New scale</button>
                                            </div>
                                            <div class="grading-scale-list"
                                                *ngIf="gradingScaleList().length; else gradingScaleEmpty">
                                                <button type="button" class="grading-scale"
                                                    *ngFor="let scale of gradingScaleList()"
                                                    [class.is-active]="gradingSelectedScaleId() === scale.id"
                                                    (click)="selectGradingScale(scale)">
                                                    <div class="grading-scale__content">
                                                        <div class="grading-scale__name">{{ scale.name }}</div>
                                                        <div class="grading-scale__meta">
                                                            <span class="grading-scale__badge">{{ scale.type }}</span>
                                                            <span class="grading-scale__status"
                                                                [class.is-active]="scale.status === 'Active'"
                                                                [class.is-draft]="scale.status === 'Draft'"
                                                                [class.is-archived]="scale.status === 'Archived'">
                                                                {{ scale.status }}
                                                            </span>
                                                            <span class="grading-scale__usage">
                                                                {{ scale.schoolIds?.length ? (scale.schoolIds?.length + ' schools') : 'All schools' }}
                                                            </span>
                                                        </div>
                                                    </div>
                                                </button>
                                            </div>
                                            <ng-template #gradingScaleEmpty>
                                                <div class="grading-empty">
                                                    <div class="grading-empty__title">No grading scales yet</div>
                                                    <div class="grading-empty__text">Create a scale to define how grades
                                                        are calculated.</div>
                                                    <mb-button variant="secondary" (click)="openNewGradingScale()">Add
                                                        grading scale</mb-button>
                                                </div>
                                            </ng-template>
                                        </div>

                                        <div class="grading-panel grading-panel--detail">
                                            <ng-container *ngIf="selectedGradingScale() as scale; else emptyGradingDetail">
                                                <div class="grading-detail__header">
                                                    <div>
                                                        <div class="grading-detail__title">{{ scale.name }}</div>
                                                        <div class="grading-detail__meta">
                                                            {{ scale.type }} · {{ scale.status }} · Used by:
                                                            {{ gradingScaleUsageLabel() }}
                                                        </div>
                                                    </div>
                                                    <div class="grading-detail__actions">
                                                        <mb-button variant="secondary"
                                                            (click)="openEditGradingScale(scale)">Edit</mb-button>
                                                        <button type="button" class="grading-menu__toggle"
                                                            #gradingScaleMenuOrigin aria-label="More actions"
                                                            [attr.aria-expanded]="gradingScaleMenuOpen()"
                                                            (click)="toggleGradingScaleMenu()">⋯</button>
                                                        <mb-popover [open]="gradingScaleMenuOpen()"
                                                            [origin]="gradingScaleMenuOrigin" [hasBackdrop]="true"
                                                            [panelClass]="['mb-popover-panel', 'mb-popover-panel--above-modal', 'grading-menu__panel']"
                                                            (closed)="closeGradingScaleMenu()">
                                                            <div class="grading-menu__panel-content">
                                                                <button type="button" class="grading-menu__item"
                                                                    (click)="duplicateGradingScale()">Duplicate</button>
                                                                <button type="button" class="grading-menu__item"
                                                                    (click)="archiveGradingScale()">
                                                                    {{ scale.status === 'Archived' ? 'Restore' : 'Archive' }}
                                                                </button>
                                                            </div>
                                                        </mb-popover>
                                                    </div>
                                                </div>

                                                <div class="grading-tabs">
                                                    <button type="button" class="grading-tab"
                                                        [class.is-active]="gradingActiveTab() === 'bands'"
                                                        (click)="gradingActiveTab.set('bands')">Grade bands</button>
                                                    <button type="button" class="grading-tab"
                                                        [class.is-active]="gradingActiveTab() === 'settings'"
                                                        (click)="gradingActiveTab.set('settings')">Settings</button>
                                                </div>

                                                <div *ngIf="gradingActiveTab() === 'bands'" class="grading-bands">
                                                    <div class="grading-bands__actions">
                                                        <mb-button variant="secondary" (click)="openAddGradeBand()">+ Add
                                                            grade band</mb-button>
                                                    </div>
                                                    <div class="grading-bands__table"
                                                        *ngIf="selectedGradingBands().length; else gradingBandsEmpty">
                                                        <div class="grading-bands__header">
                                                            <div>Grade</div>
                                                            <div>Range</div>
                                                            <div>GPA</div>
                                                            <div>Status</div>
                                                            <div class="grading-bands__actions-cell">Actions</div>
                                                        </div>
                                                        <div class="grading-bands__row"
                                                            *ngFor="let band of selectedGradingBands()">
                                                            <div class="grading-bands__label">{{ band.label }}</div>
                                                            <div>{{ band.min }} – {{ band.max }}</div>
                                                            <div>{{ band.gpa ?? '—' }}</div>
                                                            <div>
                                                                <span class="grading-bands__badge"
                                                                    [class.is-pass]="band.pass"
                                                                    [class.is-fail]="!band.pass">
                                                                    {{ band.pass ? 'Pass' : 'Fail' }}
                                                                </span>
                                                            </div>
                                                            <div class="grading-bands__actions-cell">
                                                                <button type="button"
                                                                    class="grading-bands__menu-toggle"
                                                                    #gradingBandMenuOrigin aria-label="Row actions"
                                                                    [attr.aria-expanded]="gradingBandMenuOpenId() === band.id"
                                                                    (click)="toggleGradingBandMenu(band.id, $event)">⋯</button>
                                                                <mb-popover [open]="gradingBandMenuOpenId() === band.id"
                                                                    [origin]="gradingBandMenuOrigin"
                                                                    [hasBackdrop]="true"
                                                                    [panelClass]="['mb-popover-panel', 'mb-popover-panel--above-modal', 'grading-menu__panel']"
                                                                    (closed)="closeGradingBandMenu()">
                                                                    <div class="grading-menu__panel-content">
                                                                        <button type="button" class="grading-menu__item"
                                                                            (click)="openEditGradeBand(band); closeGradingBandMenu()">
                                                                            Edit
                                                                        </button>
                                                                        <button type="button" class="grading-menu__item"
                                                                            (click)="deleteGradeBand(band)">
                                                                            Delete
                                                                        </button>
                                                                    </div>
                                                                </mb-popover>
                                                            </div>
                                                        </div>
                                                    </div>
                                                    <ng-template #gradingBandsEmpty>
                                                        <div class="grading-empty grading-empty--detail">
                                                            <div class="grading-empty__title">No grade bands yet</div>
                                                            <div class="grading-empty__text">Add bands so scores map to
                                                                grades and pass/fail rules.</div>
                                                            <mb-button variant="secondary"
                                                                (click)="openAddGradeBand()">Add grade band</mb-button>
                                                        </div>
                                                    </ng-template>
                                                </div>

                                                <div *ngIf="gradingActiveTab() === 'settings'" class="grading-settings">
                                                    <div class="grading-settings__group">
                                                        <div class="grading-settings__title">Pass mark & ranges</div>
                                                        <div class="grading-settings__row">
                                                            <mb-form-field label="Pass mark threshold"
                                                                [controlId]="'grading-pass-mark'">
                                                            <mb-input id="grading-pass-mark"
                                                                    [value]="(scale.settings.passMark ?? '').toString()"
                                                                    placeholder="Optional"
                                                                    (valueChange)="setGradingPassMark($event)"></mb-input>
                                                            </mb-form-field>
                                                            <div class="grading-settings__toggles">
                                                                <mb-checkbox [checked]="scale.settings.allowDecimals"
                                                                    (checkedChange)="updateSelectedScaleSettings({ allowDecimals: $event })">
                                                                    Allow decimals
                                                                </mb-checkbox>
                                                                <mb-checkbox
                                                                    [checked]="scale.settings.preventOverlap"
                                                                    (checkedChange)="updateSelectedScaleSettings({ preventOverlap: $event })">
                                                                    Prevent overlapping ranges
                                                                </mb-checkbox>
                                                            </div>
                                                        </div>
                                                    </div>
                                                    <div class="grading-settings__divider"></div>
                                                    <div class="grading-settings__group">
                                                        <div class="grading-settings__title">Calculation method</div>
                                                        <div class="grading-settings__row">
                                                            <mb-form-field label="Method"
                                                                [controlId]="'grading-calculation'">
                                                                <mb-select id="grading-calculation"
                                                                    [value]="scale.settings.calculationMethod"
                                                                    (valueChange)="setGradingCalculationMethod($event)">
                                                                    <option value="Average">Average</option>
                                                                    <option value="Highest">Highest</option>
                                                                    <option value="Lowest">Lowest</option>
                                                                    <option value="Weighted">Weighted</option>
                                                                </mb-select>
                                                            </mb-form-field>
                                                            <mb-form-field label="Rounding"
                                                                [controlId]="'grading-rounding'">
                                                                <mb-select id="grading-rounding"
                                                                    [value]="scale.settings.rounding"
                                                                    (valueChange)="setGradingRounding($event)">
                                                                    <option value="Nearest">Nearest</option>
                                                                    <option value="Up">Round up</option>
                                                                    <option value="Down">Round down</option>
                                                                </mb-select>
                                                            </mb-form-field>
                                                        </div>
                                                    </div>
                                                    <div class="grading-settings__divider"></div>
                                                    <div class="grading-settings__group">
                                                        <div class="grading-settings__title">Transcript display</div>
                                                        <div class="grading-settings__row">
                                                            <div class="grading-settings__toggles">
                                                                <mb-checkbox [checked]="scale.settings.showGpa"
                                                                    (checkedChange)="updateSelectedScaleSettings({ showGpa: $event })">
                                                                    Show GPA
                                                                </mb-checkbox>
                                                                <mb-checkbox [checked]="scale.settings.showPercent"
                                                                    (checkedChange)="updateSelectedScaleSettings({ showPercent: $event })">
                                                                    Show percentage
                                                                </mb-checkbox>
                                                            </div>
                                                            <mb-form-field label="Format"
                                                                [controlId]="'grading-format'">
                                                                <mb-select id="grading-format"
                                                                    [value]="scale.settings.transcriptFormat"
                                                                    (valueChange)="setGradingTranscriptFormat($event)">
                                                                    <option value="Letter">Letter</option>
                                                                    <option value="Letter + Percent">Letter + Percent</option>
                                                                    <option value="Percent">Percent only</option>
                                                                </mb-select>
                                                            </mb-form-field>
                                                        </div>
                                                    </div>
                                                </div>
                                            </ng-container>
                                            <ng-template #emptyGradingDetail>
                                                <div class="grading-empty grading-empty--detail">
                                                    <div class="grading-empty__title">Select a grading scale</div>
                                                    <div class="grading-empty__text">Choose a scale to view grade bands
                                                        and settings.</div>
                                                </div>
                                            </ng-template>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <div class="setup-footer">
                                <div class="setup-footer__actions">
                                    <mb-button variant="secondary" (click)="back()">Back</mb-button>
                                    <mb-button variant="primary" (click)="next()">Continue</mb-button>
                                </div>
                                <div class="setup-footer__aside">
                                    <button type="button" class="setup-skip-link" (click)="skipSetup()">Skip for
                                        now</button>
                                </div>
                            </div>
                            <div class="setup-auto-save"><span aria-hidden="true">✓</span> Configuration changes are
                                saved automatically.</div>

                            <mb-modal [open]="gradingScaleFormOpen()"
                                [title]="gradingScaleFormMode() === 'add' ? 'New grading scale' : 'Edit grading scale'"
                                size="md"
                                [hasFooter]="true" (closed)="requestCloseGradingScaleForm()">
                                <div class="grading-modal">
                                    <div class="grading-modal__subtitle">Create a grading scale for reporting and
                                        calculations.</div>
                                    <mb-alert *ngIf="gradingScaleFormError()" variant="danger">
                                        {{ gradingScaleFormError() }}
                                    </mb-alert>
                                    <mb-form-field label="Scale name" [controlId]="'grading-scale-name'">
                                        <mb-input id="grading-scale-name" [value]="gradingScaleFormName()"
                                            (valueChange)="gradingScaleFormName.set($event)"></mb-input>
                                    </mb-form-field>
                                    <mb-form-field label="Template (optional)" [controlId]="'grading-scale-template'">
                                        <mb-select id="grading-scale-template"
                                            [value]="gradingScaleFormTemplate()"
                                            (valueChange)="selectGradingTemplate($event)">
                                            <option value="">None</option>
                                            <option *ngFor="let option of gradingTemplateOptions()" [value]="option.id">
                                                {{ option.label }}
                                            </option>
                                        </mb-select>
                                    </mb-form-field>
                                    <mb-form-field label="Type" [controlId]="'grading-scale-type'">
                                        <mb-select id="grading-scale-type" [value]="gradingScaleFormType()"
                                            (valueChange)="gradingScaleFormType.set($any($event))">
                                            <option value="Letter">Letter</option>
                                            <option value="Percent">Percent</option>
                                            <option value="GPA">GPA</option>
                                            <option value="Rubric">Rubric</option>
                                        </mb-select>
                                    </mb-form-field>
                                    <div class="grading-modal__radio">
                                        <div class="grading-modal__label">Applies to</div>
                                        <label class="grading-modal__option">
                                            <input type="radio" name="grading-scope" value="all"
                                                [checked]="gradingScaleFormSchoolScope() === 'all'"
                                                (change)="gradingScaleFormSchoolScope.set('all')" />
                                            <span>All schools</span>
                                        </label>
                                        <label class="grading-modal__option">
                                            <input type="radio" name="grading-scope" value="specific"
                                                [checked]="gradingScaleFormSchoolScope() === 'specific'"
                                                (change)="gradingScaleFormSchoolScope.set('specific')" />
                                            <span>Selected schools</span>
                                        </label>
                                        <div class="grading-modal__schools"
                                            *ngIf="gradingScaleFormSchoolScope() === 'specific'">
                                            <mb-checkbox *ngFor="let school of activeSchoolNames()"
                                                [checked]="gradingScaleFormSchoolIds().includes(school)"
                                                (checkedChange)="toggleGradingScaleSchool(school, $event)">
                                                {{ school }}
                                            </mb-checkbox>
                                        </div>
                                    </div>
                                    <mb-form-field label="Default pass mark" [controlId]="'grading-pass-mark-default'">
                                        <mb-input id="grading-pass-mark-default"
                                            [value]="gradingScaleFormPassMark()"
                                            placeholder="Optional"
                                            (valueChange)="gradingScaleFormPassMark.set($event)"></mb-input>
                                    </mb-form-field>
                                </div>
                                <div mbModalFooter class="grading-modal__footer">
                                    <mb-button variant="secondary"
                                        (click)="requestCloseGradingScaleForm()">Cancel</mb-button>
                                    <mb-button variant="primary" (click)="saveGradingScale()">
                                        {{ gradingScaleFormMode() === 'add' ? 'Create scale' : 'Save changes' }}
                                    </mb-button>
                                </div>
                            </mb-modal>

                            <mb-modal [open]="gradingBandFormOpen()"
                                [title]="gradingBandFormMode() === 'add' ? 'Add grade band' : 'Edit grade band'"
                                size="sm"
                                [hasFooter]="true" (closed)="requestCloseGradeBandForm()">
                                <div class="grading-modal">
                                    <div class="grading-modal__subtitle">Define the score range and status for this
                                        grade band.</div>
                                    <mb-alert *ngIf="gradingBandFormError()" variant="danger">
                                        {{ gradingBandFormError() }}
                                    </mb-alert>
                                    <mb-form-field label="Label" [controlId]="'grading-band-label'">
                                        <mb-input id="grading-band-label" [value]="gradingBandFormLabel()"
                                            (valueChange)="gradingBandFormLabel.set($event)"></mb-input>
                                    </mb-form-field>
                                    <div class="grading-modal__row">
                                        <mb-form-field label="Min score" [controlId]="'grading-band-min'">
                                            <mb-input id="grading-band-min" [value]="gradingBandFormMin()"
                                                (valueChange)="gradingBandFormMin.set($event)"></mb-input>
                                        </mb-form-field>
                                        <mb-form-field label="Max score" [controlId]="'grading-band-max'">
                                            <mb-input id="grading-band-max" [value]="gradingBandFormMax()"
                                                (valueChange)="gradingBandFormMax.set($event)"></mb-input>
                                        </mb-form-field>
                                    </div>
                                    <mb-form-field label="GPA points (optional)" [controlId]="'grading-band-gpa'">
                                        <mb-input id="grading-band-gpa" [value]="gradingBandFormGpa()"
                                            (valueChange)="gradingBandFormGpa.set($event)"></mb-input>
                                    </mb-form-field>
                                    <label class="grading-modal__toggle">
                                        <input type="checkbox" [checked]="gradingBandFormPass()"
                                            (change)="gradingBandFormPass.set($any($event.target).checked)" />
                                        <span>Pass</span>
                                    </label>
                                </div>
                                <div mbModalFooter class="grading-modal__footer">
                                    <mb-button variant="secondary"
                                        (click)="requestCloseGradeBandForm()">Cancel</mb-button>
                                    <mb-button variant="primary" (click)="saveGradeBand()">
                                        {{ gradingBandFormMode() === 'add' ? 'Save band' : 'Save changes' }}
                                    </mb-button>
                                </div>
                            </mb-modal>
                        </div>

                        <div class="setup-body" *ngIf="step() === 2">
                            <div class="setup-section">
                                <div class="users-header">
                                    <div>
                                        <h2>Staff & users</h2>
                                        <p>Add staff who will access the workspace. You can invite now and assign roles
                                            later.</p>

                                    </div>
                                </div>
                                <input #csvInput type="file" class="users-csv-input" accept=".csv"
                                    (change)="handleCsvImport($event)" />

                                <div class="users-utility" *ngIf="users().length">
                                    <mb-form-field *ngIf="users().length >= 5" label="Search"
                                        [controlId]="'user-search'">
                                        <mb-input id="user-search" [value]="userSearch()"
                                            [placeholder]="'Search by name or email'"
                                            (valueChange)="userSearch.set($event)"></mb-input>
                                    </mb-form-field>
                                    <div class="users-utility__actions">
                                        <mb-split-button label="Add users" variant="primary" size="md"
                                            [items]="addUsersMenuItems()" (primaryClick)="openInviteModal()"
                                            (itemSelect)="handleAddUsersAction($event, csvInput)"></mb-split-button>
                                    </div>
                                </div>

                                <div class="users-table-wrap" *ngIf="users().length; else emptyUsers">
                                    <mb-table class="users-table" [columns]="userTableColumns" [rows]="filteredUsers()"
                                        (cellClick)="handleUserCellClick($event)">
                                        <ng-template mbTableActions let-row>
                                            <div class="users-table__actions">
                                                <button type="button" class="users-menu__toggle" #userMenuOrigin
                                                    aria-label="Actions"
                                                    [attr.aria-expanded]="userMenuOpenId() === userMenuKey(row)"
                                                    (click)="toggleUserMenu(userMenuKey(row), $event)">⋯</button>
                                                <mb-popover
                                                    [open]="userMenuOpenId() === userMenuKey(row)"
                                                    [origin]="userMenuOrigin"
                                                    [hasBackdrop]="true"
                                                    [panelClass]="['mb-popover-panel', 'mb-popover-panel--above-modal', 'users-menu__panel']"
                                                    (closed)="closeUserMenu()"
                                                >
                                                    <div class="users-menu__panel-content" role="menu">
                                                        <button type="button" class="users-menu__item"
                                                            (click)="openEditUser(getUserRowIndex(row)); closeUserMenu()">
                                                            Edit details
                                                        </button>
                                                        <button type="button" class="users-menu__item"
                                                            *ngIf="row.status === 'Invited'"
                                                            (click)="resendInvite(getUserRowIndex(row)); closeUserMenu()">
                                                            Resend invite
                                                        </button>
                                                        <button type="button" class="users-menu__item"
                                                            *ngIf="row.status !== 'Invited'"
                                                            (click)="toggleUserStatus(getUserRowIndex(row)); closeUserMenu()">
                                                            {{ row.status === 'Suspended' ? 'Activate user' : 'Suspend
                                                            user' }}
                                                        </button>
                                                        <button type="button"
                                                            class="users-menu__item users-menu__item--danger"
                                                            (click)="removeUser(getUserRowIndex(row)); closeUserMenu()">
                                                            Remove
                                                        </button>
                                                    </div>
                                                </mb-popover>
                                            </div>
                                        </ng-template>
                                    </mb-table>

                                </div>
                                <ng-template #emptyUsers>
                                    <div class="users-empty">
                                        <div class="users-empty__icon" aria-hidden="true">
                                            <svg viewBox="0 0 48 48" fill="none">
                                                <circle cx="24" cy="16" r="8" stroke="currentColor" stroke-width="2">
                                                </circle>
                                                <path d="M10 40c0-7.2 6.3-13 14-13s14 5.8 14 13" stroke="currentColor"
                                                    stroke-width="2" stroke-linecap="round"></path>
                                            </svg>
                                        </div>
                                        <div class="users-empty__title">No staff or users yet</div>
                                        <div class="users-empty__text">
                                            Add users to give your team access to the workspace.
                                        </div>
                                        <div class="users-empty__actions">
                                            <mb-split-button label="Add users ▼" variant="primary" size="md"
                                                [items]="addUsersMenuItems()" (primaryClick)="openInviteModal()"
                                                (itemSelect)="handleAddUsersAction($event, csvInput)"></mb-split-button>
                                        </div>
                                    </div>
                                </ng-template>
                            </div>

                            <div class="setup-footer">
                                <div class="setup-footer__actions">
                                    <mb-button variant="secondary" (click)="back()">Back</mb-button>
                                    <mb-button variant="primary" [disabled]="!canContinueUsersStep()"
                                        (click)="next()">Continue</mb-button>
                                </div>
                                <div class="setup-footer__aside">
                                    <button type="button" class="setup-skip-link" (click)="skipUsersStep()">Skip for
                                        now</button>
                                    <div class="setup-footer__hint">You can continue setup without adding users.</div>
                                    <div class="setup-footer__hint">You can resume later from Settings → Workspace
                                        setup.</div>
                                </div>
                            </div>
                            <div class="setup-auto-save"><span aria-hidden="true">✓</span> Configuration changes are
                                saved automatically.</div>

                            <div class="users-modal" *ngIf="isInviteModalOpen()" role="presentation">
                                <div class="users-modal__backdrop"></div>
                                <div class="users-modal__dialog" role="dialog" aria-modal="true"
                                    aria-labelledby="invite-modal-title" tabindex="0" cdkTrapFocus
                                    cdkTrapFocusAutoCapture (keydown.escape)="closeInviteModal()">
                                    <div class="users-modal__header">
                                        <div>
                                            <div id="invite-modal-title" class="users-modal__title">Invite users</div>
                                            <div class="users-modal__subtitle">Users will receive an email to set up
                                                their account.</div>
                                        </div>
                                        <button type="button" class="users-modal__close" (click)="closeInviteModal()"
                                            aria-label="Close dialog">×</button>
                                    </div>
                                    <div class="users-modal__body" (keydown)="handleInviteKeydown($event)">
                                        <mb-form-field label="Email addresses" [controlId]="'invite-emails'"
                                            [error]="inviteTouched() && inviteEmailList().length === 0 ? 'Add at least one email.' : (inviteInvalidEmails().length ? 'Remove invalid email addresses.' : (inviteDuplicateEmails().length ? 'Remove duplicate email addresses.' : ''))"
                                            hint="Enter one or more email addresses. Press Enter or comma to add.">
                                            <div class="users-email-input">
                                                <div class="users-email-input__list">
                                                    <span class="users-token"
                                                        *ngFor="let email of inviteEmailList(); let i = index; trackBy: trackInviteEmail"
                                                        [class.is-invalid]="isInviteEmailInvalid(email) || isInviteEmailDuplicate(email, i)"
                                                        [attr.title]="isInviteEmailInvalid(email) ? 'Invalid email' : (isInviteEmailDuplicate(email, i) ? 'Duplicate email' : null)">
                                                        <span class="users-token__text">{{ email }}</span>
                                                        <button type="button" class="users-token__remove"
                                                            (click)="removeInviteEmail(i)"
                                                            [attr.aria-label]="'Remove ' + email">
                                                            ×
                                                        </button>
                                                    </span>
                                                    <mb-input class="users-email-input__field" id="invite-emails"
                                                        [value]="inviteEmailInput()"
                                                        (valueChange)="inviteEmailInput.set($event)"
                                                        (keydown)="onInviteEmailKeydown($event)"
                                                        (paste)="onInviteEmailPaste($event)"
                                                        (blurEvent)="onInviteEmailBlur()" cdkFocusInitial
                                                        placeholder="name@company.com"></mb-input>
                                                </div>
                                            </div>
                                        </mb-form-field>

                                        <mb-form-field label="Assigned role" [controlId]="'invite-role'"
                                            hint="You can change roles later.">
                                            <mb-role-selector id="invite-role" [value]="inviteRoleIds()" [label]="''"
                                                [multiple]="true" placeholder="Select role..."
                                                (change)="handleInviteRoleChange($event)"></mb-role-selector>
                                        </mb-form-field>

                                        <div class="users-modal__section">
                                            <div class="users-modal__section-title">School access</div>
                                            <div class="users-radio-group users-radio-group--compact">
                                                <label class="users-radio">
                                                    <input type="radio" name="invite-access"
                                                        [checked]="inviteSchoolAccess() === 'all'"
                                                        (change)="inviteSchoolAccess.set('all')" />
                                                    <span>All schools</span>
                                                    <span class="users-radio__hint">Recommended</span>
                                                </label>
                                                <label class="users-radio">
                                                    <input type="radio" name="invite-access"
                                                        [checked]="inviteSchoolAccess() === 'selected'"
                                                        (change)="inviteSchoolAccess.set('selected')" />
                                                    <span>Selected schools</span>
                                                </label>
                                            </div>
                                            <div class="users-school-list"
                                                [class.is-open]="inviteSchoolAccess() === 'selected'">
                                                <div class="users-school-list__content">
                                                    <mb-checkbox *ngFor="let name of activeSchoolNames()"
                                                        [checked]="inviteSelectedSchools().includes(name)"
                                                        (checkedChange)="toggleInviteSchoolSelection(name, $event)">{{
                                                        name }}</mb-checkbox>
                                                </div>
                                            </div>
                                            <div class="users-inline-error"
                                                *ngIf="inviteTouched() && inviteSchoolAccess() === 'selected' && inviteSelectedSchools().length === 0">
                                                Select at least one school.
                                            </div>
                                        </div>

                                        <button type="button" class="users-link" (click)="toggleInviteMessage()">
                                            {{ inviteMessageOpen() ? 'Hide message' : '+ Add optional message' }}
                                        </button>
                                        <mb-form-field *ngIf="inviteMessageOpen()" class="users-textarea-field"
                                            label="Optional message"
                                            [controlId]="'invite-message'">
                                            <mb-textarea id="invite-message" [value]="inviteMessage()"
                                                (valueChange)="inviteMessage.set($event)"
                                                placeholder="Add a short note to include in the invitation email."></mb-textarea>
                                        </mb-form-field>
                                    </div>
                                    <div class="users-modal__footer">
                                        <div class="users-modal__hint">Invitations can be resent or revoked later.</div>
                                        <div class="users-modal__actions">
                                            <mb-button variant="secondary"
                                                (click)="closeInviteModal()">Cancel</mb-button>
                                            <mb-button variant="primary" [disabled]="!inviteCanSubmit()"
                                                [loading]="inviteSending()" (click)="sendInvites()">
                                                Send invitations
                                            </mb-button>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <div class="users-modal" *ngIf="isEditUserModalOpen()" role="presentation">
                                <div class="users-modal__backdrop"></div>
                                <div class="users-modal__dialog" role="dialog" aria-modal="true"
                                    aria-labelledby="edit-user-title" tabindex="0" (keydown.escape)="closeEditUser()">
                                    <div class="users-modal__header">
                                        <div>
                                            <div id="edit-user-title" class="users-modal__title">Edit user</div>
                                            <div class="users-modal__subtitle">Update role, access, and employment
                                                details.</div>
                                        </div>
                                        <button type="button" class="users-modal__close" (click)="closeEditUser()"
                                            aria-label="Close dialog">×</button>
                                    </div>
                                    <div class="users-modal__body">
                                        <mb-form-field label="Full name" [controlId]="'edit-user-name'"
                                            [error]="editTouched() && !editName().trim() ? 'Name is required.' : ''">
                                            <mb-input id="edit-user-name" [value]="editName()"
                                                (valueChange)="editName.set($event)"
                                                (blur)="editTouched.set(true)"></mb-input>
                                        </mb-form-field>
                                        <mb-form-field label="Email" [controlId]="'edit-user-email'">
                                            <mb-input id="edit-user-email" [value]="editEmail()"
                                                [disabled]="true"></mb-input>
                                        </mb-form-field>
                                        <mb-form-field label="Role" [controlId]="'edit-user-role'">
                                            <mb-select id="edit-user-role" [value]="editRole()"
                                                (valueChange)="setEditRole($event)">
                                                <option value="Owner">Owner</option>
                                                <option value="Administrator">Administrator</option>
                                                <option value="Staff">Staff</option>
                                                <option value="Teacher">Teacher</option>
                                            </mb-select>
                                        </mb-form-field>

                                        <div class="users-modal__section">
                                            <div class="users-modal__section-title">School access</div>
                                            <label class="users-radio">
                                                <input type="radio" name="edit-access"
                                                    [checked]="editSchoolAccess() === 'all'"
                                                    (change)="editSchoolAccess.set('all')" />
                                                <span>All schools</span>
                                            </label>
                                            <label class="users-radio">
                                                <input type="radio" name="edit-access"
                                                    [checked]="editSchoolAccess() === 'selected'"
                                                    (change)="editSchoolAccess.set('selected')" />
                                                <span>Selected schools</span>
                                            </label>
                                            <div class="users-school-list" *ngIf="editSchoolAccess() === 'selected'">
                                                <mb-checkbox *ngFor="let name of activeSchoolNames()"
                                                    [checked]="editSelectedSchools().includes(name)"
                                                    (checkedChange)="toggleEditSchoolSelection(name, $event)">{{ name
                                                    }}</mb-checkbox>
                                            </div>
                                        </div>

                                        <div class="users-modal__section">
                                            <div class="users-modal__section-title">Employment details</div>
                                            <mb-form-field label="Job title" [controlId]="'edit-user-job'">
                                                <mb-input id="edit-user-job" [value]="editJobTitle()"
                                                    (valueChange)="editJobTitle.set($event)"></mb-input>
                                            </mb-form-field>
                                            <mb-form-field label="Department" [controlId]="'edit-user-dept'">
                                                <mb-input id="edit-user-dept" [value]="editDepartment()"
                                                    (valueChange)="editDepartment.set($event)"></mb-input>
                                            </mb-form-field>
                                            <mb-form-field label="Staff ID (optional)"
                                                [controlId]="'edit-user-staff-id'">
                                                <mb-input id="edit-user-staff-id" [value]="editStaffId()"
                                                    (valueChange)="editStaffId.set($event)"></mb-input>
                                            </mb-form-field>
                                        </div>
                                    </div>
                                    <div class="users-modal__footer">
                                        <div class="users-modal__hint">Changes are saved immediately.</div>
                                        <div class="users-modal__actions">
                                            <mb-button variant="secondary" (click)="closeEditUser()">Cancel</mb-button>
                                            <mb-button variant="primary"
                                                [disabled]="editTouched() && !editName().trim()"
                                                (click)="saveUserEdits()">
                                                Save changes
                                            </mb-button>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <div class="users-modal" *ngIf="isViewUserModalOpen()" role="presentation">
                                <div class="users-modal__backdrop"></div>
                                <div class="users-modal__dialog" role="dialog" aria-modal="true"
                                    aria-labelledby="view-user-title" tabindex="0" (keydown.escape)="closeViewUser()">
                                    <div class="users-modal__header">
                                        <div>
                                            <div id="view-user-title" class="users-modal__title">User details</div>
                                            <div class="users-modal__subtitle">Review identity, access, and status.
                                            </div>
                                        </div>
                                        <button type="button" class="users-modal__close" (click)="closeViewUser()"
                                            aria-label="Close dialog">×</button>
                                    </div>
                                    <div class="users-modal__body" *ngIf="viewUser() as user">
                                        <div class="users-view">
                                            <div class="users-view__name">{{ user.name || 'Pending name' }}</div>
                                            <div class="users-view__email">{{ user.email }}</div>
                                            <div class="users-view__row">
                                                <div class="users-view__label">Role</div>
                                                <div class="users-view__value">{{ user.role }}</div>
                                            </div>
                                            <div class="users-view__row">
                                                <div class="users-view__label">School access</div>
                                                <div class="users-view__value">{{ schoolAccessLabel(user) }}</div>
                                            </div>
                                            <div class="users-view__row">
                                                <div class="users-view__label">Status</div>
                                                <div class="users-view__value">{{ user.status }}</div>
                                            </div>
                                            <div class="users-view__row" *ngIf="user.lastLogin">
                                                <div class="users-view__label">Last login</div>
                                                <div class="users-view__value">{{ user.lastLogin }}</div>
                                            </div>
                                            <div class="users-view__row" *ngIf="user.createdAt">
                                                <div class="users-view__label">Created</div>
                                                <div class="users-view__value">{{ user.createdAt | date:'mediumDate' }}
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="users-modal__footer" *ngIf="viewUser() as user">
                                        <div class="users-modal__actions">
                                            <mb-button variant="secondary" (click)="closeViewUser()">Close</mb-button>
                                            <mb-button variant="primary"
                                                (click)="openEditUser(getUserRowIndex(user)); closeViewUser()">
                                                Edit
                                            </mb-button>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <div class="users-modal" *ngIf="isCreateUserModalOpen()" role="presentation">
                                <div class="users-modal__backdrop"></div>
                                <div class="users-modal__dialog" role="dialog" aria-modal="true"
                                    aria-labelledby="create-user-title" tabindex="0"
                                    (keydown.escape)="closeCreateUserModal()">
                                    <div class="users-modal__header">
                                        <div>
                                            <div id="create-user-title" class="users-modal__title">Create user</div>
                                            <div class="users-modal__subtitle">Create an account manually for this
                                                workspace.</div>
                                        </div>
                                        <button type="button" class="users-modal__close"
                                            (click)="closeCreateUserModal()" aria-label="Close dialog">×</button>
                                    </div>
                                    <div class="users-modal__body">
                                        <mb-form-field label="Full name" [controlId]="'create-user-name'"
                                            [error]="createTouched() && !createName().trim() ? 'Name is required.' : ''">
                                            <mb-input id="create-user-name" [value]="createName()"
                                                (valueChange)="createName.set($event)"
                                                (blur)="createTouched.set(true)"></mb-input>
                                        </mb-form-field>
                                        <mb-form-field label="Email" [controlId]="'create-user-email'"
                                            [error]="createEmailError()">
                                            <mb-input id="create-user-email" [value]="createEmail()"
                                                (valueChange)="createEmail.set($event)"
                                                (blur)="createTouched.set(true)"></mb-input>
                                        </mb-form-field>
                                        <mb-form-field label="Role" [controlId]="'create-user-role'"
                                            hint="Determines what this user can view and manage.">
                                            <mb-role-selector [value]="createRoleIds()" [label]="''"
                                                [placeholder]="'Select role…'" [multiple]="true" [maxVisibleChips]="3"
                                                (change)="handleCreateRoleChange($event)"></mb-role-selector>
                                        </mb-form-field>

                                        <div class="users-modal__section users-modal__section--spaced">
                                            <div class="users-modal__section-title">School access</div>
                                            <div class="users-radio-group">
                                                <label class="users-radio">
                                                    <input type="radio" name="create-access"
                                                        [checked]="createSchoolAccess() === 'all'"
                                                        (change)="createSchoolAccess.set('all')" />
                                                    <span>Access all schools</span>
                                                </label>
                                                <label class="users-radio">
                                                    <input type="radio" name="create-access"
                                                        [checked]="createSchoolAccess() === 'selected'"
                                                        (change)="createSchoolAccess.set('selected')" />
                                                    <span>Limit to selected schools</span>
                                                </label>
                                            </div>
                                            <div class="users-school-list" *ngIf="createSchoolAccess() === 'selected'">
                                                <mb-checkbox *ngFor="let name of activeSchoolNames()"
                                                    [checked]="createSelectedSchools().includes(name)"
                                                    (checkedChange)="toggleCreateSchoolSelection(name, $event)">{{ name
                                                    }}</mb-checkbox>
                                            </div>
                                        </div>

                                        <div class="users-modal__section users-modal__section--spaced">
                                            <div class="users-modal__section-title">Employment details</div>
                                            <mb-form-field label="Job title" [controlId]="'create-user-job'">
                                                <mb-input id="create-user-job" [value]="createJobTitle()"
                                                    (valueChange)="createJobTitle.set($event)"></mb-input>
                                            </mb-form-field>
                                            <mb-form-field label="Department" [controlId]="'create-user-dept'">
                                                <mb-input id="create-user-dept" [value]="createDepartment()"
                                                    (valueChange)="createDepartment.set($event)"></mb-input>
                                            </mb-form-field>
                                            <mb-form-field label="Staff ID (optional)"
                                                [controlId]="'create-user-staff-id'">
                                                <mb-input id="create-user-staff-id" [value]="createStaffId()"
                                                    (valueChange)="createStaffId.set($event)"></mb-input>
                                            </mb-form-field>
                                        </div>
                                    </div>
                                    <div class="users-modal__footer">
                                        <div class="users-modal__actions">
                                            <mb-button variant="tertiary"
                                                (click)="closeCreateUserModal()">Cancel</mb-button>
                                            <mb-button variant="primary" [disabled]="!createCanSubmit()"
                                                (click)="saveCreateUser()">
                                                Create user
                                            </mb-button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="setup-body" *ngIf="step() === 7">
                            <div class="setup-section">
                                <div class="review-header">
                                    <div>
                                        <h2>Review &amp; activate</h2>
                                        <p>Confirm your workspace configuration before activation. You can update these
                                            settings anytime from Settings.</p>
                                    </div>
                                    <span class="review-status-pill"
                                        [class.is-ready]="reviewReady()"
                                        [class.is-warning]="!reviewReady()">
                                        {{ reviewReady() ? 'Ready to activate' : 'Action required' }}
                                    </span>
                                </div>

                                <div class="review-progress">{{ reviewCompletedCount() }} of {{ stepLabels.length }}
                                    completed</div>

                                <div class="review-grid">
                                    <div class="review-card">
                                        <div class="review-card__top">
                                            <span class="review-card__label">Schools</span>
                                            <button type="button" class="review-link" (click)="goToStep(1)">Edit</button>
                                        </div>
                                        <div class="review-value">{{ schoolRows().length }} schools</div>
                                        <div class="review-details">
                                            <span>Active: {{ activeSchoolNames().length }}</span>
                                            <span>Default timezone: {{ defaultTimezone() || 'Not set' }}</span>
                                        </div>
                                        <span class="review-status" [class.is-complete]="schoolsValid()"
                                            [class.is-warning]="!schoolsValid()">
                                            {{ schoolsValid() ? 'Complete' : 'Needs attention' }}
                                        </span>
                                    </div>
                                    <div class="review-card">
                                        <div class="review-card__top">
                                            <span class="review-card__label">Academic levels</span>
                                            <button type="button" class="review-link" (click)="goToStep(4)">Edit</button>
                                        </div>
                                        <div class="review-value">{{ levels().length }} levels</div>
                                        <div class="review-details">
                                            <span>Template: {{ levelsTemplate() | titlecase }}</span>
                                            <span>{{ levels().length ? 'Sequence defined' : 'No levels added' }}</span>
                                        </div>
                                        <span class="review-status" [class.is-complete]="levels().length > 0"
                                            [class.is-warning]="levels().length === 0">
                                            {{ levels().length > 0 ? 'Complete' : 'Needs attention' }}
                                        </span>
                                    </div>
                                    <div class="review-card">
                                        <div class="review-card__top">
                                            <span class="review-card__label">Grading system</span>
                                            <button type="button" class="review-link" (click)="goToStep(6)">Edit</button>
                                        </div>
                                        <div class="review-value">{{ gradingModel() | titlecase }}</div>
                                        <div class="review-details">
                                            <span>{{ gradingScales().length }} scale(s)</span>
                                            <span>{{ gradingScaleUsageLabel() }}</span>
                                        </div>
                                        <span class="review-status" [class.is-complete]="gradingScales().length > 0"
                                            [class.is-warning]="gradingScales().length === 0">
                                            {{ gradingScales().length > 0 ? 'Complete' : 'Needs attention' }}
                                        </span>
                                    </div>
                                    <div class="review-card">
                                        <div class="review-card__top">
                                            <span class="review-card__label">Staff &amp; users</span>
                                            <button type="button" class="review-link" (click)="goToStep(2)">Edit</button>
                                        </div>
                                        <div class="review-value">{{ userCount() }} users</div>
                                        <div class="review-details">
                                            <span>{{ usersStepSkipped() ? 'Invites skipped' : 'Invites sent' }}</span>
                                            <span>{{ userCount() ? 'Access assigned' : 'No users added' }}</span>
                                        </div>
                                        <span class="review-status" [class.is-complete]="canContinueUsersStep()"
                                            [class.is-warning]="!canContinueUsersStep()">
                                            {{ canContinueUsersStep() ? 'Complete' : 'Needs attention' }}
                                        </span>
                                    </div>
                                </div>

                                <div class="review-info">
                                    <div class="review-info__icon" aria-hidden="true">i</div>
                                    <div>
                                        <div class="review-info__title">After activation</div>
                                        <ul>
                                            <li>Your workspace becomes available to all assigned users.</li>
                                            <li>You can enroll students, take attendance, and generate reports.</li>
                                            <li>Settings can still be updated later from Workspace Setup.</li>
                                        </ul>
                                    </div>
                                </div>
                            </div>

                            <div class="setup-actions review-actions">
                                <mb-button variant="secondary" (click)="back()">Back</mb-button>
                                <mb-button variant="primary" [loading]="isSaving()" [disabled]="isSaving()" (click)="next()">
                                    Activate workspace
                                </mb-button>
                            </div>
                            <div class="review-helper">Configuration changes are saved automatically.</div>
                        </div>

                    </mb-card>
                </div>
            </div>

            <div class="setup-body setup-complete-body" *ngIf="step() === 8">
                <div class="setup-complete-card">
                    <div class="setup-complete__content">
                        <div class="setup-complete__main">
                            <div class="setup-complete__title-row">
                                <span class="setup-complete__badge" aria-hidden="true">
                                    <svg viewBox="0 0 20 20" role="img" aria-hidden="true">
                                        <path
                                            d="M10 1.5a8.5 8.5 0 1 0 0 17a8.5 8.5 0 0 0 0-17Zm3.62 6.2a.9.9 0 0 1 .13 1.27l-4.02 4.93a.9.9 0 0 1-1.36.05l-2.05-2.15a.9.9 0 1 1 1.3-1.24l1.36 1.43l3.36-4.12a.9.9 0 0 1 1.27-.17Z" />
                                    </svg>
                                </span>
                                <h2>Workspace setup complete</h2>
                            </div>
                            <p class="setup-complete__subtitle">
                                Your workspace is ready. You can start using MindBloom now, or fine-tune settings
                                anytime.
                            </p>
                            <div class="setup-complete__actions">
                                <mb-button variant="primary" (click)="finish()">Go to dashboard</mb-button>
                                <mb-button variant="secondary" (click)="goToStep(1)">Review workspace settings</mb-button>
                                <mb-button variant="tertiary" (click)="goToStep(2)">Invite users</mb-button>
                            </div>
                            <div class="setup-complete__next">
                                <div class="setup-complete__next-title">Next steps</div>
                                <div class="setup-complete__next-links">
                                    <a class="setup-complete__next-link" routerLink="/students">Enroll students</a>
                                    <button type="button" class="setup-complete__next-link"
                                        (click)="goToStep(2)">Assign staff to schools</button>
                                    <a class="setup-complete__next-link" routerLink="/academics">Set up timetables</a>
                                </div>
                            </div>
                        </div>
                        <div class="setup-complete__summary">
                            <div class="setup-complete__summary-title">Setup summary</div>
                            <div class="setup-complete__summary-row">
                                <span>Schools</span>
                                <span>{{ schoolRows().length ? (schoolRows().length + ' schools') : 'Not set' }}</span>
                            </div>
                            <div class="setup-complete__summary-row">
                                <span>Staff &amp; users</span>
                                <span>{{ userCount() ? (userCount() + ' users') : 'Not set' }}</span>
                            </div>
                            <div class="setup-complete__summary-row">
                                <span>Organizational units</span>
                                <span>{{ orgUnits().length ? (orgUnits().length + ' units') : 'Not set' }}</span>
                            </div>
                            <div class="setup-complete__summary-row">
                                <span>Classes &amp; sections</span>
                                <span>
                                    {{ classRows().length && sectionRows().length ? (classRows().length + ' classes, ' +
                                    sectionRows().length + ' sections') : 'Not set' }}
                                </span>
                            </div>
                            <div class="setup-complete__summary-row">
                                <span>Grading system</span>
                                <span>{{ gradingScales().length ? (gradingScales().length + ' scales') : 'Not set' }}</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </ng-container>
    </mb-card>
</div>
