<div class="setup-page">
    <mb-card class="setup-card">
        <div class="setup-loading" *ngIf="isLoading()">Loading workspace setup…</div>

        <ng-container *ngIf="!isLoading()">
            <div class="setup-entry" *ngIf="step() === 0">
                <div class="setup-header">
                    <div class="setup-entry-title">
                        <span class="setup-icon" aria-hidden="true">✓</span>
                        <h1>Finish setting up your workspace</h1>
                    </div>
                    <p class="setup-entry-body">
                        Set up your schools, academic structure, and staff so your team can start working right away.
                    </p>
                    <p class="setup-entry-meta">Takes about 5–10 minutes · You can pause and continue anytime from Settings.</p>
                </div>

                <div class="setup-body">
                    <div class="setup-actions setup-entry-actions">
                        <mb-button variant="primary" (click)="startSetup()">Start setup</mb-button>
                        <div class="setup-skip-block">
                            <mb-button variant="tertiary" (click)="skipSetup()">Skip for now</mb-button>
                            <p class="setup-skip-hint">Resume later from Settings → Workspace setup.</p>
                        </div>
                    </div>
                </div>
            </div>

            <div class="workspace-setup-grid" *ngIf="step() > 0 && !isDoneStep()">
                <div class="workspace-setup-nav">
                    <mb-card class="setup-nav-card">
                        <div class="setup-progress__content">
                            <div class="setup-progress__header">
                                <div class="setup-progress__kicker">Workspace configuration</div>
                                <h2>Setup progress</h2>
                                <p>Complete the setup to enable all features. You can return at any time from Settings.</p>
                            </div>
                            <div class="setup-progress__meta">Step {{ progressIndex() < 0 ? 0 : progressIndex() + 1 }} of {{ stepLabels.length }}</div>
                            <div class="setup-progress__bar" aria-hidden="true">
                                <div class="setup-progress__bar-fill" [style.width.%]="progressPercent()"></div>
                            </div>
                            <div class="setup-progress__list">
                                <button
                                  type="button"
                                  class="setup-progress__item"
                                  *ngFor="let label of stepLabels; let i = index"
                                  [class.is-complete]="i < progressIndex()"
                                  [class.is-current]="i === progressIndex()"
                                  (click)="goToStep(i + 1)"
                                >
                                  <span class="setup-progress__icon" aria-hidden="true">{{ i < progressIndex() ? '✓' : (i === progressIndex() ? '●' : '○') }}</span>
                                  <span class="setup-progress__label">{{ label }}</span>
                                </button>
                            </div>
                            <div class="setup-progress__actions">
                                <mb-button variant="primary" (click)="continueFromPanel()">Continue setup</mb-button>
                                <button type="button" class="setup-progress__dismiss" (click)="skipSetup()">Dismiss for now</button>
                                <span class="setup-progress__hint">
                                    You can resume anytime from Settings → Workspace setup.
                                    <span class="setup-progress__info" aria-hidden="true" title="Setup is saved automatically.">i</span>
                                </span>
                            </div>
                        </div>
                    </mb-card>
                </div>
                <div class="workspace-setup-content">
                    <mb-card class="setup-content-card">
                        <mb-alert *ngIf="errorMessage()" variant="danger">{{ errorMessage() }}</mb-alert>

                        <div class="setup-body" id="setup-step-content" *ngIf="step() === 1">
                            <div class="setup-section">
                                <h2>Schools</h2>
                                <p>Manage the schools under your organization. You can add, edit, or deactivate schools at any time.</p>

                                <div class="schools-grid" [class.schools-grid--panel]="isSchoolPanelOpen()">
                                    <div class="schools-table-wrap">
                                        <div class="schools-toolbar">
                                            <div class="schools-toolbar__spacer"></div>
                                            <mb-button variant="primary" (click)="openAddSchool()">+ Add school</mb-button>
                                        </div>

                                        <div class="schools-table" *ngIf="schoolRows().length; else emptySchools">
                                            <div class="schools-table__header">
                                                <div>School name</div>
                                                <div>Code</div>
                                                <div>Location</div>
                                                <div>Time zone</div>
                                                <div>Status</div>
                                                <div>Actions</div>
                                            </div>
                                            <div class="schools-table__row" *ngFor="let row of schoolRows(); let i = index">
                                                <div class="schools-table__cell">
                                                    <div class="schools-table__name">{{ row.name }}</div>
                                                </div>
                                                <div class="schools-table__cell">{{ row.code }}</div>
                                                <div class="schools-table__cell">
                                                    {{ row.city ? (row.city + ', ' + row.country) : (row.country || '—') }}
                                                </div>
                                                <div class="schools-table__cell">{{ row.timezone }}</div>
                                                <div class="schools-table__cell">
                                                    <span class="schools-status" [class.is-inactive]="row.status === 'Inactive'">
                                                        {{ row.status }}
                                                    </span>
                                                </div>
                                                <div class="schools-table__cell schools-table__actions">
                                                    <button type="button" class="schools-action" (click)="openEditSchool(i)">Edit</button>
                                                    <details class="schools-menu">
                                                        <summary class="schools-menu__toggle">More</summary>
                                                        <div class="schools-menu__panel">
                                                            <button type="button" class="schools-menu__item"
                                                                (click)="toggleSchoolStatus(i)">
                                                                {{ row.status === 'Active' ? 'Deactivate school' : 'Activate school' }}
                                                            </button>
                                                        </div>
                                                    </details>
                                                </div>
                                            </div>
                                        </div>

                                        <ng-template #emptySchools>
                                            <div class="schools-empty">
                                                <div class="schools-empty__title">No schools added yet</div>
                                                <div class="schools-empty__text">
                                                    Add your first school to start configuring academic structure and users.
                                                </div>
                                                <mb-button variant="primary" (click)="openAddSchool()">+ Add school</mb-button>
                                            </div>
                                        </ng-template>
                                    </div>

                                    <div class="schools-panel" *ngIf="isSchoolPanelOpen()">
                                        <div class="schools-panel__header">
                                            <div>
                                                <div class="schools-panel__title">
                                                    {{ editingSchoolIndex() === null ? 'Add school' : 'Edit school' }}
                                                </div>
                                                <div class="schools-panel__subtitle">Required details only.</div>
                                            </div>
                                            <button type="button" class="schools-panel__close" (click)="closeSchoolPanel()">×</button>
                                        </div>
                                        <div class="schools-panel__body">
                                            <mb-form-field label="School name" [controlId]="'school-form-name'"
                                                [error]="schoolFormTouched() && !schoolFormName().trim() ? 'School name is required.' : ''">
                                                <mb-input id="school-form-name" [value]="schoolFormName()"
                                                    (valueChange)="schoolFormName.set($event)"></mb-input>
                                            </mb-form-field>

                                            <mb-form-field label="School code" [controlId]="'school-form-code'"
                                                hint="Short identifier used internally."
                                                [error]="schoolFormTouched() && !schoolFormCode().trim() ? 'School code is required.' : ''">
                                                <mb-input id="school-form-code" [value]="schoolFormCode()"
                                                    (valueChange)="schoolFormCode.set($event)"></mb-input>
                                            </mb-form-field>

                                            <mb-form-field label="Country or region" [controlId]="'school-form-country'"
                                                [error]="schoolFormTouched() && !schoolFormCountry().trim() ? 'Select a country or region.' : ''">
                                                <mb-select id="school-form-country" [value]="schoolFormCountry()"
                                                    (valueChange)="schoolFormCountry.set($event)">
                                                    <option value="">Select a country or region</option>
                                                    <option *ngFor="let option of countryOptions()" [value]="option.label">
                                                        {{ option.label }}
                                                    </option>
                                                </mb-select>
                                            </mb-form-field>

                                            <mb-form-field label="City (optional)" [controlId]="'school-form-city'">
                                                <mb-input id="school-form-city" [value]="schoolFormCity()"
                                                    (valueChange)="schoolFormCity.set($event)"></mb-input>
                                            </mb-form-field>

                                            <mb-form-field label="Time zone" [controlId]="'school-form-timezone'"
                                                [error]="schoolFormTouched() && !schoolFormTimezone().trim() ? 'Select a time zone.' : ''">
                                                <mb-select id="school-form-timezone" [value]="schoolFormTimezone()"
                                                    (valueChange)="schoolFormTimezone.set($event)">
                                                    <option value="">Select a time zone</option>
                                                    <option *ngFor="let tz of timezones()" [value]="tz">{{ tz }}</option>
                                                </mb-select>
                                            </mb-form-field>
                                        </div>
                                        <div class="schools-panel__actions">
                                            <mb-button variant="secondary" (click)="closeSchoolPanel()">Cancel</mb-button>
                                            <mb-button variant="primary" [disabled]="!canSaveSchool()" (click)="saveSchool()">Save school</mb-button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="setup-footer">
                                <div class="setup-footer__actions">
                                    <mb-button variant="secondary" (click)="back()">Back</mb-button>
                                    <mb-button variant="primary" [disabled]="!canContinue()" (click)="next()">Continue</mb-button>
                                </div>
                                <div class="setup-footer__aside">
                                    <button type="button" class="setup-skip-link" (click)="skipSetup()">Skip for now</button>
                                    <div class="setup-footer__hint">You can change this later from Settings.</div>
                                </div>
                            </div>
                            <div class="setup-auto-save"><span aria-hidden="true">✓</span> Configuration changes are saved automatically.</div>
                        </div>

            <div class="setup-body" *ngIf="step() === 2">
                <div class="setup-section">
                    <h2>School details</h2>
                    <p>Review and adjust details for each school in your workspace.</p>

                    <div class="list-stack">
                        <div class="list-row" *ngFor="let row of schoolRows(); let i = index">
                            <mb-form-field label="School name" [controlId]="'school-name-' + i"
                                [error]="showErrors() && !row.name.trim() ? 'School name is required.' : ''">
                                <mb-input [id]="'school-name-' + i" [value]="row.name"
                                    (valueChange)="updateSchoolRow(i, 'name', $event)"></mb-input>
                            </mb-form-field>

                            <mb-form-field label="School code" [controlId]="'school-code-' + i"
                                [error]="showErrors() && !row.code.trim() ? 'School code is required.' : ''">
                                <mb-input [id]="'school-code-' + i" [value]="row.code"
                                    (valueChange)="updateSchoolRow(i, 'code', $event)"></mb-input>
                            </mb-form-field>

                            <mb-form-field label="Country or region" [controlId]="'school-country-' + i"
                                [error]="showErrors() && !row.country.trim() ? 'Select a country or region.' : ''">
                                <mb-select [id]="'school-country-' + i" [value]="row.country"
                                    (valueChange)="updateSchoolRow(i, 'country', $event)">
                                    <option value="">Select a country or region</option>
                                    <option *ngFor="let option of countryOptions()" [value]="option.label">
                                        {{ option.label }}
                                    </option>
                                </mb-select>
                            </mb-form-field>

                            <mb-form-field label="City (optional)" [controlId]="'school-city-' + i">
                                <mb-input [id]="'school-city-' + i" [value]="row.city || ''"
                                    (valueChange)="updateSchoolRow(i, 'city', $event)"></mb-input>
                            </mb-form-field>

                            <mb-form-field label="Time zone" [controlId]="'school-timezone-' + i"
                                [error]="showErrors() && !row.timezone.trim() ? 'Select a time zone.' : ''">
                                <mb-select [id]="'school-timezone-' + i" [value]="row.timezone"
                                    (valueChange)="updateSchoolRow(i, 'timezone', $event)">
                                    <option value="">Select a time zone</option>
                                    <option *ngFor="let tz of timezones()" [value]="tz">{{ tz }}</option>
                                </mb-select>
                            </mb-form-field>

                            <button type="button" class="list-remove" *ngIf="schoolRows().length > 1"
                                (click)="removeSchoolRow(i)">Remove</button>
                        </div>
                    </div>

                    <button type="button" class="list-add" (click)="addSchoolRow()">Add another school</button>
                </div>

                <div class="setup-footer">
                    <div class="setup-footer__actions">
                        <mb-button variant="secondary" (click)="back()">Back</mb-button>
                        <mb-button variant="primary" [disabled]="!canContinue()" (click)="next()">Continue</mb-button>
                    </div>
                    <div class="setup-footer__aside">
                        <button type="button" class="setup-skip-link" (click)="skipSetup()">Skip for now</button>
                    </div>
                </div>
                <div class="setup-auto-save"><span aria-hidden="true">✓</span> Configuration changes are saved automatically.</div>
            </div>

            <div class="setup-body" *ngIf="step() === 3">
                <div class="setup-section">
                    <h2>Organizational units</h2>
                    <p>Define departments or divisions for reporting and access.</p>

                    <div class="list-stack">
                        <div class="list-row" *ngFor="let department of departments(); let i = index">
                            <mb-form-field label="Department" [controlId]="'department-' + i">
                                <mb-input [id]="'department-' + i" [value]="department"
                                    (valueChange)="updateDepartment(i, $event)"></mb-input>
                            </mb-form-field>
                            <button type="button" class="list-remove" *ngIf="departments().length > 1"
                                (click)="removeDepartment(i)">Remove</button>
                        </div>
                    </div>

                    <button type="button" class="list-add" (click)="addDepartment()">Add department</button>
                </div>

                <div class="setup-footer">
                    <div class="setup-footer__actions">
                        <mb-button variant="secondary" (click)="back()">Back</mb-button>
                        <mb-button variant="primary" (click)="next()">Continue</mb-button>
                    </div>
                    <div class="setup-footer__aside">
                        <button type="button" class="setup-skip-link" (click)="skipSetup()">Skip for now</button>
                    </div>
                </div>
                <div class="setup-auto-save"><span aria-hidden="true">✓</span> Configuration changes are saved automatically.</div>
            </div>

            <div class="setup-body" *ngIf="step() === 4">
                <div class="setup-section">
                    <h2>Academic levels</h2>
                    <p>Choose a template, then adjust the list to match your structure.</p>

                    <div class="choice-grid">
                        <button type="button" class="choice-card" [class.active]="levelsTemplate() === 'k12'"
                            (click)="setLevelsTemplate('k12')">
                            <div class="choice-title">K–12</div>
                            <div class="choice-text">Kindergarten through Grade 12.</div>
                        </button>
                        <button type="button" class="choice-card"
                            [class.active]="levelsTemplate() === 'primary_secondary'"
                            (click)="setLevelsTemplate('primary_secondary')">
                            <div class="choice-title">Primary / Secondary</div>
                            <div class="choice-text">Split primary and secondary levels.</div>
                        </button>
                        <button type="button" class="choice-card" [class.active]="levelsTemplate() === 'custom'"
                            (click)="setLevelsTemplate('custom')">
                            <div class="choice-title">Custom</div>
                            <div class="choice-text">Build your own list of levels.</div>
                        </button>
                    </div>

                    <div class="list-stack">
                        <div class="list-row" *ngFor="let level of levels(); let i = index">
                            <mb-form-field label="Level" [controlId]="'level-' + i">
                                <mb-input [id]="'level-' + i" [value]="level"
                                    (valueChange)="updateLevel(i, $event)"></mb-input>
                            </mb-form-field>
                            <button type="button" class="list-remove" *ngIf="levels().length > 1"
                                (click)="removeLevel(i)">Remove</button>
                        </div>
                    </div>

                    <div class="setup-error" *ngIf="levelsError()">{{ levelsError() }}</div>

                    <button type="button" class="list-add" (click)="addLevel()">Add level</button>
                </div>

                <div class="setup-footer">
                    <div class="setup-footer__actions">
                        <mb-button variant="secondary" (click)="back()">Back</mb-button>
                        <mb-button variant="primary" [disabled]="!canContinue()" (click)="next()">Continue</mb-button>
                    </div>
                    <div class="setup-footer__aside">
                        <button type="button" class="setup-skip-link" (click)="skipSetup()">Skip for now</button>
                    </div>
                </div>
                <div class="setup-auto-save"><span aria-hidden="true">✓</span> Configuration changes are saved automatically.</div>
            </div>

            <div class="setup-body" *ngIf="step() === 5">
                <div class="setup-section">
                    <h2>Classes and sections</h2>
                    <p>Define your classes and assign them to academic levels.</p>

                    <div class="list-stack">
                        <div class="list-row" *ngFor="let row of classes(); let i = index">
                            <mb-form-field label="Class name" [controlId]="'class-name-' + i"
                                [error]="showErrors() && !row.name.trim() ? 'Class name is required.' : ''">
                                <mb-input [id]="'class-name-' + i" [value]="row.name"
                                    (valueChange)="updateClassRow(i, 'name', $event)"></mb-input>
                            </mb-form-field>

                            <mb-form-field label="Level" [controlId]="'class-level-' + i"
                                [error]="showErrors() && !row.level.trim() ? 'Select a level.' : ''">
                                <mb-select [id]="'class-level-' + i" placeholder="Select a level"
                                    [value]="row.level"
                                    (valueChange)="updateClassRow(i, 'level', $event)">
                                    <option *ngFor="let level of levels()" [value]="level">{{ level }}</option>
                                </mb-select>
                            </mb-form-field>

                            <mb-form-field label="Sections (optional)" [controlId]="'class-sections-' + i"
                                hint="Use commas to separate sections, e.g. A, B, C.">
                                <mb-input [id]="'class-sections-' + i" [value]="row.sections"
                                    (valueChange)="updateClassRow(i, 'sections', $event)"></mb-input>
                            </mb-form-field>

                            <button type="button" class="list-remove" *ngIf="classes().length > 1"
                                (click)="removeClassRow(i)">Remove</button>
                        </div>
                    </div>

                    <button type="button" class="list-add" (click)="addClassRow()">Add class</button>
                </div>

                <div class="setup-footer">
                    <div class="setup-footer__actions">
                        <mb-button variant="secondary" (click)="back()">Back</mb-button>
                        <mb-button variant="primary" [disabled]="!canContinue()" (click)="next()">Continue</mb-button>
                    </div>
                    <div class="setup-footer__aside">
                        <button type="button" class="setup-skip-link" (click)="skipSetup()">Skip for now</button>
                    </div>
                </div>
                <div class="setup-auto-save"><span aria-hidden="true">✓</span> Configuration changes are saved automatically.</div>
            </div>

            <div class="setup-body" *ngIf="step() === 6">
                <div class="setup-section">
                    <h2>Grading system</h2>
                    <p>Select the grading model used across your schools.</p>

                    <div class="choice-grid">
                        <button type="button" class="choice-card" [class.active]="gradingModel() === 'letter'"
                            (click)="gradingModel.set('letter')">
                            <div class="choice-title">Letter grades</div>
                            <div class="choice-text">A–F scale with descriptors.</div>
                        </button>
                        <button type="button" class="choice-card" [class.active]="gradingModel() === 'numeric'"
                            (click)="gradingModel.set('numeric')">
                            <div class="choice-title">Numeric</div>
                            <div class="choice-text">Percentage-based scores.</div>
                        </button>
                        <button type="button" class="choice-card" [class.active]="gradingModel() === 'gpa'"
                            (click)="gradingModel.set('gpa')">
                            <div class="choice-title">GPA</div>
                            <div class="choice-text">GPA scale for reporting.</div>
                        </button>
                        <button type="button" class="choice-card" [class.active]="gradingModel() === 'custom'"
                            (click)="gradingModel.set('custom')">
                            <div class="choice-title">Custom</div>
                            <div class="choice-text">Configure your own scale later.</div>
                        </button>
                    </div>

                    <div class="scale-preview">
                        <div class="scale-title">Scale preview</div>
                        <ul>
                            <li *ngFor="let row of gradingScale()">{{ row.label }} — {{ row.value }}</li>
                        </ul>
                    </div>
                </div>

                <div class="setup-footer">
                    <div class="setup-footer__actions">
                        <mb-button variant="secondary" (click)="back()">Back</mb-button>
                        <mb-button variant="primary" (click)="next()">Continue</mb-button>
                    </div>
                    <div class="setup-footer__aside">
                        <button type="button" class="setup-skip-link" (click)="skipSetup()">Skip for now</button>
                    </div>
                </div>
                <div class="setup-auto-save"><span aria-hidden="true">✓</span> Configuration changes are saved automatically.</div>
            </div>

            <div class="setup-body" *ngIf="step() === 7">
                <div class="setup-section">
                    <h2>Invite core users</h2>
                    <p>Invite colleagues who should have early access.</p>

                    <div class="list-stack">
                        <div class="list-row" *ngFor="let row of invites(); let i = index">
                            <mb-form-field label="Email" [controlId]="'invite-email-' + i"
                                [error]="inviteEmailError(row)">
                                <mb-input [id]="'invite-email-' + i" [value]="row.email"
                                    (valueChange)="updateInviteRow(i, 'email', $event)"></mb-input>
                            </mb-form-field>

                            <mb-form-field label="Role" [controlId]="'invite-role-' + i">
                                <mb-select [id]="'invite-role-' + i" [value]="row.role"
                                    (valueChange)="updateInviteRow(i, 'role', $event)">
                                    <option value="Administrator">Administrator</option>
                                    <option value="Teacher">Teacher</option>
                                    <option value="Staff">Staff</option>
                                </mb-select>
                            </mb-form-field>

                            <button type="button" class="list-remove" *ngIf="invites().length > 1"
                                (click)="removeInviteRow(i)">Remove</button>
                        </div>
                    </div>

                    <button type="button" class="list-add" (click)="addInviteRow()">Add another user</button>
                </div>

                <div class="setup-footer">
                    <div class="setup-footer__actions">
                        <mb-button variant="secondary" (click)="back()">Back</mb-button>
                        <mb-button variant="primary" [disabled]="!canContinue()" (click)="next()">Continue</mb-button>
                    </div>
                    <div class="setup-footer__aside">
                        <button type="button" class="setup-skip-link" (click)="skipSetup()">Skip for now</button>
                    </div>
                </div>
                <div class="setup-auto-save"><span aria-hidden="true">✓</span> Configuration changes are saved automatically.</div>
            </div>

            <div class="setup-body" *ngIf="step() === 8">
                <div class="setup-section">
                    <h2>Review and activate</h2>
                    <p>Confirm these details before finishing setup.</p>

                    <div class="review-grid">
                        <div class="review-card">
                            <div class="review-title">Schools</div>
                            <div class="review-value">{{ schoolRows().length }} school(s)</div>
                            <ul>
                                <li *ngFor="let row of schoolRows()">{{ row.name }}</li>
                            </ul>
                            <button type="button" class="review-link" (click)="goToStep(1)">Edit</button>
                        </div>
                        <div class="review-card">
                            <div class="review-title">Academic levels</div>
                            <div class="review-value">{{ levels().length }} levels</div>
                            <button type="button" class="review-link" (click)="goToStep(4)">Edit</button>
                        </div>
                        <div class="review-card">
                            <div class="review-title">Grading model</div>
                            <div class="review-value">{{ gradingModel() | titlecase }}</div>
                            <button type="button" class="review-link" (click)="goToStep(6)">Edit</button>
                        </div>
                        <div class="review-card">
                            <div class="review-title">Invitations</div>
                            <div class="review-value">{{ inviteCount() }} invite(s)</div>
                            <button type="button" class="review-link" (click)="goToStep(7)">Edit</button>
                        </div>
                    </div>
                </div>

                <div class="setup-actions">
                    <mb-button variant="secondary" (click)="back()">Back</mb-button>
                    <mb-button variant="primary" [loading]="isSaving()" (click)="next()">Finish setup</mb-button>
                </div>
            </div>

                    </mb-card>
                </div>
            </div>

            <div class="setup-body" *ngIf="step() === 9">
                <div class="setup-section setup-complete">
                    <h2>Workspace ready</h2>
                    <p>Your workspace is configured. You can continue in the dashboard or update details later.</p>
                </div>
                <div class="setup-actions">
                    <mb-button variant="primary" (click)="finish()">Go to dashboard</mb-button>
                </div>
            </div>
        </ng-container>
    </mb-card>
</div>
