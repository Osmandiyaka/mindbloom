<div class="setup-body">
    <div class="setup-section">
        <div class="users-header">
            <div>
                <h2>Users</h2>
                <p>Add users who will access the workspace. You can invite now and assign roles
                    later.</p>

            </div>
        </div>
        <input #csvInput type="file" class="users-csv-input" accept=".csv"
            (change)="vm.handleCsvImport($event)" />

        <div class="users-utility" *ngIf="vm.store.users().length">
            <mb-form-field *ngIf="vm.store.users().length >= 5" label="Search"
                [controlId]="'user-search'">
                <mb-input id="user-search" [value]="vm.store.userSearch()"
                    [placeholder]="'Search by name or email'"
                    (valueChange)="vm.store.setSearch($event)"></mb-input>
            </mb-form-field>
            <div class="users-utility__actions">
                <mb-split-button label="Add users" variant="primary" size="md"
                    [items]="vm.addUsersMenuItems()" (primaryClick)="vm.openInviteModal()"
                    (itemSelect)="vm.handleAddUsersAction($event, csvInput)"></mb-split-button>
            </div>
        </div>

        <div class="users-table-wrap" *ngIf="vm.store.users().length; else emptyUsers">
            <mb-table class="users-table" [columns]="vm.userTableColumns" [rows]="vm.store.filteredUsers()"
                (cellClick)="vm.handleUserCellClick($event)">
                <ng-template mbTableActions let-row>
                    <div class="users-table__actions">
                        <button type="button" class="users-menu__toggle" #userMenuOrigin
                            aria-label="Actions"
                            [attr.aria-expanded]="vm.userMenuOpenId() === vm.userMenuKey(row)"
                            (click)="vm.toggleUserMenu(vm.userMenuKey(row), $event)">⋯</button>
                        <mb-popover [open]="vm.userMenuOpenId() === vm.userMenuKey(row)"
                            [origin]="userMenuOrigin" [hasBackdrop]="true"
                            [panelClass]="['mb-popover-panel', 'mb-popover-panel--above-modal', 'users-menu__panel']"
                            (closed)="vm.closeUserMenu()">
                            <div class="users-menu__panel-content" role="menu">
                                <button type="button" class="users-menu__item"
                                    (click)="row.kind === 'existing' && vm.openEditUser(row); vm.closeUserMenu()">
                                    Edit details
                                </button>
                                <button type="button" class="users-menu__item"
                                    *ngIf="row.status === 'invited'"
                                    (click)="vm.resendInvite(row); vm.closeUserMenu()">
                                    Resend invite
                                </button>
                                <button type="button" class="users-menu__item"
                                    *ngIf="row.status !== 'invited'"
                                    (click)="vm.toggleUserStatus(row); vm.closeUserMenu()">
                                    {{ row.status === 'suspended' ? 'Activate user' : 'Suspend
                                    user' }}
                                </button>
                                <button type="button"
                                    class="users-menu__item users-menu__item--danger"
                                    (click)="vm.removeUser(row); vm.closeUserMenu()">
                                    Remove
                                </button>
                            </div>
                        </mb-popover>
                    </div>
                </ng-template>
            </mb-table>

        </div>
        <ng-template #emptyUsers>
            <div class="users-empty">
                <div class="users-empty__icon" aria-hidden="true">
                    <svg viewBox="0 0 48 48" fill="none">
                        <circle cx="24" cy="16" r="8" stroke="currentColor" stroke-width="2">
                        </circle>
                        <path d="M10 40c0-7.2 6.3-13 14-13s14 5.8 14 13" stroke="currentColor"
                            stroke-width="2" stroke-linecap="round"></path>
                    </svg>
                </div>
                <div class="users-empty__title">No users yet</div>
                <div class="users-empty__text">
                    Add users to give your team access to the workspace.
                </div>
                <div class="users-empty__actions">
                    <mb-split-button label="Add users" variant="primary" size="md"
                        [items]="vm.addUsersMenuItems()" (primaryClick)="vm.openInviteModal()"
                        (itemSelect)="vm.handleAddUsersAction($event, csvInput)"></mb-split-button>
                </div>
            </div>
        </ng-template>
    </div>

    <div class="setup-footer">
        <div class="setup-footer__actions">
            <mb-button variant="secondary" (click)="back()">Back</mb-button>
            <mb-button variant="primary" [disabled]="!vm.canContinueUsersStep()"
                (click)="next()">Continue</mb-button>
        </div>
        <div class="setup-footer__aside">
            <button type="button" class="setup-skip-link" (click)="skipUsersStep()">Skip for
                now</button>
            <div class="setup-footer__hint">You can continue setup without adding users.</div>
            <div class="setup-footer__hint">You can resume later from Settings → Workspace
                setup.</div>
        </div>
    </div>
    <div class="setup-auto-save"><span aria-hidden="true">✓</span> Configuration changes are
        saved automatically.</div>

    <app-invite-users-modal
        [isOpen]="vm.isInviteModalOpen()"
        [existingEmails]="vm.existingEmails()"
        [requestState]="vm.store.inviteUsersState()"
        (closed)="vm.closeInviteModal()"
        (submitted)="vm.handleInviteSubmitted($event)">
    </app-invite-users-modal>

    <app-edit-user-modal
        [isOpen]="vm.isEditUserModalOpen()"
        [payload]="vm.editPayload()"
        [requestState]="vm.store.updateUserState()"
        (closed)="vm.closeEditUser()"
        (submitted)="vm.handleEditSubmitted($event)">
    </app-edit-user-modal>

    <app-view-user-drawer
        [isOpen]="vm.isViewUserModalOpen()"
        [user]="vm.selectedUser()"
        (closed)="vm.closeViewUser()"
        (edit)="vm.openEditUser($event); vm.closeViewUser()">
    </app-view-user-drawer>

    <app-create-user-modal
        [isOpen]="vm.isCreateUserModalOpen()"
        [existingEmails]="vm.existingEmails()"
        [requestState]="vm.store.createUserState()"
        (closed)="vm.closeCreateUserModal()"
        (submitted)="vm.handleCreateSubmitted($event)">
    </app-create-user-modal>

    <mb-modal
        [open]="vm.isDeleteConfirmOpen()"
        title="Remove user?"
        size="sm"
        (closed)="vm.cancelDelete()">
        <div class="users-confirm">
            <div class="users-confirm__title">This user will lose access immediately.</div>
            <div class="users-confirm__text">This action cannot be undone.</div>
        </div>
        <div mbModalFooter class="users-confirm__footer">
            <mb-button variant="secondary" (click)="vm.cancelDelete()">Cancel</mb-button>
            <mb-button variant="danger" (click)="vm.confirmDelete()"
                [disabled]="vm.store.deleteUserState().status === 'loading'">
                {{ vm.store.deleteUserState().status === 'loading' ? 'Removing...' : 'Remove user' }}
            </mb-button>
        </div>
    </mb-modal>
</div>
