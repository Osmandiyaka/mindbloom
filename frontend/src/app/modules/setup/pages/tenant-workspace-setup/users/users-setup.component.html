<div class="setup-body">
    <div class="setup-section">
        <div class="users-header users-header-card">
            <div class="users-header__row users-header__row--title">
                <div class="users-header__left">
                    <h2>Users</h2>
                    <p>Add users who will access the workspace. You can invite now and assign roles
                        later.</p>
                </div>
                <div class="users-header__right">
                    <mb-button variant="secondary" size="sm">Export</mb-button>
                    <mb-split-button label="Add users" variant="primary" size="md"
                        [items]="vm.addUsersMenuItems()" (primaryClick)="vm.openInviteModal()"
                        (itemSelect)="vm.handleAddUsersAction($event, csvInput)"></mb-split-button>
                </div>
            </div>
            <div class="users-header__row users-header__row--filters">
                <div class="users-header__search-row">
                    <app-search-input
                        class="users-header__search"
                        [value]="vm.store.userSearch()"
                        [debounceMs]="300"
                        placeholder="Search by name, email, or role…"
                        (search)="vm.store.setSearch($event)"
                    ></app-search-input>
                </div>
                <div class="users-header__right users-header__right--tools">
                    <div class="users-density">
                        <button type="button" class="users-density__button"
                            [class.is-active]="vm.density() === 'comfortable'"
                            (click)="vm.changeDensity('comfortable')">Comfortable</button>
                        <button type="button" class="users-density__button"
                            [class.is-active]="vm.density() === 'compact'"
                            (click)="vm.changeDensity('compact')">Compact</button>
                    </div>
                    <button type="button" class="users-columns__toggle" #columnsOrigin
                        (click)="vm.toggleColumnsMenu()">☰ Columns</button>
                    <mb-popover [open]="vm.columnsMenuOpen()" [origin]="columnsOrigin" [hasBackdrop]="true"
                        [panelClass]="['mb-popover-panel', 'mb-popover-panel--above-modal', 'users-columns__panel']"
                        (closed)="vm.closeColumnsMenu()">
                        <div class="users-columns__panel-body">
                            <label class="users-columns__item" *ngFor="let column of vm.userTableColumns">
                                <input type="checkbox"
                                    [checked]="vm.visibleColumnKeys().includes(column.key.toString())"
                                    (change)="vm.toggleColumn(column.key.toString())" />
                                {{ column.label }}
                            </label>
                        </div>
                    </mb-popover>
                    <mb-select [value]="vm.rowsPerPage().toString()" (valueChange)="vm.changeRowsPerPage($event)">
                        <option value="10">10 rows</option>
                        <option value="20">20 rows</option>
                        <option value="50">50 rows</option>
                    </mb-select>
                </div>
            </div>
        </div>
        <input #csvInput type="file" class="users-csv-input" accept=".csv"
            (change)="vm.handleCsvImport($event)" />

        <div class="users-bulk" *ngIf="vm.selectedCount()">
            <div class="users-bulk__left">{{ vm.selectedCount() }} selected</div>
            <div class="users-bulk__actions">
                <mb-button size="sm" variant="tertiary" (click)="vm.openBulkRole()">Assign role</mb-button>
                <mb-button size="sm" variant="tertiary" (click)="vm.openBulkAccess()">Change school access</mb-button>
                <mb-button size="sm" variant="tertiary" (click)="vm.openBulkConfirm('suspend')">Suspend</mb-button>
                <mb-button size="sm" variant="danger" (click)="vm.openBulkConfirm('remove')">Remove</mb-button>
            </div>
            <mb-button size="sm" variant="secondary" (click)="vm.clearSelection()">Clear selection</mb-button>
        </div>

        <div class="users-table-wrap">
            <mb-table class="users-table"
                [columns]="vm.visibleColumns()"
                [rows]="vm.pagedRows()"
                [rowKey]="vm.rowKey"
                [selectable]="true"
                [density]="vm.density()"
                [sortLocal]="true"
                [emptyState]="vm.tableEmptyState()"
                [isFiltered]="vm.isFiltered()"
                (rowClick)="vm.handleRowClick($event)"
                (selectionChange)="vm.handleSelectionChange($event)"
                (emptyAction)="vm.handleEmptyAction($event, csvInput)">
                <ng-template mbTableActions let-row>
                    <div class="users-table__actions">
                        <button type="button" class="users-menu__toggle" #userMenuOrigin
                            aria-label="Actions"
                            [attr.aria-expanded]="vm.userMenuOpenId() === vm.userMenuKey(row)"
                            (click)="vm.toggleUserMenu(vm.userMenuKey(row), $event)">⋯</button>
                        <mb-popover [open]="vm.userMenuOpenId() === vm.userMenuKey(row)"
                            [origin]="userMenuOrigin" [hasBackdrop]="true"
                            [panelClass]="['mb-popover-panel', 'mb-popover-panel--above-modal', 'users-menu__panel']"
                            (closed)="vm.closeUserMenu()">
                            <div class="users-menu__panel-content" role="menu">
                                <button type="button" class="users-menu__item"
                                    *ngIf="row.source.kind === 'existing'"
                                    (click)="vm.openEditUser(row.source); vm.closeUserMenu()">
                                    Edit details
                                </button>
                                <button type="button" class="users-menu__item"
                                    *ngIf="row.source.kind === 'existing' && row.source.status === 'invited'"
                                    (click)="vm.resendInvite(row.source); vm.closeUserMenu()">
                                    Resend invite
                                </button>
                                <button type="button" class="users-menu__item"
                                    *ngIf="row.source.kind === 'existing' && row.source.status === 'active'"
                                    (click)="vm.openEditUser(row.source); vm.closeUserMenu()">
                                    Manage access
                                </button>
                                <button type="button" class="users-menu__item"
                                    *ngIf="row.source.kind === 'existing' && row.source.status === 'active'"
                                    (click)="vm.sendPasswordReset(row.source); vm.closeUserMenu()">
                                    Send password reset
                                </button>
                                <button type="button" class="users-menu__item"
                                    *ngIf="row.source.kind === 'existing' && row.source.status === 'active'"
                                    (click)="vm.toggleUserStatus(row.source, 'suspended'); vm.closeUserMenu()">
                                    Suspend user
                                </button>
                                <button type="button" class="users-menu__item"
                                    *ngIf="row.source.kind === 'existing' && row.source.status === 'suspended'"
                                    (click)="vm.toggleUserStatus(row.source, 'active'); vm.closeUserMenu()">
                                    Re-activate user
                                </button>
                                <button type="button" class="users-menu__item users-menu__item--danger"
                                    *ngIf="row.source.kind === 'existing' && row.source.status === 'invited'"
                                    (click)="vm.removeUser(row.source); vm.closeUserMenu()">
                                    Cancel invite
                                </button>
                                <button type="button"
                                    class="users-menu__item users-menu__item--danger"
                                    *ngIf="row.source.status !== 'invited' || row.source.kind === 'pendingInvite'"
                                    (click)="vm.removeUser(row.source); vm.closeUserMenu()">
                                    Remove
                                </button>
                            </div>
                        </mb-popover>
                    </div>
                </ng-template>
            </mb-table>
        </div>

        <div class="users-table-footer" *ngIf="vm.directoryRows().length">
            <div class="users-table-footer__summary">{{ vm.tableSummary() }}</div>
            <div class="users-table-footer__paging">
                <mb-button size="sm" variant="tertiary" [disabled]="vm.pageIndex() === 1"
                    (click)="vm.prevPage()">Prev</mb-button>
                <span>Page {{ vm.pageIndex() }} of {{ vm.pageCount() }}</span>
                <mb-button size="sm" variant="tertiary" [disabled]="vm.pageIndex() === vm.pageCount()"
                    (click)="vm.nextPage()">Next</mb-button>
            </div>
        </div>
    </div>

    <app-invite-users-modal
        [isOpen]="vm.isInviteModalOpen()"
        [existingEmails]="vm.existingEmails()"
        [requestState]="vm.store.inviteUsersState()"
        (closed)="vm.closeInviteModal()"
        (submitted)="vm.handleInviteSubmitted($event)">
    </app-invite-users-modal>

    <app-view-user-drawer
        [isOpen]="vm.isViewUserModalOpen()"
        [user]="vm.selectedUser()"
        (closed)="vm.closeViewUser()"
        (edit)="vm.openEditUser($event); vm.closeViewUser()">
    </app-view-user-drawer>

    <app-create-user-modal
        [isOpen]="vm.isCreateUserModalOpen()"
        [mode]="vm.editUserId() ? 'edit' : 'create'"
        [preset]="vm.editPreset()"
        [existingEmails]="vm.existingEmails()"
        [requestState]="vm.editUserId() ? vm.store.updateUserState() : vm.store.createUserState()"
        (closed)="vm.closeCreateUserModal()"
        (submitted)="vm.handleCreateSubmitted($event)">
    </app-create-user-modal>

    <mb-modal
        [open]="vm.isDeleteConfirmOpen()"
        title="Remove user?"
        size="sm"
        (closed)="vm.cancelDelete()">
        <div class="users-confirm">
            <div class="users-confirm__title">This user will lose access immediately.</div>
            <div class="users-confirm__text">This action cannot be undone.</div>
        </div>
        <div mbModalFooter class="users-confirm__footer">
            <mb-button variant="secondary" (click)="vm.cancelDelete()">Cancel</mb-button>
            <mb-button variant="danger" (click)="vm.confirmDelete()"
                [disabled]="vm.store.deleteUserState().status === 'loading'">
                {{ vm.store.deleteUserState().status === 'loading' ? 'Removing...' : 'Remove user' }}
            </mb-button>
        </div>
    </mb-modal>

    <mb-modal
        [open]="vm.isSuspendConfirmOpen()"
        title="Suspend user?"
        size="sm"
        (closed)="vm.cancelSuspend()">
        <div class="users-confirm">
            <div class="users-confirm__title">This user will lose access immediately.</div>
            <div class="users-confirm__text">You can reactivate them at any time.</div>
        </div>
        <div mbModalFooter class="users-confirm__footer">
            <mb-button variant="secondary" (click)="vm.cancelSuspend()">Cancel</mb-button>
            <mb-button variant="danger" (click)="vm.confirmSuspend()">
                Suspend user
            </mb-button>
        </div>
    </mb-modal>

    <mb-modal
        [open]="vm.bulkRoleOpen()"
        title="Assign role"
        size="md"
        (closed)="vm.closeBulkRole()">
        <div class="users-bulk-modal">
            <div class="users-bulk-modal__title">Apply roles to selected users.</div>
            <mb-role-selector [label]="''" [multiple]="true" [value]="vm.bulkRoleIds()"
                placeholder="Select roles..." (change)="vm.bulkRoleIds.set($event.ids)">
            </mb-role-selector>
        </div>
        <div mbModalFooter class="users-confirm__footer">
            <mb-button variant="secondary" (click)="vm.closeBulkRole()">Cancel</mb-button>
            <mb-button variant="primary" (click)="vm.confirmBulkRole()">Apply roles</mb-button>
        </div>
    </mb-modal>

    <mb-modal
        [open]="vm.bulkAccessOpen()"
        title="Change school access"
        size="md"
        (closed)="vm.closeBulkAccess()">
        <div class="users-bulk-modal">
            <div class="users-bulk-modal__title">Update school access for selected users.</div>
            <div class="users-bulk-access__toggle">
                <button type="button" [class.is-active]="vm.bulkSchoolScope() === 'all'"
                    (click)="vm.bulkSchoolScope.set('all')">All schools</button>
                <button type="button" [class.is-active]="vm.bulkSchoolScope() === 'selected'"
                    (click)="vm.bulkSchoolScope.set('selected')">Selected schools</button>
            </div>
            <mb-school-selector *ngIf="vm.bulkSchoolScope() === 'selected'" [label]="''"
                [value]="vm.bulkSchoolIds()" (valueChange)="vm.bulkSchoolIds.set($event)">
            </mb-school-selector>
        </div>
        <div mbModalFooter class="users-confirm__footer">
            <mb-button variant="secondary" (click)="vm.closeBulkAccess()">Cancel</mb-button>
            <mb-button variant="primary" (click)="vm.confirmBulkAccess()">Apply access</mb-button>
        </div>
    </mb-modal>

    <mb-modal
        [open]="vm.bulkConfirmOpen() === 'suspend'"
        title="Suspend selected users?"
        size="sm"
        (closed)="vm.closeBulkConfirm()">
        <div class="users-confirm">
            <div class="users-confirm__title">Selected users will lose access immediately.</div>
            <div class="users-confirm__text">You can reactivate them at any time.</div>
        </div>
        <div mbModalFooter class="users-confirm__footer">
            <mb-button variant="secondary" (click)="vm.closeBulkConfirm()">Cancel</mb-button>
            <mb-button variant="danger" (click)="vm.confirmBulkSuspend()">Suspend users</mb-button>
        </div>
    </mb-modal>

    <mb-modal
        [open]="vm.bulkConfirmOpen() === 'remove'"
        title="Remove selected users?"
        size="sm"
        (closed)="vm.closeBulkConfirm()">
        <div class="users-confirm">
            <div class="users-confirm__title">This action cannot be undone.</div>
            <div class="users-confirm__text">Selected users will lose access immediately.</div>
        </div>
        <div mbModalFooter class="users-confirm__footer">
            <mb-button variant="secondary" (click)="vm.closeBulkConfirm()">Cancel</mb-button>
            <mb-button variant="danger" (click)="vm.confirmBulkRemove()">Remove users</mb-button>
        </div>
    </mb-modal>
</div>
