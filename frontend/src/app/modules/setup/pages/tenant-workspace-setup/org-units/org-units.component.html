<div class="setup-body">
    <div class="setup-section">
        <div class="ou-header">
            <div>
                <h2>Organizational units</h2>
                <p>Build a hierarchy of schools, divisions, and departments for access and reporting.</p>
            </div>
            <div class="ou-header__actions">
                <mb-button class="ou-action-btn" variant="secondary" (click)="vm.startAddChildUnit()">
                    Add child unit
                </mb-button>
                <button
                    type="button"
                    class="ou-actions-menu__toggle"
                    #ouActionsMenuOrigin
                    aria-label="More actions"
                    title="More actions"
                    [attr.aria-expanded]="vm.ouActionsMenuOpen()"
                    (click)="vm.toggleOuActionsMenu($event)"
                >⋯</button>
                <mb-popover
                    [open]="vm.ouActionsMenuOpen()"
                    [origin]="ouActionsMenuOrigin"
                    [hasBackdrop]="true"
                    [panelClass]="['mb-popover-panel', 'mb-popover-panel--above-modal', 'ou-actions-menu__panel']"
                    (closed)="vm.closeOuActionsMenu()"
                >
                    <div class="ou-actions-menu__panel-content" role="menu">
                        <button type="button" class="ou-actions-menu__item" (click)="vm.closeOuActionsMenu(); vm.startAddChildUnit()">
                            Add child unit
                        </button>
                        <button type="button" class="ou-actions-menu__item" (click)="vm.closeOuActionsMenu(); vm.startAddRootUnit()">
                            Add root unit
                        </button>
                        <div class="ou-actions-menu__divider" aria-hidden="true"></div>
                        <button type="button" class="ou-actions-menu__item"
                            [disabled]="!vm.selectedOrgUnit()" (click)="vm.closeOuActionsMenu(); vm.openRenameOrgUnit()">
                            Rename unit
                        </button>
                        <button type="button" class="ou-actions-menu__item"
                            [disabled]="!vm.selectedOrgUnit()" (click)="vm.closeOuActionsMenu(); vm.openMoveOrgUnit()">
                            Move unit
                        </button>
                        <button type="button" class="ou-actions-menu__item"
                            [disabled]="!vm.selectedOrgUnit()" (click)="vm.closeOuActionsMenu(); vm.openChangeParentOrgUnit()">
                            Change parent
                        </button>
                        <div class="ou-actions-menu__divider" aria-hidden="true"></div>
                        <button type="button" class="ou-actions-menu__item"
                            [disabled]="!vm.canDeactivateSelectedOrgUnit()"
                            (click)="vm.closeOuActionsMenu(); vm.openDeactivateOrgUnit()">
                            Deactivate unit
                        </button>
                        <button type="button" class="ou-actions-menu__item ou-actions-menu__item--danger"
                            [disabled]="!vm.canDeleteSelectedOrgUnit()"
                            (click)="vm.closeOuActionsMenu(); vm.openDeleteOrgUnit()">
                            Delete unit
                        </button>
                    </div>
                </mb-popover>
            </div>
        </div>

        <div class="ou-card">
            <div class="ou-layout">
            <div class="ou-nav">
                <div class="ou-nav__header">
                    <div class="ou-nav__kicker">Organization</div>
                    <div class="ou-nav__title-row">
                        <div class="ou-nav__title">Units</div>
                        <mb-button class="ou-nav__add" variant="tertiary"
                            (click)="vm.startAddRootUnit()">
                            <span class="ou-nav__add-icon" aria-hidden="true">+</span>
                            <span>Add root unit</span>
                        </mb-button>
                    </div>
                </div>

                <ng-container *ngIf="vm.orgUnitTree().length; else ouEmptyTree">
                    <div class="ou-tree" role="tree">
                        <ng-container *ngFor="let node of vm.orgUnitTree(); trackBy: vm.trackOrgUnit">
                            <ng-container
                                *ngTemplateOutlet="orgUnitNode; context: { $implicit: node, depth: 0 }"></ng-container>
                        </ng-container>
                    </div>
                </ng-container>
                <ng-template #ouEmptyTree>
                    <div class="ou-empty">
                        <div class="ou-empty__title">No organizational units yet</div>
                        <div class="ou-empty__text">Create a root unit to start building your
                            hierarchy.</div>
                    </div>
                </ng-template>
            </div>

            <div class="ou-canvas">
                <ng-container *ngIf="vm.selectedOrgUnit(); else ouEmptyDetail">
                    <div class="ou-canvas__header">
                        <div class="ou-canvas__details">
                            <div class="ou-canvas__name" [attr.title]="vm.selectedOrgUnit()!.name">
                                {{ vm.selectedOrgUnit()!.name }}
                            </div>
                            <div class="ou-canvas__meta">{{ vm.selectedOrgUnit()!.type }} ·
                                {{ vm.selectedOrgUnit()!.status }}</div>
                            <div class="ou-breadcrumb">
                                Organization / {{ vm.selectedOrgUnitPath() }}
                            </div>
                        </div>
                    </div>

                    <div class="ou-tabs" role="tablist">
                        <button type="button" class="ou-tab"
                            [class.is-active]="vm.activeOrgUnitTab() === 'members'" role="tab"
                            [attr.aria-selected]="vm.activeOrgUnitTab() === 'members'"
                            (click)="vm.setOrgUnitTab('members')">
                            Members <span class="ou-tab__count">({{ vm.selectedOrgUnitMemberCount() }})</span>
                        </button>
                        <button type="button" class="ou-tab"
                            [class.is-active]="vm.activeOrgUnitTab() === 'roles'" role="tab"
                            [attr.aria-selected]="vm.activeOrgUnitTab() === 'roles'"
                            (click)="vm.setOrgUnitTab('roles')">
                            Roles <span class="ou-tab__count">({{ vm.selectedOrgUnitRoleCount() }})</span>
                        </button>
                    </div>

                    <div *ngIf="vm.activeOrgUnitTab() === 'members'" class="ou-members">
                        <div class="ou-toolbar">
                            <div class="ou-search">
                                <mb-input [value]="vm.orgUnitMemberSearch()"
                                    (valueChange)="vm.orgUnitMemberSearch.set($event)"
                                    placeholder="Search members..."></mb-input>
                            </div>
                            <mb-button class="ou-action-btn" variant="secondary"
                                [disabled]="!vm.canCopyFromParent()"
                                [attr.title]="vm.canCopyFromParent() ? null : 'Select a child unit to copy from its parent.'"
                                (click)="vm.copyMembersFromParent()">Copy from parent</mb-button>
                            <mb-button class="ou-action-btn" variant="primary"
                                [disabled]="!vm.users().length" (click)="vm.openAssignMembers()">Add
                                members</mb-button>
                        </div>
                        <div class="ou-toolbar__hint">
                            Members assigned here inherit this unit’s access.
                        </div>

                        <div class="ou-assign" *ngIf="vm.assignMembersOpen()">
                            <div class="ou-assign__title">Assign members</div>
                            <div class="ou-assign__selector">
                                <mb-staff-selector [value]="vm.assignMemberSelection()"
                                    [options]="vm.staffSelectorOptions()"
                                    [disabled]="!vm.users().length"
                                    placeholder="Select staff..."
                                    (valueChange)="vm.addAssignMember($event)">
                                </mb-staff-selector>
                            </div>
                            <div class="ou-assign__list"
                                *ngIf="vm.assignMemberRows().length; else ouAssignEmpty">
                                <div class="ou-assign__member"
                                    *ngFor="let member of vm.assignMemberRows(); trackBy: vm.trackAssignMember">
                                    <div class="ou-assign__member-text">
                                        <span class="ou-assign__name">{{ member.name }}</span>
                                        <span class="ou-assign__meta">{{ member.email }}</span>
                                    </div>
                                    <button type="button" class="ou-row-action ou-row-action--subtle"
                                        (click)="vm.removeAssignMember(member.id)">
                                        Remove
                                    </button>
                                </div>
                            </div>
                            <ng-template #ouAssignEmpty>
                                <div class="ou-assign__empty">Add staff in the previous step to
                                    assign
                                    them here.</div>
                            </ng-template>
                            <div class="ou-assign__actions">
                                <mb-button variant="secondary"
                                    (click)="vm.cancelAssignMembers()">Cancel</mb-button>
                                <mb-button variant="primary"
                                    (click)="vm.saveAssignMembers()">Save</mb-button>
                            </div>
                        </div>

                        <app-org-unit-members-table
                            [orgUnitId]="vm.activeOrgUnitId()"
                            [searchTerm]="vm.orgUnitMemberSearch()"
                            (clearSearch)="vm.orgUnitMemberSearch.set('')"
                            (addMembers)="vm.openAssignMembers()">
                        </app-org-unit-members-table>
                    </div>

                    <div *ngIf="vm.activeOrgUnitTab() === 'roles'" class="ou-roles">
                        <div class="ou-toolbar">
                            <div class="ou-search">
                                <mb-input [value]="vm.orgUnitRoleSearch()"
                                    (valueChange)="vm.orgUnitRoleSearch.set($event)"
                                    placeholder="Search roles..."></mb-input>
                            </div>
                            <mb-button class="ou-action-btn" variant="secondary"
                                [disabled]="!vm.canCopyFromParent()"
                                [attr.title]="vm.canCopyFromParent() ? null : 'Select a child unit to copy from its parent.'"
                                (click)="vm.copyRolesFromParent()">Copy from parent</mb-button>
                            <mb-button class="ou-action-btn" variant="primary"
                                (click)="vm.openAssignRoles()">Add roles</mb-button>
                        </div>

                        <div class="ou-assign" *ngIf="vm.assignRolesOpen()">
                            <div class="ou-assign__title">Assign roles</div>
                            <div class="ou-assign__selector">
                                <mb-role-selector [value]="vm.assignRoleIds()" label=""
                                    placeholder="Select roles..."
                                    (change)="vm.handleAssignRoleChange($event)">
                                </mb-role-selector>
                            </div>
                            <div class="ou-assign__actions">
                                <mb-button variant="secondary"
                                    (click)="vm.cancelAssignRoles()">Cancel</mb-button>
                                <mb-button variant="primary"
                                    (click)="vm.saveAssignRoles()">Save</mb-button>
                            </div>
                        </div>

                        <app-org-unit-roles-table
                            [orgUnitId]="vm.activeOrgUnitId()"
                            [searchTerm]="vm.orgUnitRoleSearch()"
                            (clearSearch)="vm.orgUnitRoleSearch.set('')"
                            (assignRoles)="vm.openAssignRoles()">
                        </app-org-unit-roles-table>
                        <div class="ou-helper">
                            Roles assigned here inherit to child units. Add overrides at
                            specific
                            units when needed.
                        </div>
                    </div>
                </ng-container>

                <ng-template #ouEmptyDetail>
                    <div class="ou-empty ou-empty--detail">
                        <div class="ou-empty__title">Select an organizational unit</div>
                        <div class="ou-empty__text">Choose a unit from the tree to manage
                            members
                            and roles.</div>
                    </div>
                </ng-template>
            </div>
        </div>

        <ng-template #orgUnitNode let-node let-depth="depth">
            <button type="button" class="ou-tree__node" [style.--ou-depth]="depth"
                [class.ou-tree__node--child]="depth > 0"
                [class.is-active]="vm.activeOrgUnitId() === node.id" role="treeitem"
                [attr.aria-expanded]="node.children.length ? vm.isOrgUnitExpanded(node.id) : null"
                (click)="vm.selectOrgUnit(node.id)">
                <span class="ou-tree__caret" *ngIf="node.children.length"
                    (click)="vm.toggleOrgUnitExpanded(node.id); $event.stopPropagation()">
                    {{ vm.isOrgUnitExpanded(node.id) ? '▾' : '▸' }}
                </span>
                <span class="ou-tree__spacer" *ngIf="!node.children.length"></span>
                <span class="ou-tree__indent"
                    *ngIf="depth > 0 && !node.children.length">›</span>
                <span class="ou-tree__label" [attr.title]="node.name">{{ node.name }}</span>
                <span class="ou-tree__badge" *ngIf="node.children.length">
                    {{ node.children.length }}
                </span>
            </button>
            <div class="ou-tree__children" role="group"
                *ngIf="node.children.length && vm.isOrgUnitExpanded(node.id)">
                <ng-container *ngFor="let child of node.children; trackBy: vm.trackOrgUnit">
                    <ng-container
                        *ngTemplateOutlet="orgUnitNode; context: { $implicit: child, depth: depth + 1 }"></ng-container>
                </ng-container>
            </div>
        </ng-template>

        <mb-modal [open]="vm.orgUnitFormOpen()" title="Add organizational unit" size="md"
            [hasFooter]="true" (closed)="vm.requestCloseOrgUnitForm()">
            <div class="ou-modal">
                <div class="ou-modal__subtitle"
                    *ngIf="vm.orgUnitFormParentId(); else ouRootSubtitle">
                    Create a child unit under {{ vm.selectedOrgUnit()?.name || 'Selected unit' }}.
                </div>
                <ng-template #ouRootSubtitle>
                    <div class="ou-modal__subtitle">Create a new root unit for your
                        organization.</div>
                </ng-template>

                <div class="ou-modal__section">
                    <div class="ou-modal__section-label">Parent unit</div>
                    <div class="ou-modal__context-value">
                        {{ vm.selectedOrgUnit()?.name || 'Organization' }}
                    </div>
                </div>

                <div class="ou-modal__section">
                    <div class="ou-modal__section-label">Identity</div>
                    <div class="ou-modal__fields">
                        <mb-form-field label="Unit name" [controlId]="'org-unit-name'">
                            <mb-input id="org-unit-name" [value]="vm.orgUnitFormName()"
                                (valueChange)="vm.orgUnitFormName.set($event)">
                            </mb-input>
                        </mb-form-field>
                        <mb-form-field label="Unit type" [controlId]="'org-unit-type'">
                            <mb-select id="org-unit-type" [value]="vm.orgUnitFormType()"
                                (valueChange)="vm.setOrgUnitFormType($event)">
                                <option *ngFor="let type of vm.orgUnitTypes" [value]="type">
                                    {{ type }}
                                </option>
                            </mb-select>
                        </mb-form-field>
                    </div>
                    <div class="ou-modal__helper">Used for access control and reporting.</div>
                </div>

                <div class="ou-modal__section">
                    <div class="ou-modal__section-label">Status</div>
                    <div class="ou-modal__radios">
                        <label class="ou-modal__radio">
                            <input type="radio" name="org-unit-status" value="Active"
                                [checked]="vm.orgUnitFormStatus() === 'Active'"
                                (change)="vm.orgUnitFormStatus.set('Active')" />
                            <span>Active</span>
                        </label>
                        <label class="ou-modal__radio">
                            <input type="radio" name="org-unit-status" value="Inactive"
                                [checked]="vm.orgUnitFormStatus() === 'Inactive'"
                                (change)="vm.orgUnitFormStatus.set('Inactive')" />
                            <span>Inactive</span>
                        </label>
                    </div>
                </div>

                <div class="ou-form__error" *ngIf="vm.orgUnitFormError()">
                    {{ vm.orgUnitFormError() }}
                </div>
            </div>

            <div mbModalFooter class="ou-modal__footer">
                <mb-button variant="secondary"
                    (click)="vm.requestCloseOrgUnitForm()">Cancel</mb-button>
                <mb-button variant="primary" (click)="vm.saveOrgUnitForm()"
                    [loading]="vm.orgUnitFormSubmitting()"
                    [disabled]="!vm.orgUnitFormName().trim() || vm.orgUnitFormSubmitting()">
                    Create unit
                </mb-button>
            </div>
        </mb-modal>

        <mb-modal [open]="vm.isOrgUnitDeleteOpen()" title="Delete organizational unit" size="sm"
            [hasFooter]="true" [closeable]="!vm.orgUnitDeleteSubmitting()"
            [closeOnBackdrop]="!vm.orgUnitDeleteSubmitting()"
            (closed)="vm.requestCloseDeleteOrgUnit()">
            <div class="ou-delete">
                <div class="ou-delete__subtitle">
                    This action will permanently delete this unit and all of its child units.
                </div>
                <mb-alert *ngIf="vm.orgUnitDeleteError()" variant="danger">
                    {{ vm.orgUnitDeleteError()?.message || 'Unable to delete unit.' }}
                </mb-alert>
                <div class="ou-delete__loading" *ngIf="vm.orgUnitDeleteImpactLoading()">
                    Loading delete impact…
                </div>
                <div class="ou-delete__impact" *ngIf="!vm.orgUnitDeleteImpactLoading()">
                    <div class="ou-delete__row">
                        <span>Unit</span>
                        <span>{{ vm.orgUnitDeleteTarget()?.name }}</span>
                    </div>
                    <div class="ou-delete__row">
                        <span>Child units</span>
                        <span>{{ vm.orgUnitDeleteImpact()?.descendantUnitsCount ?? 0 }}</span>
                    </div>
                    <div class="ou-delete__row">
                        <span>Members affected</span>
                        <span>{{ vm.orgUnitDeleteImpact()?.membersDirectCount ?? 0 }}</span>
                    </div>
                    <div class="ou-delete__row">
                        <span>Roles removed</span>
                        <span>{{ vm.orgUnitDeleteImpact()?.roleAssignmentsCount ?? 0 }}</span>
                    </div>
                    <div class="ou-delete__warning" id="ou-delete-warning">
                        This action cannot be undone.
                    </div>
                </div>

                <mb-form-field *ngIf="vm.orgUnitDeleteRequiresConfirm()"
                    label="Type the unit name to confirm" [controlId]="'ou-delete-confirm'"
                    hint="Enter '{{ vm.orgUnitDeleteTarget()?.name }}' to enable deletion.">
                    <mb-input id="ou-delete-confirm" [value]="vm.orgUnitDeleteConfirm()"
                        (valueChange)="vm.orgUnitDeleteConfirm.set($event)"
                        [placeholder]="vm.orgUnitDeleteTarget()?.name || ''"></mb-input>
                </mb-form-field>
            </div>

            <div mbModalFooter class="ou-delete__footer">
                <mb-button variant="secondary" cdkFocusInitial
                    (click)="vm.requestCloseDeleteOrgUnit()"
                    [disabled]="vm.orgUnitDeleteSubmitting()">Cancel</mb-button>
                <mb-button variant="danger" [loading]="vm.orgUnitDeleteSubmitting()"
                    [disabled]="vm.orgUnitDeleteRequiresConfirm() && !vm.isOrgUnitDeleteConfirmValid()"
                    [attr.aria-describedby]="'ou-delete-warning'"
                    (click)="vm.deleteSelectedOrgUnit()">
                    Delete unit
                </mb-button>
            </div>
        </mb-modal>

        <mb-modal [open]="vm.isOrgUnitRenameOpen()" title="Rename organizational unit" size="sm"
            [hasFooter]="true" [closeable]="!vm.orgUnitRenameSubmitting()"
            [closeOnBackdrop]="!vm.orgUnitRenameSubmitting()"
            (closed)="vm.requestCloseRenameOrgUnit()">
            <div class="ou-rename">
                <div class="ou-rename__subtitle">
                    Update the unit name. Changes apply immediately.
                </div>
                <mb-alert *ngIf="vm.orgUnitRenameError()" variant="danger">
                    {{ vm.orgUnitRenameError() }}
                </mb-alert>
                <mb-form-field label="Unit name" [controlId]="'ou-rename-name'">
                    <mb-input id="ou-rename-name" [value]="vm.orgUnitRenameName()"
                        (valueChange)="vm.orgUnitRenameName.set($event)" cdkFocusInitial>
                    </mb-input>
                </mb-form-field>
            </div>

            <div mbModalFooter class="ou-rename__footer">
                <mb-button variant="secondary" (click)="vm.requestCloseRenameOrgUnit()"
                    [disabled]="vm.orgUnitRenameSubmitting()">Cancel</mb-button>
                <mb-button variant="primary" [loading]="vm.orgUnitRenameSubmitting()"
                    (click)="vm.saveRenameOrgUnit()">
                    Save changes
                </mb-button>
            </div>
        </mb-modal>

        <mb-modal [open]="vm.isOrgUnitMoveOpen()" title="Move organizational unit" size="sm"
            [hasFooter]="true" [closeable]="!vm.orgUnitMoveSubmitting()"
            [closeOnBackdrop]="!vm.orgUnitMoveSubmitting()" (closed)="vm.requestCloseMoveOrgUnit()">
            <div class="ou-move">
                <div class="ou-move__subtitle">
                    Choose a new parent for this unit.
                </div>
                <mb-alert *ngIf="vm.orgUnitMoveError()" variant="danger">
                    {{ vm.orgUnitMoveError() }}
                </mb-alert>
                <mb-form-field label="Parent unit" [controlId]="'ou-move-parent'">
                    <mb-select id="ou-move-parent" [value]="vm.orgUnitMoveParentId() || ''"
                        (valueChange)="vm.setOrgUnitMoveParent($event)">
                        <option *ngFor="let option of vm.orgUnitParentOptions()"
                            [value]="option.id || ''">
                            {{ option.label }}
                        </option>
                    </mb-select>
                </mb-form-field>
            </div>

            <div mbModalFooter class="ou-move__footer">
                <mb-button variant="secondary" (click)="vm.requestCloseMoveOrgUnit()"
                    [disabled]="vm.orgUnitMoveSubmitting()">Cancel</mb-button>
                <mb-button variant="primary" [loading]="vm.orgUnitMoveSubmitting()"
                    (click)="vm.saveMoveOrgUnit()">
                    Move unit
                </mb-button>
            </div>
        </mb-modal>

        <mb-modal [open]="vm.isOrgUnitChangeParentOpen()" title="Change parent" size="sm"
            [hasFooter]="true" [closeable]="!vm.orgUnitMoveSubmitting()"
            [closeOnBackdrop]="!vm.orgUnitMoveSubmitting()"
            (closed)="vm.requestCloseChangeParentOrgUnit()">
            <div class="ou-move">
                <div class="ou-move__subtitle">
                    Update the parent for this unit.
                </div>
                <mb-alert *ngIf="vm.orgUnitMoveError()" variant="danger">
                    {{ vm.orgUnitMoveError() }}
                </mb-alert>
                <mb-form-field label="Parent unit" [controlId]="'ou-change-parent'">
                    <mb-select id="ou-change-parent" [value]="vm.orgUnitMoveParentId() || ''"
                        (valueChange)="vm.setOrgUnitMoveParent($event)">
                        <option *ngFor="let option of vm.orgUnitParentOptions()"
                            [value]="option.id || ''">
                            {{ option.label }}
                        </option>
                    </mb-select>
                </mb-form-field>
            </div>

            <div mbModalFooter class="ou-move__footer">
                <mb-button variant="secondary" (click)="vm.requestCloseChangeParentOrgUnit()"
                    [disabled]="vm.orgUnitMoveSubmitting()">Cancel</mb-button>
                <mb-button variant="primary" [loading]="vm.orgUnitMoveSubmitting()"
                    (click)="vm.saveChangeParentOrgUnit()">
                    Save changes
                </mb-button>
            </div>
        </mb-modal>

        <mb-modal [open]="vm.isOrgUnitDeactivateOpen()" title="Deactivate organizational unit"
            size="sm" [hasFooter]="true" [closeable]="!vm.orgUnitDeactivateSubmitting()"
            [closeOnBackdrop]="!vm.orgUnitDeactivateSubmitting()"
            (closed)="vm.requestCloseDeactivateOrgUnit()">
            <div class="ou-deactivate">
                <div class="ou-deactivate__subtitle">
                    Deactivating a unit hides it from assignments and scheduling.
                </div>
                <mb-alert *ngIf="vm.orgUnitDeactivateError()" variant="danger">
                    {{ vm.orgUnitDeactivateError() }}
                </mb-alert>
                <div class="ou-deactivate__impact">
                    <div class="ou-deactivate__row">
                        <span>Unit</span>
                        <span>{{ vm.selectedOrgUnit()?.name }}</span>
                    </div>
                    <div class="ou-deactivate__row">
                        <span>Status</span>
                        <span>Active → Inactive</span>
                    </div>
                </div>
            </div>

            <div mbModalFooter class="ou-deactivate__footer">
                <mb-button variant="secondary" (click)="vm.requestCloseDeactivateOrgUnit()"
                    [disabled]="vm.orgUnitDeactivateSubmitting()">Cancel</mb-button>
                <mb-button variant="danger" [loading]="vm.orgUnitDeactivateSubmitting()"
                    (click)="vm.deactivateSelectedOrgUnit()">
                    Deactivate unit
                </mb-button>
            </div>
        </mb-modal>
    </div>

</div>
