<div class="setup-body schools-page-body" id="setup-step-content">
    <div class="schools-card">
        <div class="schools-card__header">
            <div class="schools-header__main">
                <h2>Schools</h2>
                <p>Manage the schools under your organization. You can add, edit, or deactivate schools at any time.</p>
                <div class="schools-header__summary">
                    <span>{{ totalCount() }} schools</span>
                    <span class="schools-header__summary-divider" aria-hidden="true">•</span>
                    <span>{{ activeCount() }} active</span>
                    <span class="schools-header__summary-divider" aria-hidden="true">•</span>
                    <span>{{ archivedCount() }} archived</span>
                </div>
            </div>
            <div class="schools-header__actions">
                <mb-button size="sm" class="schools-header__add" variant="primary" (click)="openAddSchool()">
                    Add school
                </mb-button>
                <button type="button" class="schools-header__menu" #headerMenuOrigin
                    aria-label="More actions" (click)="toggleHeaderMenu()">
                    ...
                </button>
                <mb-popover [open]="headerMenuOpen()" [origin]="headerMenuOrigin" [hasBackdrop]="true"
                    [panelClass]="['mb-popover-panel', 'mb-popover-panel--above-modal', 'schools-menu__panel']"
                    (closed)="closeHeaderMenu()">
                    <div class="schools-menu__panel-content" role="menu">
                        <button type="button" class="schools-menu__item" (click)="headerImport()">Import CSV</button>
                        <button type="button" class="schools-menu__item" (click)="headerExport()">Export</button>
                        <div class="schools-menu__divider"></div>
                        <button type="button" class="schools-menu__item" (click)="viewArchived()">
                            View archived
                        </button>
                    </div>
                </mb-popover>
            </div>
        </div>

        <div class="schools-toolbar">
            <div class="schools-toolbar__group">
                <div class="schools-toolbar__field schools-toolbar__field--search">
                    <app-search-input [value]="searchQuery()" placeholder="Search schools..."
                        (search)="handleSearch($event)"></app-search-input>
                </div>
                <div class="schools-toolbar__field">
                    <mb-select ariaLabel="Filter by status" [options]="statusOptions" [value]="statusFilter()"
                        (valueChange)="updateStatusFilter($event)"></mb-select>
                </div>
                <div class="schools-toolbar__field">
                    <mb-select ariaLabel="Sort schools" [options]="sortOptions" [value]="sortBy()"
                        (valueChange)="updateSort($event)"></mb-select>
                </div>
            </div>
            <div class="schools-toolbar__group schools-toolbar__group--right">
                <div class="schools-density" role="group" aria-label="Table density">
                    <button type="button" class="schools-density__button"
                        [class.is-active]="density() === 'comfortable'" [attr.aria-pressed]="density() === 'comfortable'"
                        (click)="toggleDensity('comfortable')">Comfortable</button>
                    <button type="button" class="schools-density__button"
                        [class.is-active]="density() === 'compact'" [attr.aria-pressed]="density() === 'compact'"
                        (click)="toggleDensity('compact')">Compact</button>
                </div>
                <div class="schools-toolbar__field schools-toolbar__field--count">
                    {{ filteredCount() }} results
                </div>
            </div>
        </div>

        <div class="schools-card__body">
            <div class="schools-bulk" *ngIf="selectedCount() > 0">
                <div class="schools-bulk__label">{{ selectedCount() }} selected</div>
                <div class="schools-bulk__actions">
                    <mb-button size="sm" variant="secondary" (click)="bulkArchive()">Archive</mb-button>
                    <mb-button size="sm" variant="tertiary" (click)="bulkExport()">Export</mb-button>
                    <button type="button" class="schools-bulk__menu" #bulkMenuOrigin
                        aria-label="Bulk actions" (click)="toggleBulkMenu()">...</button>
                    <mb-popover [open]="bulkMenuOpen()" [origin]="bulkMenuOrigin" [hasBackdrop]="true"
                        [panelClass]="['mb-popover-panel', 'mb-popover-panel--above-modal', 'schools-menu__panel']"
                        (closed)="closeBulkMenu()">
                        <div class="schools-menu__panel-content" role="menu">
                            <button type="button" class="schools-menu__item schools-menu__item--danger"
                                (click)="openBulkDelete()">Delete...</button>
                        </div>
                    </mb-popover>
                </div>
            </div>

            <div class="schools-table-wrap" *ngIf="filteredCount() > 0; else emptyState">
            <mb-table class="schools-table" [class.is-compact]="density() === 'compact'"
                [columns]="schoolTableColumns" [rows]="pagedSchools()" [rowKey]="rowKey" [rowClass]="rowClass"
                [selectable]="true" [sortLocal]="false" (selectionChange)="handleSelectionChange($event)"
                (rowClick)="openDrawer($event)">
                <ng-template mbTableActions let-row>
                    <div class="schools-table__actions">
                        <button type="button" class="schools-menu__toggle" #schoolMenuOrigin
                            aria-label="Row actions" [attr.aria-expanded]="rowMenuOpenId() === row.id"
                            (click)="toggleRowMenu(row, $event)">...</button>
                        <mb-popover [open]="rowMenuOpenId() === row.id" [origin]="schoolMenuOrigin"
                            [hasBackdrop]="true"
                            [panelClass]="['mb-popover-panel', 'mb-popover-panel--above-modal', 'schools-menu__panel']"
                            (closed)="closeRowMenu()">
                            <div class="schools-menu__panel-content" role="menu">
                                <button type="button" class="schools-menu__item"
                                    (click)="openEditSchool(row); closeRowMenu()">Edit</button>
                                <button type="button" class="schools-menu__item"
                                    (click)="duplicateSchool(row); closeRowMenu()">Duplicate</button>
                                <div class="schools-menu__divider"></div>
                                <button type="button" class="schools-menu__item"
                                    (click)="row.status === 'archived' ? restoreSchool(row) : openArchiveConfirm(row); closeRowMenu()">
                                    {{ row.status === 'archived' ? 'Restore' : 'Archive' }}
                                </button>
                                <div class="schools-menu__divider"></div>
                                <button type="button" class="schools-menu__item schools-menu__item--submenu" #dangerMenuOrigin
                                    (click)="toggleRowDangerMenu(row, $event)">
                                    Danger zone >
                                </button>
                                <mb-popover [open]="rowDangerMenuOpenId() === row.id" [origin]="dangerMenuOrigin"
                                    [hasBackdrop]="false"
                                    [panelClass]="['mb-popover-panel', 'mb-popover-panel--above-modal', 'schools-menu__panel', 'schools-menu__panel--submenu']">
                                    <div class="schools-menu__panel-content" role="menu">
                                        <button type="button" class="schools-menu__item schools-menu__item--danger"
                                            (click)="openDeleteConfirm([row]); closeRowMenu()">Delete school...</button>
                                    </div>
                                </mb-popover>
                            </div>
                        </mb-popover>
                    </div>
                </ng-template>
            </mb-table>

            <div class="schools-pagination">
                <div class="schools-pagination__meta">
                    Page {{ pageIndex() }} of {{ pageCount() }}
                </div>
                <div class="schools-pagination__controls">
                    <button type="button" class="schools-pagination__nav" (click)="updatePage(pageIndex() - 1)"
                        [disabled]="pageIndex() === 1" aria-label="Previous page">
                        Prev
                    </button>
                    <button *ngFor="let page of pageNumbers()" type="button" class="schools-pagination__page"
                        [class.is-active]="pageIndex() === page" (click)="updatePage(page)">
                        {{ page }}
                    </button>
                    <button type="button" class="schools-pagination__nav" (click)="updatePage(pageIndex() + 1)"
                        [disabled]="pageIndex() === pageCount()" aria-label="Next page">
                        Next
                    </button>
                </div>
                <div class="schools-pagination__size">
                    <span>Rows per page</span>
                    <mb-select ariaLabel="Rows per page" [options]="pageSizeOptions" [value]="pageSizeValue()"
                        (valueChange)="updatePageSize($event)"></mb-select>
                </div>
            </div>
        </div>

        <ng-template #emptyState>
            <div class="schools-empty">
                <div class="schools-empty__icon" aria-hidden="true"></div>
                <div class="schools-empty__title">No schools found</div>
                <div class="schools-empty__text">
                    {{ hasFilters() ? 'Try adjusting your filters or search.' :
                    'Add a school to start enrolling students and assigning staff.' }}
                </div>
                <div class="schools-empty__actions">
                    <mb-button variant="primary" (click)="openAddSchool()">Add school</mb-button>
                    <mb-button variant="secondary" *ngIf="hasFilters()" (click)="clearFilters()">Clear filters</mb-button>
                </div>
            </div>
        </ng-template>

        <mb-drawer [open]="!!drawerSchool()" title="" panelClass="schools-drawer" (closed)="closeDrawer()">
            <ng-container *ngIf="drawerSchool() as selected">
                <div class="schools-drawer__header">
                    <div>
                        <div class="schools-drawer__title">{{ selected.name }}</div>
                        <div class="schools-drawer__meta">
                            <span class="schools-status" [class.is-archived]="selected.status === 'archived'">
                                {{ statusLabel(selected.status) }}
                            </span>
                        </div>
                    </div>
                </div>
                <div class="schools-drawer__section">
                    <div class="schools-drawer__section-title">Basics</div>
                    <div class="schools-drawer__grid">
                        <div>
                            <div class="schools-drawer__label">Code</div>
                            <div class="schools-drawer__value">{{ selected.code }}</div>
                        </div>
                        <div>
                            <div class="schools-drawer__label">Location</div>
                            <div class="schools-drawer__value">{{ selected.locationCountry || '--' }}</div>
                        </div>
                        <div>
                            <div class="schools-drawer__label">Time zone</div>
                            <div class="schools-drawer__value">{{ selected.timeZone || '--' }}</div>
                        </div>
                    </div>
                </div>
                <div class="schools-drawer__section">
                    <div class="schools-drawer__section-title">Metadata</div>
                    <div class="schools-drawer__grid">
                        <div>
                            <div class="schools-drawer__label">Created</div>
                            <div class="schools-drawer__value">{{ formatDate(selected.createdAt) }}</div>
                        </div>
                        <div>
                            <div class="schools-drawer__label">Last updated</div>
                            <div class="schools-drawer__value">{{ formatDate(selected.updatedAt) }}</div>
                        </div>
                    </div>
                </div>
                <div mbDrawerFooter class="schools-drawer__footer">
                    <mb-button variant="primary" (click)="openEditSchool(selected)">Edit school</mb-button>
                    <mb-button variant="secondary"
                        (click)="selected.status === 'archived' ? restoreSchool(selected) : openArchiveConfirm(selected)">
                        {{ selected.status === 'archived' ? 'Restore' : 'Archive' }}
                    </mb-button>
                    <div class="schools-drawer__menu" [class.open]="rowMenuOpenId() === selected.id">
                        <button type="button" class="schools-menu__toggle" #drawerMenuOrigin
                            aria-label="More actions" (click)="toggleRowMenu(selected, $event)">...</button>
                        <mb-popover [open]="rowMenuOpenId() === selected.id" [origin]="drawerMenuOrigin"
                            [hasBackdrop]="true"
                            [panelClass]="['mb-popover-panel', 'mb-popover-panel--above-modal', 'schools-menu__panel']"
                            (closed)="closeRowMenu()">
                            <div class="schools-menu__panel-content" role="menu">
                                <button type="button" class="schools-menu__item"
                                    (click)="duplicateSchool(selected); closeRowMenu()">Duplicate</button>
                                <div class="schools-menu__divider"></div>
                                <button type="button" class="schools-menu__item schools-menu__item--danger"
                                    (click)="openDeleteConfirm([selected]); closeRowMenu()">Delete school...</button>
                            </div>
                        </mb-popover>
                    </div>
                </div>
            </ng-container>
        </mb-drawer>

        <mb-modal class="schools-modal-shell" [open]="isSchoolModalOpen()" [closeable]="false" size="lg"
            (closed)="requestCloseSchoolModal()">
            <div class="schools-modal__layout">
                <div class="schools-modal__header">
                    <div class="schools-modal__header-main">
                        <div class="schools-modal__icon" aria-hidden="true">
                            <svg viewBox="0 0 24 24" role="img" aria-hidden="true" focusable="false">
                                <path
                                    d="M3 9.5L12 5l9 4.5M5 10.5v8m4-6v6m6-6v6m4-8v8M3 18.5h18"
                                    fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round"
                                    stroke-linejoin="round" />
                            </svg>
                        </div>
                        <div>
                            <div class="schools-modal__title">
                                {{ editingSchoolId() ? 'Edit school' : 'Add school' }}
                            </div>
                            <div class="schools-modal__subtitle">
                                Add a school under this organization. You can edit details later.
                            </div>
                        </div>
                    </div>
                    <button type="button" class="schools-modal__close"
                        aria-label="Close modal" (click)="requestCloseSchoolModal()">x</button>
                </div>

                <div class="schools-modal__error" *ngIf="errorSummaryText()">
                    <div class="schools-modal__error-title">{{ errorSummaryText() }}</div>
                    <div class="schools-modal__error-actions">
                        <button type="button" class="schools-modal__error-link"
                            *ngFor="let field of invalidFields()" (click)="focusField(field.id)">
                            {{ field.label }}
                        </button>
                    </div>
                </div>

                <div class="schools-modal__scroll">
                    <div class="schools-modal__columns">
                        <div class="schools-modal__section">
                            <div class="schools-modal__section-label">IDENTITY</div>
                            <div class="schools-modal__section-title">School identity</div>
                            <div class="schools-modal__section-helper">
                                Core identifiers used across the workspace.
                            </div>
                            <div class="schools-modal__grid">
                                <mb-form-field class="schools-modal__field schools-modal__field--full"
                                    label="School name" [required]="true" [controlId]="'school-form-name'"
                                    [error]="schoolNameError()"
                                    hint="Appears across the platform and reports.">
                                    <mb-input id="school-form-name" cdkFocusInitial [value]="schoolFormName()"
                                        placeholder="e.g. International School of Paris"
                                        (valueChange)="onSchoolNameChange($event)"
                                        (blurEvent)="schoolFormNameTouched.set(true)"></mb-input>
                                </mb-form-field>

                                <mb-form-field class="schools-modal__field schools-modal__field--full"
                                    label="Code / slug" [required]="true" [controlId]="'school-form-code'"
                                    [error]="schoolCodeError()"
                                    hint="Used in URLs and imports. Lowercase letters, numbers, hyphens. 3-50 chars.">
                                    <mb-input id="school-form-code" [value]="schoolFormCode()"
                                        placeholder="bolgatanga-secondary-school"
                                        (valueChange)="onSchoolCodeChange($event)"
                                        (blurEvent)="schoolFormCodeTouched.set(true)"></mb-input>
                                    <button type="button" mbSuffix class="schools-modal__suffix"
                                        *ngIf="codeResetAvailable()" (click)="resetCodeSuggestion()">
                                        Reset
                                    </button>
                                </mb-form-field>

                                <mb-form-field class="schools-modal__field"
                                    label="Short name" [controlId]="'school-form-short-name'"
                                    hint="Appears on compact views and reports.">
                                    <mb-input id="school-form-short-name" [value]="schoolFormShortName()"
                                        placeholder="e.g. Bolga Sec"
                                        (valueChange)="schoolFormShortName.set($event)"></mb-input>
                                </mb-form-field>

                                <mb-form-field class="schools-modal__field"
                                    label="Status" [controlId]="'school-form-status'">
                                    <mb-select id="school-form-status" ariaLabel="School status"
                                        [options]="formStatusOptions" [value]="schoolFormStatus()"
                                        (valueChange)="onSchoolStatusChange($event)"></mb-select>
                                </mb-form-field>
                            </div>

                            <button type="button" class="schools-modal__advanced-toggle"
                                (click)="toggleAdvanced()">
                                {{ schoolFormAdvancedOpen() ? 'Hide advanced' : 'Show advanced' }}
                            </button>

                            <div class="schools-modal__advanced" *ngIf="schoolFormAdvancedOpen()">
                                <div class="schools-modal__divider"></div>
                                <div class="schools-modal__grid">
                                    <mb-form-field class="schools-modal__field"
                                        label="Contact email" [controlId]="'school-form-contact-email'">
                                        <mb-input id="school-form-contact-email" type="email"
                                            [value]="schoolFormContactEmail()"
                                            (valueChange)="schoolFormContactEmail.set($event)"></mb-input>
                                    </mb-form-field>
                                    <mb-form-field class="schools-modal__field"
                                        label="Contact phone" [controlId]="'school-form-contact-phone'">
                                        <mb-input id="school-form-contact-phone" type="tel"
                                            [value]="schoolFormContactPhone()"
                                            (valueChange)="schoolFormContactPhone.set($event)"></mb-input>
                                    </mb-form-field>
                                    <mb-form-field class="schools-modal__field schools-modal__field--full"
                                        label="Address line 1" [controlId]="'school-form-address-line-1'">
                                        <mb-input id="school-form-address-line-1" [value]="schoolFormAddressLine1()"
                                            (valueChange)="schoolFormAddressLine1.set($event)"></mb-input>
                                    </mb-form-field>
                                    <mb-form-field class="schools-modal__field schools-modal__field--full"
                                        label="Address line 2" [controlId]="'school-form-address-line-2'">
                                        <mb-input id="school-form-address-line-2" [value]="schoolFormAddressLine2()"
                                            (valueChange)="schoolFormAddressLine2.set($event)"></mb-input>
                                    </mb-form-field>
                                    <mb-form-field class="schools-modal__field"
                                        label="State / region" [controlId]="'school-form-state'">
                                        <mb-input id="school-form-state" [value]="schoolFormState()"
                                            (valueChange)="schoolFormState.set($event)"></mb-input>
                                    </mb-form-field>
                                    <mb-form-field class="schools-modal__field"
                                        label="Postal code" [controlId]="'school-form-postal'">
                                        <mb-input id="school-form-postal" [value]="schoolFormPostalCode()"
                                            (valueChange)="schoolFormPostalCode.set($event)"></mb-input>
                                    </mb-form-field>
                                </div>
                            </div>
                        </div>

                        <div class="schools-modal__section">
                            <div class="schools-modal__section-label">SETTINGS</div>
                            <div class="schools-modal__section-title">Operational settings</div>
                            <div class="schools-modal__section-helper">
                                Defaults for time-based workflows and regional settings.
                            </div>
                            <div class="schools-modal__grid">
                                <mb-form-field class="schools-modal__field"
                                    label="Country" [required]="true" [controlId]="'school-form-country'"
                                    [error]="schoolCountryError()">
                                    <app-country-select id="school-form-country" ariaLabel="Country"
                                        [value]="schoolFormCountry()" [invalid]="!!schoolCountryError()"
                                        placeholder="Select country"
                                        (valueChange)="onSchoolCountryChange($event)"
                                        (blurEvent)="schoolFormCountryTouched.set(true)">
                                    </app-country-select>
                                </mb-form-field>

                                <mb-form-field class="schools-modal__field"
                                    label="City" [controlId]="'school-form-city'">
                                    <mb-input id="school-form-city" [value]="schoolFormCity()"
                                        (valueChange)="schoolFormCity.set($event)"></mb-input>
                                </mb-form-field>

                                <mb-form-field class="schools-modal__field"
                                    label="Time zone" [required]="true" [controlId]="'school-form-timezone'"
                                    [error]="schoolTimezoneError()">
                                    <app-timezone-select id="school-form-timezone" ariaLabel="Time zone"
                                        [value]="schoolFormTimezone()" [invalid]="!!schoolTimezoneError()"
                                        placeholder="Select time zone"
                                        (valueChange)="onSchoolTimezoneChange($event)"
                                        (blurEvent)="schoolFormTimezoneTouched.set(true)">
                                    </app-timezone-select>
                                </mb-form-field>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="schools-modal__footer">
                    <div class="schools-modal__footer-note">Changes are saved when you click Save.</div>
                    <div class="schools-modal__footer-actions">
                        <button *ngIf="!editingSchoolId()" type="button" class="schools-modal__link"
                            [disabled]="!canSaveSchool() || isSaving()"
                            (click)="saveAndAddAnother()">
                            Save & add another
                        </button>
                        <mb-button variant="secondary" (click)="requestCloseSchoolModal()">Cancel</mb-button>
                        <mb-button variant="primary" [disabled]="!canSaveSchool() || isSaving()" (click)="saveSchool()">
                            {{ isSaving() ? 'Saving...' : 'Save school' }}
                        </mb-button>
                    </div>
                </div>
            </div>
        </mb-modal>

        <mb-modal [open]="discardConfirmOpen()" title="Discard changes?" size="sm" (closed)="closeDiscardConfirm()">
            <div class="schools-confirm">
                <div class="schools-confirm__text">
                    You have unsaved changes. Discard them?
                </div>
            </div>
            <div mbModalFooter class="schools-confirm__footer">
                <mb-button variant="secondary" (click)="closeDiscardConfirm()">Cancel</mb-button>
                <mb-button variant="danger" (click)="confirmDiscardChanges()">Discard</mb-button>
            </div>
        </mb-modal>

        <mb-modal [open]="archiveConfirmOpen()" title="Archive school" size="sm" (closed)="closeArchiveConfirm()">
            <div class="schools-confirm">
                <div class="schools-confirm__title">
                    Archive {{ archiveTargetName() }}?
                </div>
                <div class="schools-confirm__text">You can restore this school later.</div>
            </div>
            <div mbModalFooter class="schools-confirm__footer">
                <mb-button variant="secondary" (click)="closeArchiveConfirm()">Cancel</mb-button>
                <mb-button variant="primary" (click)="confirmArchive()">Archive</mb-button>
            </div>
        </mb-modal>

        <mb-modal [open]="deleteConfirmOpen()" title="Delete school" size="sm" (closed)="closeDeleteConfirm()">
            <div class="schools-confirm">
                <div class="schools-confirm__text">
                    This action is permanent. Type
                    <strong>{{ deleteConfirmRequiredText() }}</strong>
                    to confirm.
                </div>
                <mb-form-field label="Confirmation" [controlId]="'delete-confirm-input'">
                    <mb-input id="delete-confirm-input" cdkFocusInitial [value]="deleteConfirmInput()"
                        (valueChange)="deleteConfirmInput.set($event)" (blurEvent)="deleteConfirmTouched.set(true)">
                    </mb-input>
                </mb-form-field>
                <div class="schools-confirm__error" *ngIf="deleteConfirmTouched() && !deleteConfirmReady()">
                    Enter the exact confirmation text to continue.
                </div>
            </div>
            <div mbModalFooter class="schools-confirm__footer">
                <mb-button variant="secondary" (click)="closeDeleteConfirm()">Cancel</mb-button>
                <mb-button variant="danger" [disabled]="!deleteConfirmReady()" (click)="confirmDelete()">
                    Delete
                </mb-button>
            </div>
        </mb-modal>
    </div>
</div>
</div>
