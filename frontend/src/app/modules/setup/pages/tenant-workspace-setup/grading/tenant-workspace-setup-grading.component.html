<div class="setup-body">
    <div class="setup-section">
        <div class="grading-header">
            <div>
                <h2>Grading system</h2>
                <p>Define how grades are recorded and calculated across your institution.</p>
                <div class="grading-filter" *ngIf="vm.hasMultipleSchools()">
                    <span class="grading-filter__label">School:</span>
                    <mb-select class="grading-filter__select" id="grading-school-filter"
                        [value]="vm.gradingSchoolFilter()"
                        (valueChange)="vm.gradingSchoolFilter.set($event)">
                        <option value="all">All schools</option>
                        <option *ngFor="let school of vm.activeSchoolNames()" [value]="school">
                            {{ school }}
                        </option>
                    </mb-select>
                </div>
            </div>
            <div class="grading-header__actions">
                <mb-button variant="primary" (click)="vm.openNewGradingScale()">Add grading
                    scale</mb-button>
                <button type="button" class="grading-menu__toggle" #gradingHeaderMenuOrigin
                    aria-label="More actions" [attr.aria-expanded]="vm.gradingHeaderMenuOpen()"
                    (click)="vm.toggleGradingHeaderMenu()">⋯</button>
                <mb-popover [open]="vm.gradingHeaderMenuOpen()" [origin]="gradingHeaderMenuOrigin"
                    [hasBackdrop]="true"
                    [panelClass]="['mb-popover-panel', 'mb-popover-panel--above-modal', 'grading-menu__panel']"
                    (closed)="vm.closeGradingHeaderMenu()">
                    <div class="grading-menu__panel-content">
                        <button type="button" class="grading-menu__item"
                            (click)="vm.importGradingTemplate(); vm.closeGradingHeaderMenu()">
                            Import template
                        </button>
                        <button type="button" class="grading-menu__item"
                            (click)="vm.resetGradingDefaults(); vm.closeGradingHeaderMenu()">
                            Reset to defaults
                        </button>
                    </div>
                </mb-popover>
            </div>
        </div>

        <div class="grading-card">
            <div class="grading-layout">
                <div class="grading-panel grading-panel--list">
                    <div class="grading-panel__header">
                        <div class="grading-panel__title">Scales</div>
                        <button type="button" class="grading-panel__link"
                            (click)="vm.openNewGradingScale()">+ New scale</button>
                    </div>
                    <div class="grading-scale-list"
                        *ngIf="vm.gradingScaleList().length; else gradingScaleEmpty">
                        <button type="button" class="grading-scale"
                            *ngFor="let scale of vm.gradingScaleList()"
                            [class.is-active]="vm.gradingSelectedScaleId() === scale.id"
                            (click)="vm.selectGradingScale(scale)">
                            <div class="grading-scale__content">
                                <div class="grading-scale__name">{{ scale.name }}</div>
                                <div class="grading-scale__meta">
                                    <span class="grading-scale__badge">{{ scale.type }}</span>
                                    <span class="grading-scale__status"
                                        [class.is-active]="scale.status === 'Active'"
                                        [class.is-draft]="scale.status === 'Draft'"
                                        [class.is-archived]="scale.status === 'Archived'">
                                        {{ scale.status }}
                                    </span>
                                    <span class="grading-scale__usage">
                                        {{ scale.schoolIds?.length ? (scale.schoolIds?.length +
                                        ' schools') : 'All schools' }}
                                    </span>
                                </div>
                            </div>
                        </button>
                    </div>
                    <ng-template #gradingScaleEmpty>
                        <div class="grading-empty">
                            <div class="grading-empty__title">No grading scales yet</div>
                            <div class="grading-empty__text">Create a scale to define how grades
                                are calculated.</div>
                            <mb-button variant="secondary" (click)="vm.openNewGradingScale()">Add
                                grading scale</mb-button>
                        </div>
                    </ng-template>
                </div>

                <div class="grading-panel grading-panel--detail">
                    <ng-container
                        *ngIf="vm.selectedGradingScale() as scale; else emptyGradingDetail">
                        <div class="grading-detail__header">
                            <div>
                                <div class="grading-detail__title">{{ scale.name }}</div>
                                <div class="grading-detail__meta">
                                    {{ scale.type }} · {{ scale.status }} · Used by:
                                    {{ vm.gradingScaleUsageLabel() }}
                                </div>
                            </div>
                            <div class="grading-detail__actions">
                                <mb-button variant="secondary"
                                    (click)="vm.openEditGradingScale(scale)">Edit</mb-button>
                                <button type="button" class="grading-menu__toggle"
                                    #gradingScaleMenuOrigin aria-label="More actions"
                                    [attr.aria-expanded]="vm.gradingScaleMenuOpen()"
                                    (click)="vm.toggleGradingScaleMenu()">⋯</button>
                                <mb-popover [open]="vm.gradingScaleMenuOpen()"
                                    [origin]="gradingScaleMenuOrigin" [hasBackdrop]="true"
                                    [panelClass]="['mb-popover-panel', 'mb-popover-panel--above-modal', 'grading-menu__panel']"
                                    (closed)="vm.closeGradingScaleMenu()">
                                    <div class="grading-menu__panel-content">
                                        <button type="button" class="grading-menu__item"
                                            (click)="vm.duplicateGradingScale()">Duplicate</button>
                                        <button type="button" class="grading-menu__item"
                                            (click)="vm.archiveGradingScale()">
                                            {{ scale.status === 'Archived' ? 'Restore' :
                                            'Archive' }}
                                        </button>
                                    </div>
                                </mb-popover>
                            </div>
                        </div>

                        <div class="grading-tabs">
                            <button type="button" class="grading-tab"
                                [class.is-active]="vm.gradingActiveTab() === 'bands'"
                                (click)="vm.gradingActiveTab.set('bands')">Grade bands</button>
                            <button type="button" class="grading-tab"
                                [class.is-active]="vm.gradingActiveTab() === 'settings'"
                                (click)="vm.gradingActiveTab.set('settings')">Settings</button>
                        </div>

                        <div *ngIf="vm.gradingActiveTab() === 'bands'" class="grading-bands">
                            <div class="grading-bands__actions">
                                <mb-button variant="secondary" (click)="vm.openAddGradeBand()">+
                                    Add
                                    grade band</mb-button>
                            </div>
                            <div class="grading-bands__table"
                                *ngIf="vm.selectedGradingBands().length; else gradingBandsEmpty">
                                <div class="grading-bands__header">
                                    <div>Grade</div>
                                    <div>Range</div>
                                    <div>GPA</div>
                                    <div>Status</div>
                                    <div class="grading-bands__actions-cell">Actions</div>
                                </div>
                                <div class="grading-bands__row"
                                    *ngFor="let band of vm.selectedGradingBands()">
                                    <div class="grading-bands__label">{{ band.label }}</div>
                                    <div>{{ band.min }} – {{ band.max }}</div>
                                    <div>{{ band.gpa ?? '—' }}</div>
                                    <div>
                                        <span class="grading-bands__badge"
                                            [class.is-pass]="band.pass"
                                            [class.is-fail]="!band.pass">
                                            {{ band.pass ? 'Pass' : 'Fail' }}
                                        </span>
                                    </div>
                                    <div class="grading-bands__actions-cell">
                                        <button type="button" class="grading-bands__menu-toggle"
                                            #gradingBandMenuOrigin aria-label="Row actions"
                                            [attr.aria-expanded]="vm.gradingBandMenuOpenId() === band.id"
                                            (click)="vm.toggleGradingBandMenu(band.id, $event)">⋯</button>
                                        <mb-popover [open]="vm.gradingBandMenuOpenId() === band.id"
                                            [origin]="gradingBandMenuOrigin"
                                            [hasBackdrop]="true"
                                            [panelClass]="['mb-popover-panel', 'mb-popover-panel--above-modal', 'grading-menu__panel']"
                                            (closed)="vm.closeGradingBandMenu()">
                                            <div class="grading-menu__panel-content">
                                                <button type="button" class="grading-menu__item"
                                                    (click)="vm.openEditGradeBand(band); vm.closeGradingBandMenu()">
                                                    Edit
                                                </button>
                                                <button type="button" class="grading-menu__item"
                                                    (click)="vm.deleteGradeBand(band)">
                                                    Delete
                                                </button>
                                            </div>
                                        </mb-popover>
                                    </div>
                                </div>
                            </div>
                            <ng-template #gradingBandsEmpty>
                                <div class="grading-empty grading-empty--detail">
                                    <div class="grading-empty__title">No grade bands yet</div>
                                    <div class="grading-empty__text">Add bands so scores map to
                                        grades and pass/fail rules.</div>
                                    <mb-button variant="secondary"
                                        (click)="vm.openAddGradeBand()">Add grade band</mb-button>
                                </div>
                            </ng-template>
                        </div>

                        <div *ngIf="vm.gradingActiveTab() === 'settings'" class="grading-settings">
                            <div class="grading-settings__group">
                                <div class="grading-settings__title">Pass mark & ranges</div>
                                <div class="grading-settings__row">
                                    <mb-form-field label="Pass mark threshold"
                                        [controlId]="'grading-pass-mark'">
                                        <mb-input id="grading-pass-mark"
                                            [value]="(scale.settings.passMark ?? '').toString()"
                                            placeholder="Optional"
                                            (valueChange)="vm.setGradingPassMark($event)"></mb-input>
                                    </mb-form-field>
                                    <div class="grading-settings__toggles">
                                        <mb-checkbox [checked]="scale.settings.allowDecimals"
                                            (checkedChange)="vm.updateSelectedScaleSettings({ allowDecimals: $event })">
                                            Allow decimals
                                        </mb-checkbox>
                                        <mb-checkbox [checked]="scale.settings.preventOverlap"
                                            (checkedChange)="vm.updateSelectedScaleSettings({ preventOverlap: $event })">
                                            Prevent overlapping ranges
                                        </mb-checkbox>
                                    </div>
                                </div>
                            </div>
                            <div class="grading-settings__divider"></div>
                            <div class="grading-settings__group">
                                <div class="grading-settings__title">Calculation method</div>
                                <div class="grading-settings__row">
                                    <mb-form-field label="Method"
                                        [controlId]="'grading-calculation'">
                                        <mb-select id="grading-calculation"
                                            [value]="scale.settings.calculationMethod"
                                            (valueChange)="vm.setGradingCalculationMethod($event)">
                                            <option value="Average">Average</option>
                                            <option value="Highest">Highest</option>
                                            <option value="Lowest">Lowest</option>
                                            <option value="Weighted">Weighted</option>
                                        </mb-select>
                                    </mb-form-field>
                                    <mb-form-field label="Rounding"
                                        [controlId]="'grading-rounding'">
                                        <mb-select id="grading-rounding"
                                            [value]="scale.settings.rounding"
                                            (valueChange)="vm.setGradingRounding($event)">
                                            <option value="Nearest">Nearest</option>
                                            <option value="Up">Round up</option>
                                            <option value="Down">Round down</option>
                                        </mb-select>
                                    </mb-form-field>
                                </div>
                            </div>
                            <div class="grading-settings__divider"></div>
                            <div class="grading-settings__group">
                                <div class="grading-settings__title">Transcript display</div>
                                <div class="grading-settings__row">
                                    <div class="grading-settings__toggles">
                                        <mb-checkbox [checked]="scale.settings.showGpa"
                                            (checkedChange)="vm.updateSelectedScaleSettings({ showGpa: $event })">
                                            Show GPA
                                        </mb-checkbox>
                                        <mb-checkbox [checked]="scale.settings.showPercent"
                                            (checkedChange)="vm.updateSelectedScaleSettings({ showPercent: $event })">
                                            Show percentage
                                        </mb-checkbox>
                                    </div>
                                    <mb-form-field label="Format"
                                        [controlId]="'grading-format'">
                                        <mb-select id="grading-format"
                                            [value]="scale.settings.transcriptFormat"
                                            (valueChange)="vm.setGradingTranscriptFormat($event)">
                                            <option value="Letter">Letter</option>
                                            <option value="Letter + Percent">Letter + Percent
                                            </option>
                                            <option value="Percent">Percent only</option>
                                        </mb-select>
                                    </mb-form-field>
                                </div>
                            </div>
                        </div>
                    </ng-container>
                    <ng-template #emptyGradingDetail>
                        <div class="grading-empty grading-empty--detail">
                            <div class="grading-empty__title">Select a grading scale</div>
                            <div class="grading-empty__text">Choose a scale to view grade bands
                                and settings.</div>
                        </div>
                    </ng-template>
                </div>
            </div>
        </div>
    </div>

    <div class="setup-footer">
        <div class="setup-footer__actions">
            <mb-button variant="secondary" (click)="vm.back()">Back</mb-button>
            <mb-button variant="primary" (click)="vm.next()">Continue</mb-button>
        </div>
        <div class="setup-footer__aside">
            <button type="button" class="setup-skip-link" (click)="vm.skipSetup()">Skip for
                now</button>
        </div>
    </div>
    <div class="setup-auto-save"><span aria-hidden="true">✓</span> Configuration changes are
        saved automatically.</div>

    <mb-modal [open]="vm.gradingScaleFormOpen()"
        [title]="vm.gradingScaleFormMode() === 'add' ? 'New grading scale' : 'Edit grading scale'"
        size="md" [hasFooter]="true" (closed)="vm.requestCloseGradingScaleForm()">
        <div class="grading-modal">
            <div class="grading-modal__subtitle">Create a grading scale for reporting and
                calculations.</div>
            <mb-alert *ngIf="vm.gradingScaleFormError()" variant="danger">
                {{ vm.gradingScaleFormError() }}
            </mb-alert>
            <mb-form-field label="Scale name" [controlId]="'grading-scale-name'">
                <mb-input id="grading-scale-name" [value]="vm.gradingScaleFormName()"
                    (valueChange)="vm.gradingScaleFormName.set($event)"></mb-input>
            </mb-form-field>
            <mb-form-field label="Template (optional)" [controlId]="'grading-scale-template'">
                <mb-select id="grading-scale-template" [value]="vm.gradingScaleFormTemplate()"
                    (valueChange)="vm.selectGradingTemplate($event)">
                    <option value="">None</option>
                    <option *ngFor="let option of vm.gradingTemplateOptions()" [value]="option.id">
                        {{ option.label }}
                    </option>
                </mb-select>
            </mb-form-field>
            <mb-form-field label="Type" [controlId]="'grading-scale-type'">
                <mb-select id="grading-scale-type" [value]="vm.gradingScaleFormType()"
                    (valueChange)="vm.gradingScaleFormType.set($any($event))">
                    <option value="Letter">Letter</option>
                    <option value="Percent">Percent</option>
                    <option value="GPA">GPA</option>
                    <option value="Rubric">Rubric</option>
                </mb-select>
            </mb-form-field>
            <div class="grading-modal__radio">
                <div class="grading-modal__label">Applies to</div>
                <label class="grading-modal__option">
                    <input type="radio" name="grading-scope" value="all"
                        [checked]="vm.gradingScaleFormSchoolScope() === 'all'"
                        (change)="vm.gradingScaleFormSchoolScope.set('all')" />
                    <span>All schools</span>
                </label>
                <label class="grading-modal__option">
                    <input type="radio" name="grading-scope" value="specific"
                        [checked]="vm.gradingScaleFormSchoolScope() === 'specific'"
                        (change)="vm.gradingScaleFormSchoolScope.set('specific')" />
                    <span>Selected schools</span>
                </label>
                <div class="grading-modal__schools"
                    *ngIf="vm.gradingScaleFormSchoolScope() === 'specific'">
                    <mb-checkbox *ngFor="let school of vm.activeSchoolNames()"
                        [checked]="vm.gradingScaleFormSchoolIds().includes(school)"
                        (checkedChange)="vm.toggleGradingScaleSchool(school, $event)">
                        {{ school }}
                    </mb-checkbox>
                </div>
            </div>
            <mb-form-field label="Default pass mark" [controlId]="'grading-pass-mark-default'">
                <mb-input id="grading-pass-mark-default" [value]="vm.gradingScaleFormPassMark()"
                    placeholder="Optional"
                    (valueChange)="vm.gradingScaleFormPassMark.set($event)"></mb-input>
            </mb-form-field>
        </div>
        <div mbModalFooter class="grading-modal__footer">
            <mb-button variant="secondary"
                (click)="vm.requestCloseGradingScaleForm()">Cancel</mb-button>
            <mb-button variant="primary" (click)="vm.saveGradingScale()">
                {{ vm.gradingScaleFormMode() === 'add' ? 'Create scale' : 'Save changes' }}
            </mb-button>
        </div>
    </mb-modal>

    <mb-modal [open]="vm.gradingBandFormOpen()"
        [title]="vm.gradingBandFormMode() === 'add' ? 'Add grade band' : 'Edit grade band'"
        size="sm" [hasFooter]="true" (closed)="vm.requestCloseGradeBandForm()">
        <div class="grading-modal">
            <div class="grading-modal__subtitle">Define the score range and status for this
                grade band.</div>
            <mb-alert *ngIf="vm.gradingBandFormError()" variant="danger">
                {{ vm.gradingBandFormError() }}
            </mb-alert>
            <mb-form-field label="Label" [controlId]="'grading-band-label'">
                <mb-input id="grading-band-label" [value]="vm.gradingBandFormLabel()"
                    (valueChange)="vm.gradingBandFormLabel.set($event)"></mb-input>
            </mb-form-field>
            <div class="grading-modal__row">
                <mb-form-field label="Min score" [controlId]="'grading-band-min'">
                    <mb-input id="grading-band-min" [value]="vm.gradingBandFormMin()"
                        (valueChange)="vm.gradingBandFormMin.set($event)"></mb-input>
                </mb-form-field>
                <mb-form-field label="Max score" [controlId]="'grading-band-max'">
                    <mb-input id="grading-band-max" [value]="vm.gradingBandFormMax()"
                        (valueChange)="vm.gradingBandFormMax.set($event)"></mb-input>
                </mb-form-field>
            </div>
            <mb-form-field label="GPA points (optional)" [controlId]="'grading-band-gpa'">
                <mb-input id="grading-band-gpa" [value]="vm.gradingBandFormGpa()"
                    (valueChange)="vm.gradingBandFormGpa.set($event)"></mb-input>
            </mb-form-field>
            <label class="grading-modal__toggle">
                <input type="checkbox" [checked]="vm.gradingBandFormPass()"
                    (change)="vm.gradingBandFormPass.set($any($event.target).checked)" />
                <span>Pass</span>
            </label>
        </div>
        <div mbModalFooter class="grading-modal__footer">
            <mb-button variant="secondary"
                (click)="vm.requestCloseGradeBandForm()">Cancel</mb-button>
            <mb-button variant="primary" (click)="vm.saveGradeBand()">
                {{ vm.gradingBandFormMode() === 'add' ? 'Save band' : 'Save changes' }}
            </mb-button>
        </div>
    </mb-modal>
</div>
