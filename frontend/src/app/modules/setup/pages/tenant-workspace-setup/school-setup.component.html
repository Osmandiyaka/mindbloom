<div class="setup-body" id="setup-step-content">
    <div class="setup-section">
        <div class="schools-header">
            <div class="schools-header__main">
                <h2>Schools</h2>
                <p>Manage the schools under your organization. You can add, edit, or deactivate schools at any time.</p>
                <div class="schools-header__summary">
                    {{ totalCount() }} schools - {{ activeCount() }} active - {{ archivedCount() }} archived
                </div>
            </div>
            <div class="schools-header__actions">
                <mb-button variant="primary" (click)="openAddSchool()">Add school</mb-button>
                <button type="button" class="schools-header__menu" #headerMenuOrigin
                    aria-label="More actions" (click)="toggleHeaderMenu()">
                    ...
                </button>
                <mb-popover [open]="headerMenuOpen()" [origin]="headerMenuOrigin" [hasBackdrop]="true"
                    [panelClass]="['mb-popover-panel', 'mb-popover-panel--above-modal', 'schools-menu__panel']"
                    (closed)="closeHeaderMenu()">
                    <div class="schools-menu__panel-content" role="menu">
                        <button type="button" class="schools-menu__item" (click)="headerImport()">Import CSV</button>
                        <button type="button" class="schools-menu__item" (click)="headerExport()">Export</button>
                        <div class="schools-menu__divider"></div>
                        <button type="button" class="schools-menu__item" (click)="viewArchived()">
                            View archived
                        </button>
                    </div>
                </mb-popover>
            </div>
        </div>

        <div class="schools-controls">
            <div class="schools-controls__left">
                <app-search-input [value]="searchQuery()" placeholder="Search schools..."
                    (search)="handleSearch($event)"></app-search-input>
                <mb-select ariaLabel="Filter by status" [options]="statusOptions" [value]="statusFilter()"
                    (valueChange)="updateStatusFilter($event)"></mb-select>
                <mb-select ariaLabel="Sort schools" [options]="sortOptions" [value]="sortBy()"
                    (valueChange)="updateSort($event)"></mb-select>
                <div class="schools-density" role="group" aria-label="Table density">
                    <button type="button" class="schools-density__button"
                        [class.is-active]="density() === 'comfortable'" [attr.aria-pressed]="density() === 'comfortable'"
                        (click)="toggleDensity('comfortable')">Comfortable</button>
                    <button type="button" class="schools-density__button"
                        [class.is-active]="density() === 'compact'" [attr.aria-pressed]="density() === 'compact'"
                        (click)="toggleDensity('compact')">Compact</button>
                </div>
            </div>
            <div class="schools-controls__right">
                <div class="schools-controls__count">{{ filteredCount() }} results</div>
            </div>
        </div>

        <div class="schools-bulk" *ngIf="selectedCount() > 0">
            <div class="schools-bulk__label">{{ selectedCount() }} selected</div>
            <div class="schools-bulk__actions">
                <mb-button size="sm" variant="secondary" (click)="bulkArchive()">Archive</mb-button>
                <mb-button size="sm" variant="tertiary" (click)="bulkExport()">Export</mb-button>
                <button type="button" class="schools-bulk__menu" #bulkMenuOrigin
                    aria-label="Bulk actions" (click)="toggleBulkMenu()">...</button>
                <mb-popover [open]="bulkMenuOpen()" [origin]="bulkMenuOrigin" [hasBackdrop]="true"
                    [panelClass]="['mb-popover-panel', 'mb-popover-panel--above-modal', 'schools-menu__panel']"
                    (closed)="closeBulkMenu()">
                    <div class="schools-menu__panel-content" role="menu">
                        <button type="button" class="schools-menu__item schools-menu__item--danger"
                            (click)="openBulkDelete()">Delete...</button>
                    </div>
                </mb-popover>
            </div>
        </div>

        <div class="schools-table-wrap" *ngIf="filteredCount() > 0; else emptyState">
            <mb-table class="schools-table" [class.is-compact]="density() === 'compact'"
                [columns]="schoolTableColumns" [rows]="pagedSchools()" [rowKey]="rowKey" [rowClass]="rowClass"
                [selectable]="true" [sortLocal]="false" (selectionChange)="handleSelectionChange($event)"
                (rowClick)="openDrawer($event)">
                <ng-template mbTableActions let-row>
                    <div class="schools-table__actions">
                        <button type="button" class="schools-menu__toggle" #schoolMenuOrigin
                            aria-label="Row actions" [attr.aria-expanded]="rowMenuOpenId() === row.id"
                            (click)="toggleRowMenu(row, $event)">...</button>
                        <mb-popover [open]="rowMenuOpenId() === row.id" [origin]="schoolMenuOrigin"
                            [hasBackdrop]="true"
                            [panelClass]="['mb-popover-panel', 'mb-popover-panel--above-modal', 'schools-menu__panel']"
                            (closed)="closeRowMenu()">
                            <div class="schools-menu__panel-content" role="menu">
                                <button type="button" class="schools-menu__item"
                                    (click)="openEditSchool(row); closeRowMenu()">Edit</button>
                                <button type="button" class="schools-menu__item"
                                    (click)="duplicateSchool(row); closeRowMenu()">Duplicate</button>
                                <div class="schools-menu__divider"></div>
                                <button type="button" class="schools-menu__item"
                                    (click)="row.status === 'archived' ? restoreSchool(row) : openArchiveConfirm(row); closeRowMenu()">
                                    {{ row.status === 'archived' ? 'Restore' : 'Archive' }}
                                </button>
                                <div class="schools-menu__divider"></div>
                                <button type="button" class="schools-menu__item schools-menu__item--submenu" #dangerMenuOrigin
                                    (click)="toggleRowDangerMenu(row, $event)">
                                    Danger zone >
                                </button>
                                <mb-popover [open]="rowDangerMenuOpenId() === row.id" [origin]="dangerMenuOrigin"
                                    [hasBackdrop]="false"
                                    [panelClass]="['mb-popover-panel', 'mb-popover-panel--above-modal', 'schools-menu__panel', 'schools-menu__panel--submenu']">
                                    <div class="schools-menu__panel-content" role="menu">
                                        <button type="button" class="schools-menu__item schools-menu__item--danger"
                                            (click)="openDeleteConfirm([row]); closeRowMenu()">Delete school...</button>
                                    </div>
                                </mb-popover>
                            </div>
                        </mb-popover>
                    </div>
                </ng-template>
            </mb-table>

            <div class="schools-pagination">
                <div class="schools-pagination__meta">
                    Page {{ pageIndex() }} of {{ pageCount() }}
                </div>
                <div class="schools-pagination__controls">
                    <button type="button" class="schools-pagination__nav" (click)="updatePage(pageIndex() - 1)"
                        [disabled]="pageIndex() === 1" aria-label="Previous page">
                        Prev
                    </button>
                    <button *ngFor="let page of pageNumbers()" type="button" class="schools-pagination__page"
                        [class.is-active]="pageIndex() === page" (click)="updatePage(page)">
                        {{ page }}
                    </button>
                    <button type="button" class="schools-pagination__nav" (click)="updatePage(pageIndex() + 1)"
                        [disabled]="pageIndex() === pageCount()" aria-label="Next page">
                        Next
                    </button>
                </div>
                <div class="schools-pagination__size">
                    <span>Rows per page</span>
                    <mb-select ariaLabel="Rows per page" [options]="pageSizeOptions" [value]="pageSizeValue()"
                        (valueChange)="updatePageSize($event)"></mb-select>
                </div>
            </div>
        </div>

        <ng-template #emptyState>
            <div class="schools-empty">
                <div class="schools-empty__icon" aria-hidden="true"></div>
                <div class="schools-empty__title">No schools found</div>
                <div class="schools-empty__text">
                    {{ hasFilters() ? 'Try adjusting your filters or search.' :
                    'Add a school to start enrolling students and assigning staff.' }}
                </div>
                <div class="schools-empty__actions">
                    <mb-button variant="primary" (click)="openAddSchool()">Add school</mb-button>
                    <mb-button variant="secondary" *ngIf="hasFilters()" (click)="clearFilters()">Clear filters</mb-button>
                </div>
            </div>
        </ng-template>

        <mb-drawer [open]="!!drawerSchool()" title="" panelClass="schools-drawer" (closed)="closeDrawer()">
            <ng-container *ngIf="drawerSchool() as selected">
                <div class="schools-drawer__header">
                    <div>
                        <div class="schools-drawer__title">{{ selected.name }}</div>
                        <div class="schools-drawer__meta">
                            <span class="schools-status" [class.is-archived]="selected.status === 'archived'">
                                {{ statusLabel(selected.status) }}
                            </span>
                        </div>
                    </div>
                </div>
                <div class="schools-drawer__section">
                    <div class="schools-drawer__section-title">Basics</div>
                    <div class="schools-drawer__grid">
                        <div>
                            <div class="schools-drawer__label">Code</div>
                            <div class="schools-drawer__value">{{ selected.code }}</div>
                        </div>
                        <div>
                            <div class="schools-drawer__label">Location</div>
                            <div class="schools-drawer__value">{{ selected.locationCountry || '--' }}</div>
                        </div>
                        <div>
                            <div class="schools-drawer__label">Time zone</div>
                            <div class="schools-drawer__value">{{ selected.timeZone || '--' }}</div>
                        </div>
                    </div>
                </div>
                <div class="schools-drawer__section">
                    <div class="schools-drawer__section-title">Metadata</div>
                    <div class="schools-drawer__grid">
                        <div>
                            <div class="schools-drawer__label">Created</div>
                            <div class="schools-drawer__value">{{ formatDate(selected.createdAt) }}</div>
                        </div>
                        <div>
                            <div class="schools-drawer__label">Last updated</div>
                            <div class="schools-drawer__value">{{ formatDate(selected.updatedAt) }}</div>
                        </div>
                    </div>
                </div>
                <div mbDrawerFooter class="schools-drawer__footer">
                    <mb-button variant="primary" (click)="openEditSchool(selected)">Edit school</mb-button>
                    <mb-button variant="secondary"
                        (click)="selected.status === 'archived' ? restoreSchool(selected) : openArchiveConfirm(selected)">
                        {{ selected.status === 'archived' ? 'Restore' : 'Archive' }}
                    </mb-button>
                    <div class="schools-drawer__menu" [class.open]="rowMenuOpenId() === selected.id">
                        <button type="button" class="schools-menu__toggle" #drawerMenuOrigin
                            aria-label="More actions" (click)="toggleRowMenu(selected, $event)">...</button>
                        <mb-popover [open]="rowMenuOpenId() === selected.id" [origin]="drawerMenuOrigin"
                            [hasBackdrop]="true"
                            [panelClass]="['mb-popover-panel', 'mb-popover-panel--above-modal', 'schools-menu__panel']"
                            (closed)="closeRowMenu()">
                            <div class="schools-menu__panel-content" role="menu">
                                <button type="button" class="schools-menu__item"
                                    (click)="duplicateSchool(selected); closeRowMenu()">Duplicate</button>
                                <div class="schools-menu__divider"></div>
                                <button type="button" class="schools-menu__item schools-menu__item--danger"
                                    (click)="openDeleteConfirm([selected]); closeRowMenu()">Delete school...</button>
                            </div>
                        </mb-popover>
                    </div>
                </div>
            </ng-container>
        </mb-drawer>

        <mb-modal [open]="isSchoolModalOpen()" [title]="editingSchoolId() ? 'Edit school' : 'Add school'" size="md"
            (closed)="closeSchoolModal()">
            <div class="schools-modal">
                <mb-form-field label="School name" [controlId]="'school-form-name'" [error]="schoolNameError()">
                    <mb-input id="school-form-name" [value]="schoolFormName()"
                        (valueChange)="schoolFormName.set($event)" (blurEvent)="schoolFormTouched.set(true)"></mb-input>
                </mb-form-field>
                <mb-form-field label="School code" [controlId]="'school-form-code'" [error]="schoolCodeError()">
                    <mb-input id="school-form-code" [value]="schoolFormCode()"
                        (valueChange)="schoolFormCode.set($event)" (blurEvent)="schoolFormTouched.set(true)"></mb-input>
                </mb-form-field>
                <mb-form-field label="Country" [controlId]="'school-form-country'" [error]="schoolCountryError()">
                    <mb-input id="school-form-country" [value]="schoolFormCountry()"
                        (valueChange)="schoolFormCountry.set($event)" (blurEvent)="schoolFormTouched.set(true)"></mb-input>
                </mb-form-field>
                <mb-form-field label="Time zone" [controlId]="'school-form-timezone'" [error]="schoolTimezoneError()">
                    <mb-input id="school-form-timezone" [value]="schoolFormTimezone()"
                        (valueChange)="schoolFormTimezone.set($event)" (blurEvent)="schoolFormTouched.set(true)"></mb-input>
                </mb-form-field>
            </div>
            <div mbModalFooter class="schools-modal__footer">
                <mb-button variant="secondary" (click)="closeSchoolModal()">Cancel</mb-button>
                <mb-button variant="primary" [disabled]="!canSaveSchool()" (click)="saveSchool()">
                    {{ editingSchoolId() ? 'Update school' : 'Add school' }}
                </mb-button>
            </div>
        </mb-modal>

        <mb-modal [open]="archiveConfirmOpen()" title="Archive school" size="sm" (closed)="closeArchiveConfirm()">
            <div class="schools-confirm">
                <div class="schools-confirm__title">
                    Archive {{ archiveTargetName() }}?
                </div>
                <div class="schools-confirm__text">You can restore this school later.</div>
            </div>
            <div mbModalFooter class="schools-modal__footer">
                <mb-button variant="secondary" (click)="closeArchiveConfirm()">Cancel</mb-button>
                <mb-button variant="primary" (click)="confirmArchive()">Archive</mb-button>
            </div>
        </mb-modal>

        <mb-modal [open]="deleteConfirmOpen()" title="Delete school" size="sm" (closed)="closeDeleteConfirm()">
            <div class="schools-confirm">
                <div class="schools-confirm__text">
                    This action is permanent. Type
                    <strong>{{ deleteConfirmRequiredText() }}</strong>
                    to confirm.
                </div>
                <mb-form-field label="Confirmation" [controlId]="'delete-confirm-input'">
                    <mb-input id="delete-confirm-input" cdkFocusInitial [value]="deleteConfirmInput()"
                        (valueChange)="deleteConfirmInput.set($event)" (blurEvent)="deleteConfirmTouched.set(true)">
                    </mb-input>
                </mb-form-field>
                <div class="schools-confirm__error" *ngIf="deleteConfirmTouched() && !deleteConfirmReady()">
                    Enter the exact confirmation text to continue.
                </div>
            </div>
            <div mbModalFooter class="schools-modal__footer">
                <mb-button variant="secondary" (click)="closeDeleteConfirm()">Cancel</mb-button>
                <mb-button variant="danger" [disabled]="!deleteConfirmReady()" (click)="confirmDelete()">
                    Delete
                </mb-button>
            </div>
        </mb-modal>
    </div>
</div>
