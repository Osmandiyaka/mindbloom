<div class="student-form">
    @if (error()) {
    <div class="form-error">{{ error() }}</div>
    }
    @if (saveNotice()) {
    <div class="form-success">{{ saveNotice() }}</div>
    }

    <div class="modal-grid">
        <div class="modal-column">
            <div class="section-title">
                <h3>Student identity</h3>
                <p>Core identity details.</p>
            </div>
            <div class="section-body" [formGroup]="personalInfoForm">
                <div class="field-grid two-cols">
                    <mb-form-field
                        class="form-field"
                        label="First name"
                        [required]="isRequiredField('firstName')"
                        [error]="isFieldInvalid(personalInfoForm, 'firstName') ? fieldError(personalInfoForm, 'firstName', 'First name') : ''">
                        <mb-input
                            formControlName="firstName"
                            [invalid]="isFieldInvalid(personalInfoForm, 'firstName')"
                            placeholder="e.g. Ama"
                            [autofocus]="true"
                            (blurEvent)="onDuplicateFieldBlur()">
                        </mb-input>
                    </mb-form-field>
                    <mb-form-field
                        class="form-field"
                        label="Last name"
                        [required]="isRequiredField('lastName')"
                        [error]="isFieldInvalid(personalInfoForm, 'lastName') ? fieldError(personalInfoForm, 'lastName', 'Last name') : ''">
                        <mb-input
                            formControlName="lastName"
                            [invalid]="isFieldInvalid(personalInfoForm, 'lastName')"
                            placeholder="e.g. Mensah"
                            (blurEvent)="onDuplicateFieldBlur()">
                        </mb-input>
                    </mb-form-field>
                </div>
                <div class="field-grid two-cols">
                    <mb-form-field class="form-field" label="Preferred name">
                        <mb-input formControlName="middleName" placeholder="Optional"></mb-input>
                    </mb-form-field>
                    <mb-form-field
                        class="form-field"
                        label="Date of birth"
                        [required]="isRequiredField('dateOfBirth')"
                        [error]="isFieldInvalid(personalInfoForm, 'dateOfBirth') ? fieldError(personalInfoForm, 'dateOfBirth', 'Date of birth') : ''">
                        <mb-input
                            type="date"
                            formControlName="dateOfBirth"
                            [invalid]="isFieldInvalid(personalInfoForm, 'dateOfBirth')"
                            placeholder="DD/MM/YYYY"
                            (blurEvent)="onDuplicateFieldBlur()">
                        </mb-input>
                    </mb-form-field>
                </div>
                <div class="field-grid two-cols">
                    <mb-form-field
                        class="form-field"
                        label="Gender"
                        [required]="isRequiredField('gender')"
                        [error]="isFieldInvalid(personalInfoForm, 'gender') ? fieldError(personalInfoForm, 'gender', 'Gender') : ''">
                        <mb-select
                            placeholder="Select gender"
                            [options]="genderOptions"
                            formControlName="gender"
                            [invalid]="isFieldInvalid(personalInfoForm, 'gender')">
                        </mb-select>
                    </mb-form-field>
                    <mb-form-field
                        class="form-field"
                        label="Email"
                        [error]="isFieldInvalid(personalInfoForm, 'email') ? fieldError(personalInfoForm, 'email', 'Email') : ''">
                        <mb-input type="email" formControlName="email" placeholder="e.g. ama@school.com" [invalid]="isFieldInvalid(personalInfoForm, 'email')"></mb-input>
                    </mb-form-field>
                </div>
                <div class="field-grid two-cols">
                    <mb-form-field
                        class="form-field"
                        label="Phone"
                        [error]="isFieldInvalid(personalInfoForm, 'phone') ? fieldError(personalInfoForm, 'phone', 'Phone') : ''">
                        <mb-input type="tel" formControlName="phone" placeholder="e.g. +233 20 000 0000" [invalid]="isFieldInvalid(personalInfoForm, 'phone')"></mb-input>
                    </mb-form-field>
                    <mb-form-field class="form-field" label="Nationality">
                        <mb-input formControlName="nationality" placeholder="e.g. Ghanaian"></mb-input>
                    </mb-form-field>
                </div>
                <div formGroupName="address" class="field-grid">
                    <mb-form-field class="form-field full" label="Address line 1">
                        <mb-input formControlName="street" placeholder="Street address"></mb-input>
                    </mb-form-field>
                </div>
                <div formGroupName="address" class="field-grid two-cols">
                    <mb-form-field class="form-field" label="City">
                        <mb-input formControlName="city" placeholder="City"></mb-input>
                    </mb-form-field>
                    <mb-form-field class="form-field" label="State">
                        <mb-input formControlName="state" placeholder="State/Region"></mb-input>
                    </mb-form-field>
                </div>
                <div formGroupName="address" class="field-grid two-cols">
                    <mb-form-field class="form-field" label="Postal code">
                        <mb-input formControlName="postalCode" placeholder="Postal code"></mb-input>
                    </mb-form-field>
                    <mb-form-field class="form-field" label="Country">
                        <mb-input formControlName="country" placeholder="Country"></mb-input>
                    </mb-form-field>
                </div>
            </div>

            @if (duplicateLoading()) {
            <div class="duplicate-panel is-loading">
                <p>Checking for possible duplicates…</p>
            </div>
            } @else if (duplicateError()) {
            <div class="duplicate-panel is-error">
                <p>{{ duplicateError() }}</p>
            </div>
            } @else if (duplicateMatches().length) {
            <div class="duplicate-panel">
                <div class="duplicate-header">
                    <div>
                        <h4>Possible duplicates found</h4>
                        <p>Review matches before creating a new record.</p>
                    </div>
                    <mb-button size="sm" variant="tertiary" (click)="clearDuplicates()">Create anyway</mb-button>
                </div>
                <div class="duplicate-list">
                    <div class="duplicate-row" *ngFor="let match of duplicateMatches()">
                        <div class="duplicate-meta">
                            <span class="duplicate-name">{{ match.fullName }}</span>
                            <span class="duplicate-sub">{{ match.enrollment.class }} {{ match.enrollment.section }} • {{ match.status }}</span>
                        </div>
                        <mb-button size="sm" variant="tertiary" (click)="openDuplicate(match)">View student</mb-button>
                    </div>
                </div>
            </div>
            }
        </div>

        <div class="modal-column">
            <div class="section-title">
                <h3>Enrollment (optional)</h3>
            </div>
            <div class="section-body" [formGroup]="enrollmentForm">
                @if (!canManageEnrollment()) {
                <p class="permission-note">You do not have permission to edit enrollment.</p>
                }
                @if (showSchoolSelector()) {
                <div class="field-grid">
                    <mb-form-field class="form-field" label="School" [required]="true">
                        <mb-select
                            placeholder="Select school"
                            [options]="schoolOptions()"
                            [value]="schoolId() || ''"
                            [disabled]="!canManageEnrollment()"
                            (valueChange)="handleSchoolChange($event)">
                        </mb-select>
                    </mb-form-field>
                </div>
                }
                <div formGroupName="enrollment" class="field-grid two-cols">
                    <mb-form-field class="form-field" label="Academic year" [required]="true">
                        <mb-select
                            [placeholder]="academicYearLoading() ? 'Loading academic years...' : 'Select academic year'"
                            [options]="academicYearOptions"
                            [disabled]="!canManageEnrollment() || academicYearLoading()"
                            formControlName="academicYear"
                            (valueChange)="onDuplicateFieldBlur()">
                        </mb-select>
                    </mb-form-field>
                    <mb-form-field class="form-field" label="Enrollment date" [required]="true">
                        <mb-input type="date" [disabled]="!canManageEnrollment()" formControlName="admissionDate" placeholder="DD/MM/YYYY"></mb-input>
                    </mb-form-field>
                </div>
                <div class="field-grid two-cols">
                    <mb-form-field class="form-field" label="Class">
                        <mb-select
                            [placeholder]="classLoading() ? 'Loading classes...' : 'Select class'"
                            [options]="classOptions()"
                            [disabled]="!canManageEnrollment() || classLoading()"
                            [value]="selectedClassId() || ''"
                            (valueChange)="handleClassSelect($event)">
                        </mb-select>
                    </mb-form-field>
                    <mb-form-field class="form-field" label="Section">
                        <mb-select
                            [placeholder]="sectionLoading() ? 'Loading sections...' : 'Select section'"
                            [options]="sectionOptions()"
                            [disabled]="!canManageEnrollment() || sectionLoading() || !selectedClassId()"
                            [value]="selectedSectionId() || ''"
                            (valueChange)="handleSectionSelect($event)">
                        </mb-select>
                    </mb-form-field>
                </div>
                <p class="field-helper">Select a class to load sections.</p>
                @if (!academicYearLoading() && !academicYearOptions.length) {
                <p class="permission-note">No academic year configured yet.</p>
                }
            </div>

            <div class="section-title guardian-title">
                <button type="button" class="accordion-toggle" (click)="toggleGuardianAccordion()">
                    <span>Primary guardian (optional)</span>
                    <span class="chevron" [class.open]="guardianExpanded()">▾</span>
                </button>
            </div>
            @if (!guardianExpanded()) {
            <p class="guardian-empty">Add guardian details if needed.</p>
            } @else {
            <div class="section-body" [formGroup]="guardiansForm">
                @if (!canManageGuardians()) {
                <p class="guardian-empty">You do not have permission to add guardians.</p>
                } @else {
                <div formArrayName="guardians">
                    <div class="field-grid two-cols" *ngIf="guardians.length" [formGroupName]="0">
                        <mb-form-field class="form-field" label="Full name" [required]="true">
                            <mb-input formControlName="name" placeholder="Guardian name"></mb-input>
                        </mb-form-field>
                        <mb-form-field class="form-field" label="Relationship" [required]="true">
                            <mb-select
                                [placeholder]="guardianRelationshipsLoading() ? 'Loading relationships...' : 'Select relationship'"
                                [options]="guardianRelationshipSelectOptions()"
                                [disabled]="guardianRelationshipsLoading()"
                                formControlName="relationship">
                            </mb-select>
                        </mb-form-field>
                    </div>
                    <div class="field-grid two-cols" *ngIf="guardians.length" [formGroupName]="0">
                        <mb-form-field class="form-field" label="Phone" [required]="true">
                            <mb-input type="tel" formControlName="phone" placeholder="Phone number"></mb-input>
                        </mb-form-field>
                        <mb-form-field class="form-field" label="Email">
                            <mb-input type="email" formControlName="email" placeholder="Email address"></mb-input>
                        </mb-form-field>
                    </div>
                    <button type="button" class="text-link" (click)="toggleGuardianDetails()">Add more details</button>
                    @if (guardianDetailsExpanded()) {
                    <div class="field-grid two-cols" *ngIf="guardians.length" [formGroupName]="0">
                        <mb-form-field class="form-field" label="Occupation">
                            <mb-input formControlName="occupation" placeholder="Occupation"></mb-input>
                        </mb-form-field>
                    </div>
                    <div *ngIf="guardians.length" [formGroupName]="0">
                        <div class="field-grid two-cols" formGroupName="address">
                            <mb-form-field class="form-field" label="Street">
                                <mb-input formControlName="street" placeholder="Street"></mb-input>
                            </mb-form-field>
                            <mb-form-field class="form-field" label="City">
                                <mb-input formControlName="city" placeholder="City"></mb-input>
                            </mb-form-field>
                            <mb-form-field class="form-field" label="State">
                                <mb-input formControlName="state" placeholder="State/Region"></mb-input>
                            </mb-form-field>
                            <mb-form-field class="form-field" label="Postal code">
                                <mb-input formControlName="postalCode" placeholder="Postal code"></mb-input>
                            </mb-form-field>
                        </div>
                    </div>
                    }
                    <div class="guardian-actions">
                        <mb-button size="sm" variant="tertiary" (click)="addGuardian()">+ Add another guardian</mb-button>
                    </div>
                    <div class="extra-guardians" *ngIf="guardians.length > 1">
                        <div class="extra-guardian" *ngFor="let guardian of guardians.controls; let i = index" [formGroupName]="i">
                            @if (i > 0) {
                            <div class="extra-header">
                                <span>Guardian {{ i + 1 }}</span>
                                <mb-button size="sm" variant="tertiary" (click)="removeGuardian(i)">Remove</mb-button>
                            </div>
                            <div class="field-grid two-cols">
                                <mb-form-field class="form-field" label="Full name">
                                    <mb-input formControlName="name"></mb-input>
                                </mb-form-field>
                                <mb-form-field class="form-field" label="Relationship">
                                    <mb-select
                                        [placeholder]="guardianRelationshipsLoading() ? 'Loading relationships...' : 'Select relationship'"
                                        [options]="guardianRelationshipSelectOptions()"
                                        [disabled]="guardianRelationshipsLoading()"
                                        formControlName="relationship">
                                    </mb-select>
                                </mb-form-field>
                            </div>
                            <div class="field-grid two-cols">
                                <mb-form-field class="form-field" label="Phone">
                                    <mb-input type="tel" formControlName="phone"></mb-input>
                                </mb-form-field>
                                <mb-form-field class="form-field" label="Email">
                                    <mb-input type="email" formControlName="email"></mb-input>
                                </mb-form-field>
                            </div>
                            }
                        </div>
                    </div>
                </div>
                }
            </div>
            }
        </div>
    </div>
</div>
