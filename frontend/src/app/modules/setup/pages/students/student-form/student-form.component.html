<div class="student-form">
    @if (error()) {
    <div class="form-error">{{ error() }}</div>
    }
    @if (saveNotice()) {
    <div class="form-success">{{ saveNotice() }}</div>
    }

    <div class="form-grid">
        <div class="form-column">
            <section class="form-section">
                <div class="section-header">
                    <h3>Student identity</h3>
                    <p>Core identity details.</p>
                </div>
                <div class="section-body" [formGroup]="personalInfoForm">
                    <div class="field-grid two-cols">
                        <label class="form-field">
                            First name <span class="required" *ngIf="isRequiredField('firstName')">*</span>
                            <mb-input
                                formControlName="firstName"
                                [invalid]="isFieldInvalid(personalInfoForm, 'firstName')"
                                [autofocus]="true"
                                (blurEvent)="onDuplicateFieldBlur()">
                            </mb-input>
                            <span class="field-error" *ngIf="isFieldInvalid(personalInfoForm, 'firstName')">
                                {{ fieldError(personalInfoForm, 'firstName', 'First name') }}
                            </span>
                        </label>
                        <label class="form-field">
                            Last name <span class="required" *ngIf="isRequiredField('lastName')">*</span>
                            <mb-input
                                formControlName="lastName"
                                [invalid]="isFieldInvalid(personalInfoForm, 'lastName')"
                                (blurEvent)="onDuplicateFieldBlur()">
                            </mb-input>
                            <span class="field-error" *ngIf="isFieldInvalid(personalInfoForm, 'lastName')">
                                {{ fieldError(personalInfoForm, 'lastName', 'Last name') }}
                            </span>
                        </label>
                    </div>
                    <div class="field-grid two-cols">
                        <label class="form-field">
                            Preferred name
                            <mb-input formControlName="middleName"></mb-input>
                        </label>
                        <label class="form-field">
                            Date of birth <span class="required" *ngIf="isRequiredField('dateOfBirth')">*</span>
                            <mb-input
                                type="date"
                                formControlName="dateOfBirth"
                                [invalid]="isFieldInvalid(personalInfoForm, 'dateOfBirth')"
                                (blurEvent)="onDuplicateFieldBlur()">
                            </mb-input>
                            <span class="field-error" *ngIf="isFieldInvalid(personalInfoForm, 'dateOfBirth')">
                                {{ fieldError(personalInfoForm, 'dateOfBirth', 'Date of birth') }}
                            </span>
                        </label>
                    </div>
                    <div class="field-grid two-cols">
                        <label class="form-field">
                            Gender <span class="required" *ngIf="isRequiredField('gender')">*</span>
                            <mb-select
                                placeholder="Select gender"
                                [options]="genderOptions"
                                formControlName="gender"
                                [invalid]="isFieldInvalid(personalInfoForm, 'gender')">
                            </mb-select>
                            <span class="field-error" *ngIf="isFieldInvalid(personalInfoForm, 'gender')">
                                {{ fieldError(personalInfoForm, 'gender', 'Gender') }}
                            </span>
                        </label>
                        <label class="form-field">
                            Email
                            <mb-input type="email" formControlName="email" [invalid]="isFieldInvalid(personalInfoForm, 'email')"></mb-input>
                            <span class="field-error" *ngIf="isFieldInvalid(personalInfoForm, 'email')">
                                {{ fieldError(personalInfoForm, 'email', 'Email') }}
                            </span>
                        </label>
                    </div>
                    <div class="field-grid two-cols">
                        <label class="form-field">
                            Phone
                            <mb-input type="tel" formControlName="phone" [invalid]="isFieldInvalid(personalInfoForm, 'phone')"></mb-input>
                            <span class="field-error" *ngIf="isFieldInvalid(personalInfoForm, 'phone')">
                                {{ fieldError(personalInfoForm, 'phone', 'Phone') }}
                            </span>
                        </label>
                        <label class="form-field">
                            Nationality
                            <mb-input formControlName="nationality"></mb-input>
                        </label>
                    </div>
                    <div formGroupName="address" class="field-grid two-cols">
                        <label class="form-field">
                            Street
                            <mb-input formControlName="street"></mb-input>
                        </label>
                        <label class="form-field">
                            City
                            <mb-input formControlName="city"></mb-input>
                        </label>
                        <label class="form-field">
                            State
                            <mb-input formControlName="state"></mb-input>
                        </label>
                        <label class="form-field">
                            Postal code
                            <mb-input formControlName="postalCode"></mb-input>
                        </label>
                        <label class="form-field">
                            Country
                            <mb-input formControlName="country"></mb-input>
                        </label>
                    </div>
                </div>
            </section>

            @if (duplicateLoading()) {
            <div class="duplicate-panel is-loading">
                <p>Checking for possible duplicates…</p>
            </div>
            } @else if (duplicateError()) {
            <div class="duplicate-panel is-error">
                <p>{{ duplicateError() }}</p>
            </div>
            } @else if (duplicateMatches().length) {
            <div class="duplicate-panel">
                <div class="duplicate-header">
                    <div>
                        <h4>Possible duplicates found</h4>
                        <p>Review matches before creating a new record.</p>
                    </div>
                    <mb-button size="sm" variant="tertiary" (click)="clearDuplicates()">Create anyway</mb-button>
                </div>
                <div class="duplicate-list">
                    <div class="duplicate-row" *ngFor="let match of duplicateMatches()">
                        <div class="duplicate-meta">
                            <span class="duplicate-name">{{ match.fullName }}</span>
                            <span class="duplicate-sub">{{ match.enrollment.class }} {{ match.enrollment.section }} • {{ match.status }}</span>
                        </div>
                        <mb-button size="sm" variant="tertiary" (click)="openDuplicate(match)">View student</mb-button>
                    </div>
                </div>
            </div>
            }

            <section class="form-section">
                <div class="section-header">
                    <h3>Identifiers</h3>
                    <p>Record identifiers.</p>
                </div>
                <div class="section-body" [formGroup]="enrollmentForm">
                    <div formGroupName="enrollment" class="field-grid two-cols">
                        <label class="form-field">
                            Admission number
                            <mb-input formControlName="admissionNumber"></mb-input>
                        </label>
                        <label class="form-field">
                            Roll number
                            <mb-input formControlName="rollNumber"></mb-input>
                        </label>
                    </div>
                </div>
            </section>
        </div>

        <div class="form-column">
            <section class="form-section">
                <div class="section-header">
                    <h3>Enrollment</h3>
                    <p>Current-year placement.</p>
                </div>
                <div class="section-body" [formGroup]="enrollmentForm">
                    @if (!canManageEnrollment()) {
                    <p class="permission-note">You do not have permission to edit enrollment.</p>
                    }
                    @if (showSchoolSelector()) {
                    <div class="field-grid">
                        <label class="form-field">
                            School <span class="required">*</span>
                            <mb-select
                                placeholder="Select school"
                                [options]="schoolOptions()"
                                [value]="schoolId() || ''"
                                [disabled]="!canManageEnrollment()"
                                (valueChange)="handleSchoolChange($event)">
                            </mb-select>
                        </label>
                    </div>
                    }
                    <div formGroupName="enrollment" class="field-grid two-cols">
                        <label class="form-field">
                            Academic year <span class="required">*</span>
                            <mb-select
                                [placeholder]="academicYearLoading() ? 'Loading academic years...' : 'Select academic year'"
                                [options]="academicYearOptions"
                                [disabled]="!canManageEnrollment() || academicYearLoading()"
                                formControlName="academicYear"
                                (valueChange)="onDuplicateFieldBlur()">
                            </mb-select>
                        </label>
                        <label class="form-field">
                            Enrollment date <span class="required">*</span>
                            <mb-input type="date" [disabled]="!canManageEnrollment()" formControlName="admissionDate"></mb-input>
                        </label>
                    </div>
                    <div class="field-grid">
                        <mb-class-status-selector
                            [classId]="selectedClassId()"
                            [sectionId]="selectedSectionId()"
                            [showStatus]="false"
                            [disabled]="!canManageEnrollment()"
                            [title]="'Class & section'"
                            [subtitle]="'Select a class to load sections.'"
                            (classIdChange)="selectedClassId.set($event)"
                            (sectionIdChange)="selectedSectionId.set($event)"
                            (selectionChange)="applyPlacement($event)">
                        </mb-class-status-selector>
                    </div>
                    @if (!academicYearLoading() && !academicYearOptions.length) {
                    <p class="permission-note">No academic year configured yet.</p>
                    }
                </div>
            </section>

            <section class="form-section">
                <div class="section-header">
                    <h3>Guardian (primary)</h3>
                    <p>Primary guardian details.</p>
                </div>
                <div class="section-body" [formGroup]="guardiansForm">
                    @if (!canManageGuardians()) {
                    <p class="guardian-empty">You do not have permission to add guardians.</p>
                    } @else {
                    <div class="guardian-toggle">
                        <mb-checkbox
                            [checked]="guardianEnabled()"
                            [disabled]="guardianRequired()"
                            (checkedChange)="setGuardianEnabled($event)">
                            Add primary guardian now
                        </mb-checkbox>
                        @if (guardianRequired()) {
                        <span class="guardian-required">Required by policy</span>
                        }
                    </div>
                    @if (!guardianEnabled()) {
                    <p class="guardian-empty">Add guardians later from the Guardians tab.</p>
                    } @else {
                    <div formArrayName="guardians">
                        <div class="field-grid two-cols" *ngIf="guardians.length" [formGroupName]="0">
                            <label class="form-field">
                                Full name <span class="required">*</span>
                                <mb-input formControlName="name"></mb-input>
                            </label>
                            <label class="form-field">
                                Relationship <span class="required">*</span>
                                <mb-select
                                    [placeholder]="guardianRelationshipsLoading() ? 'Loading relationships...' : 'Select relationship'"
                                    [options]="guardianRelationshipSelectOptions()"
                                    [disabled]="guardianRelationshipsLoading()"
                                    formControlName="relationship">
                                </mb-select>
                            </label>
                            <label class="form-field">
                                Phone <span class="required">*</span>
                                <mb-input type="tel" formControlName="phone"></mb-input>
                            </label>
                            <label class="form-field">
                                Email
                                <mb-input type="email" formControlName="email"></mb-input>
                            </label>
                        </div>
                        <div class="guardian-actions">
                            <mb-button size="sm" variant="tertiary" (click)="addGuardian()">Add another guardian</mb-button>
                        </div>
                        <div class="extra-guardians" *ngIf="guardians.length > 1">
                            <div class="extra-guardian" *ngFor="let guardian of guardians.controls; let i = index" [formGroupName]="i">
                                @if (i > 0) {
                                <div class="extra-header">
                                    <span>Guardian {{ i + 1 }}</span>
                                    <mb-button size="sm" variant="tertiary" (click)="removeGuardian(i)">Remove</mb-button>
                                </div>
                                <div class="field-grid two-cols">
                                    <label class="form-field">
                                        Full name
                                        <mb-input formControlName="name"></mb-input>
                                    </label>
                                    <label class="form-field">
                                        Relationship
                                        <mb-select
                                            [placeholder]="guardianRelationshipsLoading() ? 'Loading relationships...' : 'Select relationship'"
                                            [options]="guardianRelationshipSelectOptions()"
                                            [disabled]="guardianRelationshipsLoading()"
                                            formControlName="relationship">
                                        </mb-select>
                                    </label>
                                    <label class="form-field">
                                        Phone
                                        <mb-input type="tel" formControlName="phone"></mb-input>
                                    </label>
                                    <label class="form-field">
                                        Email
                                        <mb-input type="email" formControlName="email"></mb-input>
                                    </label>
                                </div>
                                }
                            </div>
                        </div>
                    </div>
                    }
                    }
                </div>
            </section>
        </div>
    </div>
</div>
