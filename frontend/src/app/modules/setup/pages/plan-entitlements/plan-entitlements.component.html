<div class="plan-entitlements">
    <div class="page-header">
        <div>
            <h1>Plan & Entitlements</h1>
            <p class="subtitle">View what your current plan includes and compare available editions.</p>
        </div>
    </div>

    @if (loading()) {
    <div class="state-block">
        <div class="spinner"></div>
        <p>Loading plans...</p>
    </div>
    } @else if (error()) {
    <div class="state-block error">
        <p>{{ error() }}</p>
        <ui-button size="sm" variant="ghost" (click)="loading.set(true); error.set(null); reload()">Retry</ui-button>
    </div>
    } @else {
    <div class="plan-layout">
        <aside class="plan-list">
            <div class="plan-list__header">
                <div>
                    <h2>Plans</h2>
                    <p>Compare modules and limits across editions.</p>
                </div>
                <span class="pill pill--current">Current plan: {{ currentPlanName() }}</span>
            </div>
            <div class="plan-list__items">
                @for (edition of editions(); track edition.id) {
                <div
                    class="plan-row"
                    role="button"
                    tabindex="0"
                    [class.is-active]="isSelected(edition)"
                    [class.is-current]="editionStatus(edition) === 'current'"
                    [attr.title]="edition.requiresSales ? 'Contact sales' : null"
                    (click)="selectEdition(edition)"
                    (keydown.enter)="selectEdition(edition)"
                    (keydown.space)="$event.preventDefault(); selectEdition(edition)">
                    <div class="plan-row__main">
                        <div class="plan-row__title">
                            <span class="plan-name">{{ edition.name }}</span>
                            @if (edition.recommended) {
                            <span class="pill pill--accent">Recommended</span>
                            }
                        </div>
                    </div>
                    <div class="plan-row__meta">
                        <span class="price">{{ edition.priceLabel }}</span>
                        <span class="status-pill" [class]="'status-' + editionStatus(edition)">
                            {{ editionStatus(edition) === 'current' ? 'Current' : (editionStatus(edition) === 'requires_sales' ? 'Unavailable' : 'Available') }}
                        </span>
                    </div>
                </div>
                }
            </div>
        </aside>

        <div class="plan-detail">
            @if (!selectedEdition()) {
            <div class="state-block">
                <p>Select a plan to view included modules and limits.</p>
            </div>
            } @else {
            <div class="plan-summary">
                <div class="plan-summary__header">
                    <div class="plan-summary__content">
                        <div class="plan-summary__title">
                            <h2>{{ selectedEdition()?.name }}</h2>
                            @if (isViewingCurrent()) {
                            <span class="pill pill--success">Current plan</span>
                            }
                            @if (selectedEdition()?.recommended && !isViewingCurrent()) {
                            <span class="pill pill--accent">Recommended</span>
                            }
                        </div>
                        <div class="plan-summary__badges">
                            <span class="pill pill--soft">Billing: {{ billingLabel() }}</span>
                        </div>
                        <p class="plan-summary__description">{{ selectedEdition()?.description }}</p>
                    </div>
                    <div class="plan-summary__actions">
                        <div class="plan-summary__buttons">
                            @if (!isViewingCurrent()) {
                            <ui-button variant="primary" size="sm" (click)="openRequestModal()">
                                {{ primaryCtaLabel() }}
                            </ui-button>
                            } @else {
                            <span class="plan-summary__current-label">You're on {{ selectedEdition()?.name }}</span>
                            }
                            @if (!isViewingCurrent()) {
                            <ui-button variant="ghost" size="sm" (click)="toggleCompare()">
                                {{ compareMode() ? 'Exit compare' : 'Compare editions' }}
                            </ui-button>
                            }
                            <ui-button variant="ghost" size="sm" (click)="openCompareModal()">Compare plans</ui-button>
                            <div class="plan-overflow">
                                <ui-button variant="ghost" size="sm" (click)="toggleOverflow()">More</ui-button>
                                @if (overflowOpen()) {
                                <div class="plan-overflow__menu" role="menu">
                                    <button type="button" (click)="downloadPlanSummary()">Download plan summary</button>
                                    <button type="button" (click)="copyEntitlementSnapshot()">Copy entitlement snapshot</button>
                                </div>
                                }
                            </div>
                        </div>
                        <div class="plan-summary__entitlements">
                            <p class="entitlements-label">Entitlements</p>
                            <p>Source: {{ entitlementsSource() }} baseline</p>
                            <p>Last synced: {{ entitlementsLastSynced() }} • 2:00 PM</p>
                            <p>Applies to: Tenant</p>
                        </div>
                    </div>
                </div>
            </div>

            <div class="plan-summary__highlights">
                @for (item of selectedEdition()?.highlights || []; track item) {
                <span class="highlight">{{ item }}</span>
                }
            </div>

            <div class="plan-summary__metrics">
                @for (card of summaryCards(); track card.label) {
                <div class="metric-strip__item" [class.is-warning]="card.warning">
                    <p class="metric-label">{{ card.label }}</p>
                    <div class="metric-value">
                        <span>{{ card.value }}</span>
                        @if (card.warning) {
                        <span class="metric-badge">Over limit</span>
                        }
                    </div>
                    <p class="metric-subtext">{{ card.subtext }}</p>
                </div>
                }
            </div>

            <div class="plan-tabs" role="tablist" aria-label="Plan detail tabs">
                <button
                    type="button"
                    role="tab"
                    [attr.aria-selected]="activeTab() === 'modules'"
                    [class.active]="activeTab() === 'modules'"
                    (click)="activeTab.set('modules')">
                    Modules
                </button>
                <button
                    type="button"
                    role="tab"
                    [attr.aria-selected]="activeTab() === 'limits'"
                    [class.active]="activeTab() === 'limits'"
                    (click)="activeTab.set('limits')">
                    Features & Limits
                </button>
            </div>

            <div class="entitlement-source">
                <div>
                    <p class="source-title">Entitlement source</p>
                    <div class="source-items">
                        <div class="source-item">
                            <span class="source-check">✓</span>
                            <span>Edition baseline ({{ selectedEdition()?.name }})</span>
                        </div>
                        <div class="source-item">
                            <span class="source-check">✓</span>
                            <span>Tenant overrides applied</span>
                            <button type="button" class="tag tag--not_configured tag--clickable" (click)="openOverridesDrawer()">
                                {{ overrideCount() }} overrides
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            @if (activeTab() === 'modules') {
            <div class="modules-hint">
                Plan coverage = edition entitlement. Access state = tenant effective state.
            </div>
            <div class="modules-table" [class.is-compare]="compareMode() && !isViewingCurrent()">
                <div class="modules-table__header">
                    <span>Module</span>
                    <span>Plan coverage</span>
                    <span>Access state</span>
                    <span>Setup</span>
                    <span>Notes</span>
                    @if (compareMode() && !isViewingCurrent()) {
                    <span>Change</span>
                    }
                    <span>Actions</span>
                </div>
                @if (moduleRows().length === 0) {
                <div class="modules-empty">
                    <p>No modules available</p>
                    <span>This edition has no enabled modules yet.</span>
                    <ui-button size="sm" variant="ghost" (click)="openCompareModal()">Compare editions</ui-button>
                </div>
                }
                @for (row of moduleRows(); track row.key) {
                <div
                    class="modules-table__row"
                    [class.is-unchanged]="row.isUnchanged && compareMode() && !isViewingCurrent()"
                    [class.is-added]="row.isAdded && compareMode() && !isViewingCurrent()"
                    (click)="openModuleDetail(row.key)">
                    <div class="module-cell">
                        <span class="module-icon" aria-hidden="true">
                            @switch (row.icon) {
                            @case ('users') {
                            <svg viewBox="0 0 24 24"><path d="M17 21a4 4 0 0 0-4-4H7a4 4 0 0 0-4 4"></path><circle cx="9" cy="7" r="4"></circle><path d="M23 21a4 4 0 0 0-3-3.87"></path><path d="M16 3.13a4 4 0 0 1 0 7.75"></path></svg>
                            }
                            @case ('book-open') {
                            <svg viewBox="0 0 24 24"><path d="M2 4.5C2 3.12 3.12 2 4.5 2H12v20H4.5A2.5 2.5 0 0 1 2 19.5z"></path><path d="M22 19.5a2.5 2.5 0 0 1-2.5 2.5H12V2h7.5A2.5 2.5 0 0 1 22 4.5z"></path></svg>
                            }
                            @case ('banknote') {
                            <svg viewBox="0 0 24 24"><rect x="2" y="6" width="20" height="12" rx="2"></rect><circle cx="12" cy="12" r="3"></circle><path d="M6 10h0M18 14h0"></path></svg>
                            }
                            @case ('calculator') {
                            <svg viewBox="0 0 24 24"><rect x="4" y="2" width="16" height="20" rx="2"></rect><path d="M8 6h8"></path><path d="M8 10h0M12 10h0M16 10h0M8 14h0M12 14h0M16 14h0M8 18h0M12 18h0M16 18h0"></path></svg>
                            }
                            @case ('briefcase') {
                            <svg viewBox="0 0 24 24"><rect x="3" y="7" width="18" height="13" rx="2"></rect><path d="M9 7V5a3 3 0 0 1 6 0v2"></path><path d="M3 13h18"></path></svg>
                            }
                            @case ('book') {
                            <svg viewBox="0 0 24 24"><path d="M4 19.5A2.5 2.5 0 0 1 6.5 17H20"></path><path d="M4 4.5A2.5 2.5 0 0 1 6.5 2H20v20H6.5A2.5 2.5 0 0 1 4 19.5z"></path><path d="M8 2v15"></path></svg>
                            }
                            @case ('bus') {
                            <svg viewBox="0 0 24 24"><rect x="4" y="3" width="16" height="13" rx="2"></rect><path d="M4 8h16"></path><path d="M6 16h0M18 16h0"></path><path d="M8 20h8"></path></svg>
                            }
                            @case ('shield') {
                            <svg viewBox="0 0 24 24"><path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"></path></svg>
                            }
                            @case ('bar-chart') {
                            <svg viewBox="0 0 24 24"><path d="M3 3v18h18"></path><rect x="7" y="12" width="3" height="6"></rect><rect x="12" y="9" width="3" height="9"></rect><rect x="17" y="6" width="3" height="12"></rect></svg>
                            }
                            @default {
                            <svg viewBox="0 0 24 24"><path d="M22 19a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h5l2 2h9a2 2 0 0 1 2 2z"></path></svg>
                            }
                            }
                        </span>
                        <div>
                            <p class="module-name">{{ row.name }}</p>
                            <p class="module-desc">{{ row.description }}</p>
                        </div>
                    </div>
                    <div class="tag tag--access" [class]="'tag--' + row.access">{{ accessLabel(row.access) }}</div>
                    <div class="status-cell">
                        <span class="tag tag--status" [class]="'tag--' + row.status">{{ statusLabel(row.status) }}</span>
                        @if (row.lockReason) {
                        <button type="button" class="info-icon" (click)="toggleLockInfo(row.key, $event)" aria-label="Why locked?">
                            <svg viewBox="0 0 16 16" aria-hidden="true">
                                <circle cx="8" cy="8" r="7"></circle>
                                <path d="M8 11v-3"></path>
                                <path d="M8 5h.01"></path>
                            </svg>
                        </button>
                        }
                        @if (activeLockInfo() === row.key && row.lockReason) {
                        <div class="lock-popover" role="tooltip">
                            {{ row.lockReason }}
                        </div>
                        }
                    </div>
                    <div class="setup-cell">
                        @if (row.needsSetup) {
                        <span class="setup-label">Setup required</span>
                        <ui-button size="sm" variant="ghost" (click)="startSetup(row.key, $event)">Complete setup</ui-button>
                        } @else {
                        <span class="setup-label muted">Ready</span>
                        }
                    </div>
                    <p class="notes">{{ row.notes || '—' }}</p>
                    @if (compareMode() && !isViewingCurrent()) {
                    <p class="compare">{{ row.change }}</p>
                    }
                    <ui-button size="sm" variant="ghost" class="row-action" (click)="$event.stopPropagation()">⋯</ui-button>
                </div>
                }
            </div>
            } @else {
            <div class="limits-groups">
                <div class="limits-group">
                    <h3>Limits</h3>
                    <div class="limits-table">
                        <div class="limits-row"><span>Users</span><span>{{ limitValue(selectedEdition()!, 'Users') }}</span></div>
                        <div class="limits-row"><span>Schools</span><span>{{ limitValue(selectedEdition()!, 'Schools') }}</span></div>
                        <div class="limits-row"><span>Storage</span><span>{{ limitValue(selectedEdition()!, 'Storage') }}</span></div>
                        <div class="limits-row"><span>Classes/Sections</span><span>Unlimited</span></div>
                    </div>
                </div>
                <div class="limits-group">
                    <h3>Security</h3>
                    <div class="limits-table">
                        <div class="limits-row"><span>SSO</span><span>{{ selectedEdition()?.id === 'enterprise' ? 'Included' : 'Add-on' }}</span></div>
                        <div class="limits-row"><span>Audit log retention</span><span>{{ isViewingCurrent() ? '90 days' : '365 days' }}</span></div>
                        <div class="limits-row"><span>MFA</span><span>{{ selectedEdition()?.id === 'enterprise' ? 'Included' : 'Available' }}</span></div>
                    </div>
                </div>
                <div class="limits-group">
                    <h3>Data & Export</h3>
                    <div class="limits-table">
                        <div class="limits-row"><span>CSV export</span><span>Included</span></div>
                        <div class="limits-row"><span>API access</span><span>{{ selectedEdition()?.id === 'enterprise' ? 'Included' : 'Limited' }}</span></div>
                    </div>
                </div>
                <div class="limits-group">
                    <h3>Support</h3>
                    <div class="limits-table">
                        <div class="limits-row"><span>SLA</span><span>{{ selectedEdition()?.id === 'enterprise' ? '99.9% uptime' : 'Standard' }}</span></div>
                        <div class="limits-row"><span>Onboarding</span><span>{{ selectedEdition()?.id === 'enterprise' ? 'Dedicated' : 'Self-serve' }}</span></div>
                        <div class="limits-row"><span>Support tier</span><span>{{ limitValue(selectedEdition()!, 'Support') }}</span></div>
                    </div>
                </div>
            </div>
            @if (compareMode() && compareDiffs().length) {
            <div class="limits-diff">
                <h3>Differences vs current</h3>
                <div class="limits-table">
                    @for (diff of compareDiffs(); track diff.label) {
                    <div class="limits-row">
                        <span>{{ diff.label }}</span>
                        <span>{{ diff.current }} → {{ diff.selected }}</span>
                    </div>
                    }
                </div>
            </div>
            }
            }
            }
        </div>
    </div>
    }
</div>

@if (drawerModuleKey() && selectedModule()) {
<div class="drawer-overlay" (click)="closeModuleDetail()">
    <div class="drawer" (click)="$event.stopPropagation()">
        <div class="drawer-header">
            <div>
                <h3>{{ selectedModule()?.name }}</h3>
                <p>{{ selectedModule()?.description }}</p>
            </div>
            <ui-button size="sm" variant="ghost" (click)="closeModuleDetail()">✕</ui-button>
        </div>
        <div class="drawer-body">
            <div class="drawer-section">
                <h4>Module summary</h4>
                <p class="drawer-muted">{{ selectedModule()?.description }}</p>
            </div>
            <div class="drawer-section">
                <h4>Included in</h4>
                <div class="drawer-tags">
                    @for (plan of includedPlans(selectedModule()?.key!); track plan) {
                    <span class="tag tag--included">{{ plan }}</span>
                    }
                </div>
            </div>
            <div class="drawer-section">
                <h4>What you get</h4>
                <ul>
                    @for (feature of selectedModule()?.features || []; track feature) {
                    <li>{{ feature }}</li>
                    }
                </ul>
            </div>
            <div class="drawer-section">
                <h4>Permissions</h4>
                <div class="drawer-tags">
                    @for (perm of selectedModule()?.permissions || []; track perm) {
                    <span class="tag tag--not_configured">{{ perm }}</span>
                    }
                </div>
            </div>
            <div class="drawer-note">
                <h4>Current tenant state</h4>
                <p>{{ currentTenantModuleState(selectedModule()?.key!).label }}</p>
                @if (currentTenantModuleState(selectedModule()?.key!).reason) {
                <p class="drawer-muted">{{ currentTenantModuleState(selectedModule()?.key!).reason }}</p>
                }
            </div>
            <div class="drawer-actions">
                <ui-button variant="primary" size="sm" [disabled]="primaryCtaLabel() === 'Current plan'">{{ primaryCtaLabel() }}</ui-button>
                <ui-button variant="ghost" size="sm" (click)="openRequestModal()">Request change</ui-button>
            </div>
        </div>
    </div>
</div>
}

@if (showRequestModal()) {
<div class="modal-overlay" (click)="closeRequestModal()">
    <div class="modal" (click)="$event.stopPropagation()">
        <div class="modal-header">
            <div>
                <h3>Request plan change</h3>
                <p>Send a request to change your plan. We'll follow up to confirm details.</p>
            </div>
            <ui-button size="sm" variant="ghost" (click)="closeRequestModal()">✕</ui-button>
        </div>
        <div class="modal-body">
            <label>
                Requested plan
                <ui-input [value]="selectedEdition()?.name || ''" [disabled]="true"></ui-input>
            </label>
            @if (isDowngrade() && downgradeImpacts().length > 0) {
            <div class="downgrade-warning">
                <p>This change reduces access for the tenant.</p>
                <ul>
                    @for (impact of downgradeImpacts(); track impact) {
                    <li>{{ impact }}</li>
                    }
                </ul>
                <label>
                    Type DOWNGRADE to confirm
                    <ui-input [(value)]="downgradeConfirmText"></ui-input>
                </label>
            </div>
            }
            <label>
                Reason
                <textarea rows="3" [(ngModel)]="bulkReason"></textarea>
            </label>
            <label>
                Preferred contact
                <ui-input type="email" [(value)]="bulkEmail"></ui-input>
            </label>
            <label>
                Urgency
                <select [(ngModel)]="bulkUrgency">
                    <option value="normal">Normal</option>
                    <option value="urgent">Urgent</option>
                </select>
            </label>
        </div>
        <div class="modal-footer">
            <ui-button variant="ghost" size="sm" (click)="closeRequestModal()">Cancel</ui-button>
            <ui-button
                variant="primary"
                size="sm"
                [disabled]="isDowngrade() && downgradeImpacts().length > 0 && downgradeConfirmText !== 'DOWNGRADE'"
                (click)="submitRequest()">
                Send request
            </ui-button>
        </div>
    </div>
</div>
}

@if (showOverridesDrawer()) {
<div class="drawer-overlay" (click)="closeOverridesDrawer()">
    <div class="drawer" (click)="$event.stopPropagation()">
        <div class="drawer-header">
            <div>
                <h3>Entitlement overrides</h3>
                <p>Edition overrides applied to this tenant.</p>
            </div>
            <ui-button size="sm" variant="ghost" (click)="closeOverridesDrawer()">✕</ui-button>
        </div>
        <div class="drawer-body">
            <div class="override-filters">
                <ui-button size="sm" variant="ghost" [class.is-active]="overrideFilter() === 'all'" (click)="setOverrideFilter('all')">All</ui-button>
                <ui-button size="sm" variant="ghost" [class.is-active]="overrideFilter() === 'enabled'" (click)="setOverrideFilter('enabled')">Enabled</ui-button>
                <ui-button size="sm" variant="ghost" [class.is-active]="overrideFilter() === 'disabled'" (click)="setOverrideFilter('disabled')">Disabled</ui-button>
                <ui-button size="sm" variant="ghost" [class.is-active]="overrideFilter() === 'limits'" (click)="setOverrideFilter('limits')">Limits</ui-button>
                <ui-button size="sm" variant="ghost" [class.is-active]="overrideFilter() === 'security'" (click)="setOverrideFilter('security')">Security</ui-button>
            </div>
            @if (filteredOverrides().length === 0) {
            <div class="override-empty">
                <p>No overrides applied.</p>
            </div>
            } @else {
            <div class="override-table">
                <div class="override-table__row header">
                    <span>Module/Feature</span>
                    <span>Change</span>
                    <span>Reason</span>
                    <span>Updated by</span>
                    <span>Date</span>
                </div>
                @for (override of filteredOverrides(); track override.module + override.updatedAt) {
                <div class="override-table__row">
                    <span>{{ override.module }}</span>
                    <span>{{ override.previous || 'Baseline' }} → {{ override.value }}</span>
                    <span>{{ override.reason }}</span>
                    <span>{{ override.updatedBy }}</span>
                    <span>{{ override.updatedAt }}</span>
                </div>
                }
            </div>
            }
        </div>
    </div>
</div>
}

@if (showCompareModal()) {
<div class="modal-overlay" (click)="closeCompareModal()">
    <div class="modal modal--wide" (click)="$event.stopPropagation()">
        <div class="modal-header">
            <div>
                <h3>Compare plans</h3>
                <p>Review module availability across editions.</p>
            </div>
            <ui-button size="sm" variant="ghost" (click)="closeCompareModal()">✕</ui-button>
        </div>
        <div class="modal-body">
            <div class="compare-table">
                <div class="compare-row compare-row--header">
                    <span>Module</span>
                    @for (edition of editions(); track edition.id) {
                    <span [class.is-current]="edition.id === currentPlanId()">{{ edition.name }}</span>
                    }
                </div>
                @for (row of comparePlanRows(); track row.key) {
                <div class="compare-row">
                    <span>{{ row.name }}</span>
                    @for (cell of row.cells; track cell.planId) {
                    <span class="compare-cell" [class.is-included]="cell.included" [class.is-current]="cell.planId === currentPlanId()">
                        {{ cell.label }}
                    </span>
                    }
                </div>
                }
            </div>
        </div>
        <div class="modal-footer">
            <ui-button variant="ghost" size="sm" (click)="closeCompareModal()">Close</ui-button>
        </div>
    </div>
</div>
}
