<div class="roles-page">
    <div class="roles-header">
        <div>
            <h1>Roles &amp; permissions</h1>
            <p>Manage roles, permissions, and access scope across your workspace.</p>
            <p class="roles-header__hint">Create roles to control access across the workspace.</p>
        </div>
        <div class="roles-header__actions">
            <mb-button variant="primary" (click)="openCreateRole()">Create custom role</mb-button>
        </div>
    </div>

    <mb-card class="roles-card">
        <div class="roles-loading" *ngIf="loading()">Loading roles…</div>
        <div class="roles-error" *ngIf="error()">{{ error() }}</div>

        <div class="roles-split">
            <div class="roles-split__table">
                <div class="roles-table">
                    <div class="roles-table__toolbar">
                        <div class="roles-table__toolbar-left">
                            <app-search-input class="roles-table__search" placeholder="Search roles…"
                                (search)="search.set($event)"></app-search-input>
                            <span class="roles-table__count">{{ filteredRoles().length }} roles</span>
                        </div>
                        <div class="roles-table__filters">
                            <button type="button" class="roles-chip" [class.is-active]="filters().has('all')"
                                (click)="setFilter('all')">
                                All
                            </button>
                            <button type="button" class="roles-chip" [class.is-active]="filters().has('system')"
                                (click)="setFilter('system')">
                                System
                            </button>
                            <button type="button" class="roles-chip" [class.is-active]="filters().has('custom')"
                                (click)="setFilter('custom')">
                                Custom
                            </button>
                            <button type="button" class="roles-chip" [class.is-active]="filters().has('active')"
                                (click)="setFilter('active')">
                                Active
                            </button>
                            <span class="roles-filters__count" *ngIf="activeFilterCount()">
                                {{ activeFilterCount() }} filters applied
                            </span>
                            <button type="button" class="roles-link roles-filters__clear" *ngIf="activeFilterCount()"
                                (click)="clearFilters()">
                                Clear filters
                            </button>
                        </div>
                    </div>

                    <ng-container *ngIf="filteredRoles().length; else rolesEmpty">
                        <mb-table class="roles-table__list" [columns]="roleTableColumns" [rows]="filteredRoles()"
                            [rowKey]="roleRowKey" [rowClass]="roleRowClass"
                            (rowClick)="openRoleDetails($event.id, 'permissions')">
                            <ng-template mbTableActions let-row>
                                <div class="roles-table__actions">
                                    <button type="button" class="roles-menu__trigger" #roleMenuOrigin
                                        aria-label="Role actions" (click)="toggleRoleMenu(row.id, $event)">
                                        ⋯
                                    </button>
                                    <mb-popover [open]="roleMenuOpenId() === row.id" [origin]="roleMenuOrigin"
                                        [hasBackdrop]="true"
                                        [panelClass]="['mb-popover-panel', 'mb-popover-panel--above-modal', 'roles-menu__panel']"
                                        (closed)="closeRoleMenu()">
                                        <div class="roles-menu__panel-content" role="menu">
                                            <button type="button" class="roles-menu__item"
                                                (click)="openRoleDetails(row.id, 'permissions'); closeRoleMenu()">
                                                View permissions
                                            </button>
                                            <button type="button" class="roles-menu__item"
                                                (click)="openRoleDetails(row.id, 'assignments'); closeRoleMenu()">
                                                View assigned users
                                            </button>
                                            <button type="button" class="roles-menu__item" *ngIf="!row.isSystemRole"
                                                (click)="openEditRole(row); closeRoleMenu()">
                                                Edit role
                                            </button>
                                            <button type="button" class="roles-menu__item"
                                                (click)="openDuplicateRole(row); closeRoleMenu()">
                                                Duplicate role
                                            </button>
                                            <button type="button" class="roles-menu__item" *ngIf="!row.isSystemRole"
                                                (click)="toggleRoleStatus(row); closeRoleMenu()">
                                                {{ (row.status || 'active') === 'active' ? 'Deactivate role' : 'Activate
                                                role' }}
                                            </button>
                                            <div class="roles-menu__divider" *ngIf="!row.isSystemRole"></div>
                                            <button type="button" class="roles-menu__item roles-menu__item--danger"
                                                *ngIf="!row.isSystemRole"
                                                (click)="requestDeleteRole(row); closeRoleMenu()">
                                                Delete role
                                            </button>
                                        </div>
                                    </mb-popover>
                                </div>
                            </ng-template>
                        </mb-table>
                    </ng-container>
                </div>
            </div>

            <div class="roles-split__detail">
                <div class="roles-detail roles-detail--sticky">
                    <ng-container *ngIf="detailRole() as detailRole; else roleDetailEmpty">
                        <div class="roles-detail__header">
                            <div class="roles-detail__header-main">
                                <div class="roles-detail__title">{{ detailRole.name }}</div>
                                <div class="roles-detail__meta">
                                    <span class="roles-pill" [class.roles-pill--system]="detailRole.isSystemRole">
                                        {{ detailRole.isSystemRole ? 'System' : 'Custom' }}
                                    </span>
                                    <span class="roles-pill roles-pill--muted">{{ roleScopeLabel(detailRole) }}</span>
                                    <span class="roles-pill"
                                        [class.roles-pill--muted]="(detailRole.status || 'active') !== 'active'">
                                        {{ roleStatusLabel(detailRole) }}
                                    </span>
                                </div>
                            </div>
                            <div class="roles-detail__header-actions">
                                <mb-button variant="primary" *ngIf="!detailRole.isSystemRole"
                                    (click)="openEditRole(detailRole)">
                                    Edit role
                                </mb-button>
                                <mb-button variant="primary" *ngIf="detailRole.isSystemRole"
                                    (click)="openDuplicateRole(detailRole)">
                                    Duplicate role
                                </mb-button>
                                <button type="button" class="roles-menu__trigger" #detailMenuOrigin
                                    aria-label="More actions" (click)="toggleDetailMenu()">
                                    ⋯
                                </button>
                                <mb-popover [open]="detailMenuOpen()" [origin]="detailMenuOrigin" [hasBackdrop]="true"
                                    [panelClass]="['mb-popover-panel', 'mb-popover-panel--above-modal', 'roles-menu__panel']"
                                    (closed)="closeDetailMenu()">
                                    <div class="roles-menu__panel-content" role="menu">
                                        <button type="button" class="roles-menu__item"
                                            [disabled]="detailRole.isSystemRole"
                                            (click)="toggleRoleStatus(detailRole); closeDetailMenu()">
                                            {{ (detailRole.status || 'active') === 'active' ? 'Deactivate role' :
                                            'Activate role' }}
                                        </button>
                                        <button type="button" class="roles-menu__item"
                                            (click)="exportRole(detailRole); closeDetailMenu()">
                                            Export role
                                        </button>
                                        <button type="button" class="roles-menu__item" disabled title="Coming soon">
                                            View audit
                                        </button>
                                        <div class="roles-menu__divider" *ngIf="!detailRole.isSystemRole"></div>
                                        <button type="button" class="roles-menu__item roles-menu__item--danger"
                                            *ngIf="!detailRole.isSystemRole"
                                            (click)="requestDeleteRole(detailRole); closeDetailMenu()">
                                            Delete role
                                        </button>
                                    </div>
                                </mb-popover>
                                <button type="button" class="roles-detail__close" aria-label="Close role details"
                                    (click)="closeRoleDetails()">
                                    ✕
                                </button>
                            </div>
                        </div>

                        <div class="roles-detail__tabs">
                            <button type="button" class="roles-tab" [class.is-active]="detailTab() === 'permissions'"
                                (click)="setDetailTab('permissions')">
                                Permissions
                            </button>
                            <button type="button" class="roles-tab" [class.is-active]="detailTab() === 'assignments'"
                                (click)="setDetailTab('assignments')">
                                Assigned users ({{ roleUsers(detailRole).length }})
                            </button>
                        </div>

                        <div class="roles-detail__body" *ngIf="detailTab() === 'permissions'">
                            <div class="roles-expand__warning" *ngIf="roleHasAdminPerms(detailRole)">
                                System roles cannot be edited. Duplicate this role to create a custom version.
                            </div>
                            <app-permission-tree [permissionTree]="permissionTree()"
                                [selectedPermissions]="rolePermissionIds(detailRole)"
                                [readOnly]="true"></app-permission-tree>
                        </div>

                        <div class="roles-detail__body" *ngIf="detailTab() === 'assignments'">
                            <div class="roles-assignments__header" *ngIf="roleUsers(detailRole).length">
                                <div>
                                    <div class="roles-assignments__title">Users with this role</div>
                                    <div class="roles-assignments__subtitle">
                                        Assign users to control access across your workspace.
                                    </div>
                                </div>
                                <mb-button variant="secondary" (click)="openAssignmentsModal(detailRole)">
                                    Assign users
                                </mb-button>
                            </div>
                            <mb-table *ngIf="roleUsers(detailRole).length; else assignmentsEmpty" [columns]="[
                                  { key: 'name', label: 'User' },
                                  { key: 'email', label: 'Email' },
                                  { key: 'scope', label: 'Scope' },
                                  { key: 'status', label: 'Status' }
                                ]" [rows]="assignmentRowsForRole(detailRole)">
                                <ng-template mbTableActions let-row>
                                    <button type="button" class="roles-link" (click)="removeAssignment(row.id)">
                                        Remove role
                                    </button>
                                </ng-template>
                            </mb-table>
                            <ng-template #assignmentsEmpty>
                                <div class="roles-empty-card">
                                    <div class="roles-empty-card__icon" aria-hidden="true">
                                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                                            <circle cx="9" cy="8" r="3.5"></circle>
                                            <path d="M3.5 19.5c0-3 2.5-5.5 5.5-5.5s5.5 2.5 5.5 5.5"></path>
                                            <circle cx="17.5" cy="8.5" r="2.5"></circle>
                                            <path d="M15 19.5c.2-2.4 2.2-4.3 4.6-4.3"></path>
                                        </svg>
                                    </div>
                                    <div class="roles-empty-card__title">No users assigned</div>
                                    <div class="roles-empty-card__text">
                                        Assign users to this role to apply its permissions across the workspace.
                                    </div>
                                    <mb-button variant="primary" (click)="openAssignmentsModal(detailRole)">
                                        Assign users
                                    </mb-button>
                                </div>
                            </ng-template>
                        </div>
                    </ng-container>
                    <ng-template #roleDetailEmpty>
                        <div class="roles-empty roles-empty--detail">
                            <div class="roles-empty__title">Select a role</div>
                            <div class="roles-empty__text">
                                Select a role to view permissions and assignments.
                            </div>
                        </div>
                    </ng-template>
                </div>
            </div>
        </div>
    </mb-card>

    <ng-template #rolesEmpty>
        <div class="roles-empty" *ngIf="roles().length; else noRoles">
            <div class="roles-empty__title">No roles match the selected filters</div>
            <div class="roles-empty__text">Try removing some filters to see more roles.</div>
            <mb-button variant="secondary" (click)="clearFilters()">Clear filters</mb-button>
        </div>
        <ng-template #noRoles>
            <div class="roles-empty">
                <div class="roles-empty__title">No roles yet</div>
                <div class="roles-empty__text">Create a custom role to start managing access.</div>
                <mb-button variant="primary" (click)="openCreateRole()">Create custom role</mb-button>
            </div>
        </ng-template>
    </ng-template>

    <mb-modal class="role-form-modal" [open]="roleFormOpen()"
        title="{{ roleFormMode() === 'edit' ? 'Edit role' : (roleFormMode() === 'duplicate' ? 'Duplicate role' : 'Create role') }}"
        [closeable]="!roleFormSaving()" [closeOnBackdrop]="!roleFormSaving()" (closed)="requestCloseRoleForm()">
        <div class="role-form">
            <div class="role-form__layout">
                <aside class="role-form__sidebar">
                    <div class="role-form__section">
                        <div class="role-form__title">Identity</div>
                        <mb-form-field label="Role name" [controlId]="'role-name'">
                            <mb-input id="role-name" [value]="roleFormName()"
                                (valueChange)="roleFormName.set($event); markRoleFormDirty()"></mb-input>
                        </mb-form-field>
                        <mb-form-field label="Description" [controlId]="'role-description'">
                            <mb-textarea id="role-description" [value]="roleFormDescription()"
                                (valueChange)="roleFormDescription.set($event); markRoleFormDirty()"></mb-textarea>
                        </mb-form-field>
                    </div>

                    <div class="role-form__section">
                        <div class="role-form__title">Scope</div>
                        <mb-select [value]="roleFormScopeType()" [options]="[
                              { label: 'Workspace-wide', value: 'workspace' },
                              { label: 'Selected schools', value: 'school' },
                              { label: 'Selected organizational units', value: 'org' }
                            ]" (valueChange)="handleScopeTypeChange($event)"></mb-select>
                        <div class="role-form__multiselect" *ngIf="roleFormScopeType() !== 'workspace'">
                            <div class="role-form__multiselect-title">
                                {{ roleFormScopeType() === 'school' ? 'Select schools' : 'Select organizational units' }}
                            </div>
                            <div class="role-form__multiselect-list" *ngIf="roleFormScopeType() === 'school'">
                                <div class="role-form__multiselect-empty" *ngIf="!schools().length">
                                    No schools available.
                                </div>
                                <div class="role-form__multiselect-item" *ngFor="let school of schools(); track school.id">
                                    <mb-checkbox
                                        [checked]="roleFormSchoolIds().has(school.id)"
                                        (checkedChange)="toggleRoleFormSchool(school.id)"
                                    >
                                        {{ school.name }}
                                    </mb-checkbox>
                                </div>
                            </div>
                            <div class="role-form__multiselect-list" *ngIf="roleFormScopeType() === 'org'">
                                <div class="role-form__multiselect-empty" *ngIf="!orgUnits().length">
                                    No organizational units available.
                                </div>
                                <div class="role-form__multiselect-item" *ngFor="let unit of orgUnits(); track unit.id">
                                    <mb-checkbox
                                        [checked]="roleFormOrgUnitIds().has(unit.id)"
                                        (checkedChange)="toggleRoleFormOrgUnit(unit.id)"
                                    >
                                        {{ unit.name }}
                                    </mb-checkbox>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="role-form__section">
                        <div class="role-form__title">Template</div>
                        <mb-select [value]="roleFormTemplate()" [options]="[
                              { label: 'None', value: 'custom' },
                              { label: 'Teacher', value: 'teacher' },
                              { label: 'Accountant', value: 'finance' },
                              { label: 'Principal', value: 'principal' },
                              { label: 'Tenant Admin', value: 'admin' }
                            ]" (valueChange)="applyPermissionTemplate($event)"></mb-select>
                        <div class="role-form__helper" *ngIf="roleFormTemplate() !== 'custom'">
                            Permissions will be prefilled based on the selected template.
                        </div>
                    </div>
                </aside>

                <section class="role-form__main">
                    <div class="role-form__section">
                        <div class="role-form__title">Permissions</div>
                        <div class="role-form__row">
                            <mb-select [value]="roleFormStatus()" [options]="[
                                  { label: 'Active', value: 'active' },
                                  { label: 'Inactive', value: 'inactive' }
                                ]" (valueChange)="handleStatusChange($event)"></mb-select>
                        </div>
                        <app-permission-tree
                            [permissionTree]="permissionTree()"
                            [selectedPermissions]="roleFormPermissions()"
                            (permissionsChange)="updateRolePermissions($event)"
                        ></app-permission-tree>
                    </div>
                </section>
            </div>

            <div class="role-form__error" *ngIf="roleFormError()">{{ roleFormError() }}</div>
        </div>

        <div mbModalFooter class="role-form__footer">
            <div class="role-form__status">
                <span class="role-form__dirty" *ngIf="roleFormDirty()">Unsaved changes</span>
                <span class="role-form__hint">Changes are saved when you click save.</span>
            </div>
            <div class="role-form__actions">
                <mb-button variant="secondary" (click)="requestCloseRoleForm()">Cancel</mb-button>
                <mb-button variant="primary" [loading]="roleFormSaving()"
                    [disabled]="roleFormSaving() || roleFormInvalid()" (click)="saveRole()">
                    Save role
                </mb-button>
            </div>
        </div>
    </mb-modal>

    <mb-modal [open]="roleFormDiscardOpen()" title="Discard unsaved changes?"
        [closeable]="!roleFormSaving()" [closeOnBackdrop]="!roleFormSaving()" (closed)="keepEditingRoleForm()">
        <div class="role-form__confirm">
            You have unsaved changes. Are you sure you want to discard them?
        </div>
        <div mbModalFooter class="role-form__footer">
            <div class="role-form__actions">
                <mb-button variant="secondary" (click)="keepEditingRoleForm()">Continue editing</mb-button>
                <mb-button variant="primary" (click)="discardRoleFormChanges()">Discard</mb-button>
            </div>
        </div>
    </mb-modal>

    <mb-modal [open]="deleteModalOpen()" title="Delete role?" [closeable]="!deleteSubmitting()"
        [closeOnBackdrop]="!deleteSubmitting()" (closed)="closeDeleteModal()">
        <div class="roles-delete">
            <p>This removes the role permanently. Users will lose access tied to this role.</p>
            <mb-form-field label="Type the role name to confirm" [controlId]="'delete-role-confirm'">
                <mb-input id="delete-role-confirm" [value]="deleteConfirmText()"
                    (valueChange)="deleteConfirmText.set($event)"></mb-input>
            </mb-form-field>
            <div class="role-form__error" *ngIf="deleteError()">{{ deleteError() }}</div>
        </div>
        <div mbModalFooter class="role-form__footer">
            <mb-button variant="secondary" [disabled]="deleteSubmitting()"
                (click)="closeDeleteModal()">Cancel</mb-button>
            <mb-button variant="primary" [loading]="deleteSubmitting()" (click)="deleteRole()">Delete role</mb-button>
        </div>
    </mb-modal>

    <mb-modal [open]="assignmentsModalOpen()" title="Assign users" [closeable]="!assignSubmitting()"
        [closeOnBackdrop]="!assignSubmitting()" (closed)="closeAssignmentsModal()">
        <div class="roles-assign">
            <mb-input placeholder="Search users…" [value]="assignSearch()"
                (valueChange)="assignSearch.set($event)"></mb-input>
            <div class="roles-assign__list" *ngIf="assignableUsers().length; else assignEmpty">
                <label class="roles-assign__row" *ngFor="let user of assignableUsers(); trackBy: trackByUser">
                    <mb-checkbox [checked]="assignSelections().has(user.id)"
                        (checkedChange)="toggleAssignSelection(user.id)"></mb-checkbox>
                    <div>
                        <div class="roles-assign__name">{{ user.name }}</div>
                        <div class="roles-assign__email">{{ user.email }}</div>
                    </div>
                </label>
            </div>
            <ng-template #assignEmpty>
                <div class="roles-empty roles-empty--inline">
                    <div class="roles-empty__title">No users available</div>
                    <div class="roles-empty__text">Everyone already has this role.</div>
                </div>
            </ng-template>

            <div class="roles-assign__scope" *ngIf="selectedRole()?.scopeType === 'school'">
                <div class="roles-assign__title">Access scope</div>
                <app-access-scope-picker [scope]="assignScopeType()" [schools]="schools()"
                    [selectedSchoolIds]="assignSchoolIds()" (scopeChange)="assignScopeType.set($event)"
                    (selectedSchoolIdsChange)="assignSchoolIds.set($event)"></app-access-scope-picker>
            </div>

            <div class="role-form__error" *ngIf="assignError()">{{ assignError() }}</div>
        </div>
        <div mbModalFooter class="role-form__footer">
            <mb-button variant="secondary" [disabled]="assignSubmitting()"
                (click)="closeAssignmentsModal()">Cancel</mb-button>
            <mb-button variant="primary" [loading]="assignSubmitting()" (click)="saveAssignments()">Assign
                users</mb-button>
        </div>
    </mb-modal>
</div>
