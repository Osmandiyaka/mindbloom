<div class="roles-page">
    <div class="roles-header">
        <div>
            <h1>Roles &amp; permissions</h1>
            <p>Manage roles, permissions, and access scope across your workspace.</p>
        </div>
        <div class="roles-header__actions">
            <mb-button variant="primary" (click)="openCreateRole()">Create role</mb-button>
        </div>
    </div>

    <mb-card class="roles-card">
        <div class="roles-loading" *ngIf="loading()">Loading roles…</div>
        <div class="roles-error" *ngIf="error()">{{ error() }}</div>
        <div class="roles-layout">
            <div class="roles-list">
                <div class="roles-list__header">
                    <div class="roles-list__title">Roles</div>
                    <mb-input
                        class="roles-list__search"
                        placeholder="Search roles…"
                        [value]="search()"
                        (valueChange)="search.set($event)"
                    ></mb-input>
                    <div class="roles-list__filters">
                        <button
                            type="button"
                            class="roles-chip"
                            [class.is-active]="filter() === 'all'"
                            (click)="setFilter('all')"
                        >
                            All
                        </button>
                        <button
                            type="button"
                            class="roles-chip"
                            [class.is-active]="filter() === 'system'"
                            (click)="setFilter('system')"
                        >
                            System
                        </button>
                        <button
                            type="button"
                            class="roles-chip"
                            [class.is-active]="filter() === 'custom'"
                            (click)="setFilter('custom')"
                        >
                            Custom
                        </button>
                        <button
                            type="button"
                            class="roles-chip"
                            [class.is-active]="filter() === 'active'"
                            (click)="setFilter('active')"
                        >
                            Active
                        </button>
                    </div>
                </div>

                <div class="roles-list__body" *ngIf="filteredRoles().length; else rolesEmpty">
                    <div
                        class="roles-row"
                        role="button"
                        tabindex="0"
                        *ngFor="let role of filteredRoles(); track role.id"
                        [class.is-selected]="selectedRole()?.id === role.id"
                        [attr.aria-pressed]="selectedRole()?.id === role.id"
                        (click)="selectRole(role.id)"
                        (keydown.enter)="selectRole(role.id)"
                        (keydown.space)="selectRole(role.id)"
                    >
                        <div class="roles-row__info">
                            <div class="roles-row__name">{{ role.name }}</div>
                            <div class="roles-row__desc">{{ role.description }}</div>
                            <div class="roles-row__meta">
                                <span class="roles-badge">{{ roleScopeLabel(role) }}</span>
                                <span class="roles-badge roles-badge--muted">{{ roleStatusLabel(role) }}</span>
                                <span class="roles-badge" *ngIf="role.isSystemRole">System</span>
                            </div>
                        </div>
                        <div class="roles-row__count">{{ roleUserCount(role.id) }} users</div>
                        <div class="roles-row__actions">
                            <button
                                type="button"
                                class="roles-menu__trigger"
                                #roleMenuOrigin
                                aria-label="Role actions"
                                (click)="toggleRoleMenu(role.id, $event)"
                            >
                                ⋯
                            </button>
                            <mb-popover
                                [open]="roleMenuOpenId() === role.id"
                                [origin]="roleMenuOrigin"
                                [hasBackdrop]="true"
                                [panelClass]="['mb-popover-panel', 'mb-popover-panel--above-modal', 'roles-menu__panel']"
                                (closed)="closeRoleMenu()"
                            >
                                <div class="roles-menu__panel-content" role="menu">
                                    <button type="button" class="roles-menu__item" [disabled]="role.isSystemRole" (click)="openEditRole(role)">
                                        Edit role
                                    </button>
                                    <button type="button" class="roles-menu__item" (click)="openDuplicateRole(role)">
                                        Duplicate role
                                    </button>
                                    <button
                                        type="button"
                                        class="roles-menu__item"
                                        [disabled]="role.isSystemRole"
                                        (click)="toggleRoleStatus(role)"
                                    >
                                        {{ (role.status || 'active') === 'active' ? 'Deactivate role' : 'Activate role' }}
                                    </button>
                                    <div class="roles-menu__divider"></div>
                                    <button
                                        type="button"
                                        class="roles-menu__item roles-menu__item--danger"
                                        [disabled]="role.isSystemRole"
                                        (click)="requestDeleteRole(role)"
                                    >
                                        Delete role
                                    </button>
                                </div>
                            </mb-popover>
                        </div>
                    </div>
                </div>
            </div>

            <div class="roles-detail" *ngIf="selectedRole(); else roleEmpty">
                <div class="roles-detail__header">
                    <div>
                        <div class="roles-detail__title">{{ selectedRole()?.name }}</div>
                        <div class="roles-detail__meta">
                            <span class="roles-badge">{{ roleScopeLabel(selectedRole()!) }}</span>
                            <span class="roles-badge roles-badge--muted">{{ roleStatusLabel(selectedRole()!) }}</span>
                            <span class="roles-badge" *ngIf="selectedRole()?.isSystemRole">System</span>
                        </div>
                    </div>
                    <div class="roles-detail__actions">
                        <mb-button
                            variant="secondary"
                            [disabled]="!!selectedRole()?.isSystemRole"
                            (click)="openEditRole(selectedRole()!)"
                        >
                            Edit role
                        </mb-button>
                        <button
                            type="button"
                            class="roles-menu__trigger"
                            #roleActionMenuOrigin
                            aria-label="Role actions"
                            [attr.aria-expanded]="roleActionMenuOpen()"
                            (click)="toggleRoleActionMenu()"
                        >
                            ⋯
                        </button>
                        <mb-popover
                            [open]="roleActionMenuOpen()"
                            [origin]="roleActionMenuOrigin"
                            [hasBackdrop]="true"
                            [panelClass]="['mb-popover-panel', 'mb-popover-panel--above-modal', 'roles-menu__panel']"
                            (closed)="closeRoleActionMenu()"
                        >
                            <div class="roles-menu__panel-content" role="menu">
                                <button type="button" class="roles-menu__item" (click)="openDuplicateRole(selectedRole()!)">
                                    Duplicate role
                                </button>
                                <button
                                    type="button"
                                    class="roles-menu__item"
                                    [disabled]="selectedRole()?.isSystemRole"
                                    (click)="toggleRoleStatus(selectedRole()!)"
                                >
                                    {{ (selectedRole()?.status || 'active') === 'active' ? 'Deactivate role' : 'Activate role' }}
                                </button>
                                <div class="roles-menu__divider"></div>
                                <button
                                    type="button"
                                    class="roles-menu__item roles-menu__item--danger"
                                    [disabled]="selectedRole()?.isSystemRole"
                                    (click)="requestDeleteRole(selectedRole()!)"
                                >
                                    Delete role
                                </button>
                            </div>
                        </mb-popover>
                    </div>
                </div>
                <div class="roles-detail__description">{{ selectedRole()?.description }}</div>

                <div class="roles-detail__tabs">
                    <button
                        type="button"
                        class="roles-tab"
                        [class.is-active]="activeTab() === 'permissions'"
                        (click)="activeTab.set('permissions')"
                    >
                        Permissions
                    </button>
                    <button
                        type="button"
                        class="roles-tab"
                        [class.is-active]="activeTab() === 'assignments'"
                        (click)="activeTab.set('assignments')"
                    >
                        Assignments ({{ selectedRoleUsers().length }})
                    </button>
                </div>

                <div class="roles-detail__body" *ngIf="activeTab() === 'permissions'">
                    <div class="roles-detail__callout" *ngIf="selectedRoleHasAdminPerms()">
                        High privilege: this role grants administrative access.
                    </div>
                    <app-permission-matrix
                        [permissions]="permissionTree()"
                        [selectedPermissions]="rolePermissionIds(selectedRole())"
                        [readOnly]="true"
                    ></app-permission-matrix>
                    <div class="roles-detail__lock" *ngIf="selectedRole()?.isSystemRole">
                        System roles can’t be edited. Duplicate this role to create a custom version.
                    </div>
                </div>

                <div class="roles-detail__body" *ngIf="activeTab() === 'assignments'">
                    <div class="roles-assignments__header">
                        <div>
                            <div class="roles-assignments__title">Users with this role</div>
                            <div class="roles-assignments__subtitle">
                                Assign users to control access across your workspace.
                            </div>
                        </div>
                        <mb-button variant="secondary" (click)="openAssignmentsModal()">Assign users</mb-button>
                    </div>
                    <mb-table
                        *ngIf="selectedRoleUsers().length; else assignmentsEmpty"
                        [columns]="[
                          { key: 'name', label: 'User' },
                          { key: 'email', label: 'Email' },
                          { key: 'scope', label: 'Scope' },
                          { key: 'status', label: 'Status' }
                        ]"
                        [rows]="assignmentRows()"
                    >
                        <ng-template mbTableActions let-row>
                            <button type="button" class="roles-link" (click)="removeAssignment(row.id)">
                                Remove role
                            </button>
                        </ng-template>
                    </mb-table>
                </div>
            </div>
        </div>
    </mb-card>

    <ng-template #rolesEmpty>
        <div class="roles-empty">
            <div class="roles-empty__title">No roles yet</div>
            <div class="roles-empty__text">Create a custom role to start managing access.</div>
            <mb-button variant="primary" (click)="openCreateRole()">Create role</mb-button>
        </div>
    </ng-template>

    <ng-template #roleEmpty>
        <div class="roles-detail roles-detail--empty">
            <div class="roles-empty">
                <div class="roles-empty__title">Select a role</div>
                <div class="roles-empty__text">Choose a role to view permissions and assignments.</div>
            </div>
        </div>
    </ng-template>

    <ng-template #assignmentsEmpty>
        <div class="roles-empty roles-empty--inline">
            <div class="roles-empty__title">No users have this role yet</div>
            <div class="roles-empty__text">Assign users to apply these permissions.</div>
            <mb-button variant="secondary" (click)="openAssignmentsModal()">Assign users</mb-button>
        </div>
    </ng-template>

    <mb-modal
        [open]="roleFormOpen()"
        title="{{ roleFormMode() === 'edit' ? 'Edit role' : (roleFormMode() === 'duplicate' ? 'Duplicate role' : 'Create role') }}"
        [closeable]="!roleFormSaving()"
        [closeOnBackdrop]="!roleFormSaving()"
        (closed)="closeRoleForm()"
    >
        <div class="role-form">
            <div class="role-form__section">
                <div class="role-form__title">Identity</div>
                <mb-form-field label="Role name" [controlId]="'role-name'">
                    <mb-input
                        id="role-name"
                        [value]="roleFormName()"
                        (valueChange)="roleFormName.set($event); markRoleFormDirty()"
                    ></mb-input>
                </mb-form-field>
                <mb-form-field label="Description" [controlId]="'role-description'">
                    <mb-textarea
                        id="role-description"
                        [value]="roleFormDescription()"
                        (valueChange)="roleFormDescription.set($event); markRoleFormDirty()"
                    ></mb-textarea>
                </mb-form-field>
            </div>

            <div class="role-form__section">
                <div class="role-form__title">Scope</div>
                <mb-select
                    [value]="roleFormScopeType()"
                    [options]="[
                      { label: 'Workspace-wide', value: 'workspace' },
                      { label: 'School-scoped', value: 'school' }
                    ]"
                    (valueChange)="handleScopeTypeChange($event)"
                ></mb-select>
            </div>

            <div class="role-form__section">
                <div class="role-form__title">Permissions</div>
                <div class="role-form__row">
                    <mb-select
                        [value]="roleFormTemplate()"
                        [options]="[
                          { label: 'Start from template', value: 'custom' },
                          { label: 'Teacher', value: 'teacher' },
                          { label: 'Finance officer', value: 'finance' },
                          { label: 'Registrar', value: 'registrar' },
                          { label: 'Principal', value: 'principal' }
                        ]"
                        (valueChange)="applyPermissionTemplate($event)"
                    ></mb-select>
                    <mb-select
                        [value]="roleFormStatus()"
                    [options]="[
                          { label: 'Active', value: 'active' },
                          { label: 'Inactive', value: 'inactive' }
                        ]"
                        (valueChange)="handleStatusChange($event)"
                    ></mb-select>
                </div>
                <app-permission-matrix
                    [permissions]="permissionTree()"
                    [selectedPermissions]="roleFormPermissions()"
                    (selectedPermissionsChange)="updateRolePermissions($event)"
                ></app-permission-matrix>
            </div>

            <div class="role-form__error" *ngIf="roleFormError()">{{ roleFormError() }}</div>
        </div>

        <div mbModalFooter class="role-form__footer">
            <span class="role-form__hint">Changes are saved when you click save.</span>
            <div class="role-form__actions">
                <mb-button variant="secondary" (click)="closeRoleForm()">Cancel</mb-button>
                <mb-button variant="primary" [loading]="roleFormSaving()" (click)="saveRole()">
                    Save role
                </mb-button>
            </div>
        </div>
    </mb-modal>

    <mb-modal
        [open]="deleteModalOpen()"
        title="Delete role?"
        [closeable]="!deleteSubmitting()"
        [closeOnBackdrop]="!deleteSubmitting()"
        (closed)="closeDeleteModal()"
    >
        <div class="roles-delete">
            <p>This removes the role permanently. Users will lose access tied to this role.</p>
            <mb-form-field label="Type the role name to confirm" [controlId]="'delete-role-confirm'">
                <mb-input
                    id="delete-role-confirm"
                    [value]="deleteConfirmText()"
                    (valueChange)="deleteConfirmText.set($event)"
                ></mb-input>
            </mb-form-field>
            <div class="role-form__error" *ngIf="deleteError()">{{ deleteError() }}</div>
        </div>
        <div mbModalFooter class="role-form__footer">
            <mb-button variant="secondary" [disabled]="deleteSubmitting()" (click)="closeDeleteModal()">Cancel</mb-button>
            <mb-button variant="primary" [loading]="deleteSubmitting()" (click)="deleteRole()">Delete role</mb-button>
        </div>
    </mb-modal>

    <mb-modal
        [open]="assignmentsModalOpen()"
        title="Assign users"
        [closeable]="!assignSubmitting()"
        [closeOnBackdrop]="!assignSubmitting()"
        (closed)="closeAssignmentsModal()"
    >
        <div class="roles-assign">
            <mb-input
                placeholder="Search users…"
                [value]="assignSearch()"
                (valueChange)="assignSearch.set($event)"
            ></mb-input>
            <div class="roles-assign__list" *ngIf="assignableUsers().length; else assignEmpty">
                <label class="roles-assign__row" *ngFor="let user of assignableUsers(); track user.id">
                    <mb-checkbox
                        [checked]="assignSelections().has(user.id)"
                        (checkedChange)="toggleAssignSelection(user.id)"
                    ></mb-checkbox>
                    <div>
                        <div class="roles-assign__name">{{ user.name }}</div>
                        <div class="roles-assign__email">{{ user.email }}</div>
                    </div>
                </label>
            </div>
            <ng-template #assignEmpty>
                <div class="roles-empty roles-empty--inline">
                    <div class="roles-empty__title">No users available</div>
                    <div class="roles-empty__text">Everyone already has this role.</div>
                </div>
            </ng-template>

            <div class="roles-assign__scope" *ngIf="selectedRole()?.scopeType === 'school'">
                <div class="roles-assign__title">Access scope</div>
                <app-access-scope-picker
                    [scope]="assignScopeType()"
                    [schools]="schools()"
                    [selectedSchoolIds]="assignSchoolIds()"
                    (scopeChange)="assignScopeType.set($event)"
                    (selectedSchoolIdsChange)="assignSchoolIds.set($event)"
                ></app-access-scope-picker>
            </div>

            <div class="role-form__error" *ngIf="assignError()">{{ assignError() }}</div>
        </div>
        <div mbModalFooter class="role-form__footer">
            <mb-button variant="secondary" [disabled]="assignSubmitting()" (click)="closeAssignmentsModal()">Cancel</mb-button>
            <mb-button variant="primary" [loading]="assignSubmitting()" (click)="saveAssignments()">Assign users</mb-button>
        </div>
    </mb-modal>
</div>
