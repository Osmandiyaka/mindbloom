<div class="permission-matrix" [style.--action-count]="actionColumns().length">
    <div class="permission-matrix__controls" *ngIf="showControls">
        <div class="permission-matrix__title">
            <span>Permissions</span>
            <span class="permission-matrix__selected">{{ selectedIds().size }} selected</span>
        </div>
        <div class="permission-matrix__tools">
            <input
                class="permission-matrix__search"
                type="search"
                placeholder="Search permissions…"
                [ngModel]="search()"
                (ngModelChange)="search.set($event)"
            />
            <button type="button" class="permission-matrix__btn" (click)="expandAll()">Expand all</button>
            <button type="button" class="permission-matrix__btn" (click)="collapseAll()">Collapse all</button>
        </div>
    </div>

    <div class="permission-matrix__table">
        <div class="permission-matrix__head">
            <div class="permission-matrix__cell permission-matrix__cell--label">Permission</div>
            <div class="permission-matrix__cell" *ngFor="let action of actionColumns()">
                {{ action.label }}
            </div>
        </div>

        <div class="permission-group" *ngFor="let group of filteredGroups(); trackBy: trackByGroup">
            <div class="permission-group__header">
                <button type="button" class="permission-group__toggle" (click)="toggleGroupExpanded(group.id)">
                    <span class="permission-group__caret" [class.is-open]="isGroupExpanded(group.id)">▾</span>
                    <span class="permission-group__title">{{ group.displayName || group.resource }}</span>
                    <span class="permission-group__count">{{ groupSelectionCount(group) }}/{{ groupTotalCount(group) }}</span>
                </button>
            </div>

            <div class="permission-group__body" *ngIf="isGroupExpanded(group.id)">
                <ng-container *ngFor="let item of group.children || []; trackBy: trackByPermission">
                    <div class="permission-row">
                        <div class="permission-row__name">
                            <mb-checkbox
                                *ngIf="!readOnly"
                                [checked]="isSelected(item.id)"
                                [indeterminate]="isPartiallySelected(item)"
                                [ariaLabel]="item.displayName || item.resource"
                                (checkedChange)="togglePermission(item)"
                            ></mb-checkbox>
                            <span class="permission-row__check" *ngIf="readOnly && isSelected(item.id)">✓</span>
                            <div class="permission-row__info">
                                <div class="permission-row__title">{{ item.displayName || item.resource }}</div>
                                <div class="permission-row__desc">{{ item.description }}</div>
                            </div>
                        </div>
                        <div class="permission-row__action" *ngFor="let action of actionColumns()">
                            <span class="permission-action" [class.is-on]="hasAction(item, action.key)">
                                {{ hasAction(item, action.key) ? '✓' : '—' }}
                            </span>
                        </div>
                    </div>

                    <div class="permission-row permission-row--child" *ngFor="let child of item.children || []; trackBy: trackByPermission">
                        <div class="permission-row__name">
                            <mb-checkbox
                                *ngIf="!readOnly"
                                [checked]="isSelected(child.id)"
                                [ariaLabel]="child.displayName || child.resource"
                                (checkedChange)="togglePermission(child)"
                            ></mb-checkbox>
                            <span class="permission-row__check" *ngIf="readOnly && isSelected(child.id)">✓</span>
                            <div class="permission-row__info">
                                <div class="permission-row__title">{{ child.displayName || child.resource }}</div>
                                <div class="permission-row__desc">{{ child.description }}</div>
                            </div>
                        </div>
                        <div class="permission-row__action" *ngFor="let action of actionColumns()">
                            <span class="permission-action" [class.is-on]="hasAction(child, action.key)">
                                {{ hasAction(child, action.key) ? '✓' : '—' }}
                            </span>
                        </div>
                    </div>
                </ng-container>
            </div>
        </div>
    </div>
</div>
