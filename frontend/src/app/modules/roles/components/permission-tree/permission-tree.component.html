<div class="permission-tree">
    <div class="permission-tree__toolbar">
        <app-search-input placeholder="Search permissions…" (search)="search.set($event)"></app-search-input>
        <div class="permission-tree__toolbar-actions">
            <div class="permission-tree__view-toggle" role="group" aria-label="Permission view mode">
                <button type="button" class="permission-tree__view-option"
                    [class.is-active]="viewMode() === 'simple'"
                    (click)="viewMode.set('simple')">
                    Simple view
                </button>
                <button type="button" class="permission-tree__view-option"
                    [class.is-active]="viewMode() === 'detailed'"
                    (click)="viewMode.set('detailed')">
                    Detailed view
                </button>
            </div>
            <button type="button" class="permission-tree__link" (click)="expandAll()">Expand all</button>
            <span class="permission-tree__divider">/</span>
            <button type="button" class="permission-tree__link" (click)="collapseAll()">Collapse all</button>
            <span class="permission-tree__count">Selected: {{ selectedCount }}</span>
        </div>
    </div>
    <div class="permission-tree__filters">
        <label class="permission-tree__toggle">
            <input type="checkbox" [checked]="viewSelectedOnly()"
                (change)="viewSelectedOnly.set($any($event.target).checked)" />
            <span>View selected only</span>
        </label>
        <div class="permission-tree__chips" *ngIf="selectedModuleChips.length">
            @for (chip of visibleModuleChips; track chip.id) {
            <button type="button" class="permission-tree__chip" (click)="clearModuleSelection(chip.id)">
                <span>{{ chip.name }}</span>
                <span class="permission-tree__chip-count">{{ chip.count }}</span>
                <span class="permission-tree__chip-close">×</span>
            </button>
            }
            @if (overflowModuleCount > 0) {
            <span class="permission-tree__chip-overflow">+{{ overflowModuleCount }} more</span>
            }
        </div>
    </div>
    @if (permissionTreeValue.length === 0) {
    <div class="empty-state">
        <p>No permissions available</p>
    </div>
    } @else if (displayedTree.length === 0) {
    <div class="empty-state">
        <p>No permissions match your search</p>
    </div>
    } @else {
    <div class="permission-list">
        @for (permission of displayedTree; track permission.id) {
        <div class="permission-item" [class.has-children]="hasChildren(permission)">
            <!-- Permission Header -->
            <div class="permission-header"
                (click)="viewMode() === 'detailed' && hasChildren(permission) && toggleNode(permission.id)">
                <!-- Expand/Collapse Icon -->
                @if (hasChildren(permission) && viewMode() === 'detailed') {
                <button class="expand-btn" type="button">
                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none"
                        stroke="currentColor" stroke-width="2" [class.expanded]="isExpanded(permission.id)">
                        <polyline points="9 18 15 12 9 6"></polyline>
                    </svg>
                </button>
                } @else {
                <span class="expand-placeholder"></span>
                }

                <!-- Checkbox -->
                <label class="checkbox-container" (click)="$event.stopPropagation()">
                    @if (hasChildren(permission)) {
                    <input
                        type="checkbox"
                        [checked]="moduleSelectionState(permission).checked"
                        [indeterminate]="moduleSelectionState(permission).indeterminate"
                        [disabled]="readOnly"
                        (change)="togglePermission(permission, $event)"
                    />
                    } @else {
                    <input type="checkbox" [checked]="isSelected(permission.id)"
                        [disabled]="readOnly"
                        [indeterminate]="isIndeterminate(permission)" (change)="togglePermission(permission, $event)" />
                    }
                    <span class="checkmark"></span>
                </label>

                <!-- Permission Info -->
                <div class="permission-info">
                    <div class="permission-name">
                        @if (permission.icon) {
                        <span class="permission-icon">{{ permission.icon }}</span>
                        }
                        <span class="name-text">{{ permission.displayName }}</span>
                        @if (hasChildren(permission)) {
                        <span class="permission-count-badge">
                            {{ moduleCoverage(permission).enabled }}/{{ moduleCoverage(permission).total }}
                        </span>
                        }
                    </div>
                    @if (permission.description) {
                    <div class="permission-description">{{ permission.description }}</div>
                    }
                </div>

                <!-- Action Badges -->
                @if (!hasChildren(permission)) {
                <div class="permission-actions">
                    @for (action of displayActions(permission.actions); track action) {
                    <span class="action-badge" [class]="'action-' + action">
                        {{ action }}
                    </span>
                    }
                </div>
                }
            </div>

            <!-- Children -->
            @if (viewMode() === 'detailed' && hasChildren(permission) && isExpanded(permission.id)) {
            <div class="permission-children">
                <div class="permission-matrix__header">
                    <div class="permission-matrix__cell permission-matrix__cell--name">Permission</div>
                    @for (action of actionColumns; track action) {
                    <div class="permission-matrix__cell permission-matrix__cell--action">{{ action }}</div>
                    }
                </div>
                @for (row of rowsForGroup(permission); track row.permission.id) {
                <div class="permission-matrix__row" [class.is-nested]="row.depth > 0">
                    <div class="permission-matrix__cell permission-matrix__cell--name">
                        <div class="permission-matrix__name">
                            @if (row.permission.icon) {
                            <span class="permission-icon">{{ row.permission.icon }}</span>
                            }
                            <span class="name-text">{{ row.permission.displayName }}</span>
                            @if (isSensitive(row.permission)) {
                            <span class="permission-risk" title="This permission grants access to sensitive data.">⚠</span>
                            }
                        </div>
                        @if (row.permission.description) {
                        <div class="permission-matrix__desc">{{ row.permission.description }}</div>
                        }
                    </div>
                    @for (action of actionColumns; track action) {
                    <div class="permission-matrix__cell permission-matrix__cell--action">
                        <input
                            type="checkbox"
                            class="permission-matrix__checkbox"
                            [checked]="isSelected(row.permission.id) && hasAction(row.permission, action)"
                            [disabled]="readOnly || !hasAction(row.permission, action)"
                            (click)="togglePermission(row.permission, $event)"
                        />
                    </div>
                    }
                </div>
                }
            </div>
            }
        </div>
        }
    </div>
    }
</div>
