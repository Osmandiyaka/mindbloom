<div class="permission-tree"
    [class.density-compact]="densityMode() === 'compact'"
    [class.density-comfortable]="densityMode() === 'comfortable'">
    <div class="permission-tree__toolbar">
        <app-search-input placeholder="Search permissions…" (search)="search.set($event)"></app-search-input>
        <div class="permission-tree__toolbar-actions">
            <div class="permission-tree__view-toggle" role="group" aria-label="Permission view mode">
                <ui-button
                    class="permission-tree__view-option"
                    size="sm"
                    variant="ghost"
                    [class.is-active]="viewMode() === 'simple'"
                    (click)="viewMode.set('simple')">
                    Simple view
                </ui-button>
                <ui-button
                    class="permission-tree__view-option"
                    size="sm"
                    variant="ghost"
                    [class.is-active]="viewMode() === 'detailed'"
                    (click)="viewMode.set('detailed')">
                    Detailed view
                </ui-button>
            </div>
            <div class="permission-tree__view-toggle" role="group" aria-label="Density mode">
                <ui-button
                    class="permission-tree__view-option"
                    size="sm"
                    variant="ghost"
                    [class.is-active]="densityMode() === 'comfortable'"
                    (click)="setDensity('comfortable')">
                    Comfortable
                </ui-button>
                <ui-button
                    class="permission-tree__view-option"
                    size="sm"
                    variant="ghost"
                    [class.is-active]="densityMode() === 'compact'"
                    (click)="setDensity('compact')">
                    Compact
                </ui-button>
            </div>
            <ui-button
                class="permission-tree__link"
                size="sm"
                variant="ghost"
                [disabled]="readOnly || displayedTree.length === 0"
                (click)="selectVisibleResults()">
                Select all results
            </ui-button>
            <span class="permission-tree__divider">/</span>
            <ui-button
                class="permission-tree__link"
                size="sm"
                variant="ghost"
                [disabled]="readOnly"
                (click)="clearAllSelections()">
                Clear all
            </ui-button>
            <ui-button class="permission-tree__link" size="sm" variant="ghost" (click)="expandAll()">Expand all</ui-button>
            <span class="permission-tree__divider">/</span>
            <ui-button class="permission-tree__link" size="sm" variant="ghost" (click)="collapseAll()">Collapse all</ui-button>
            <span class="permission-tree__count">Selected: {{ selectedCount }}</span>
        </div>
    </div>
    <div class="permission-tree__filters">
        <ui-checkbox
            class="permission-tree__toggle"
            [checked]="viewSelectedOnly()"
            (checkedChange)="viewSelectedOnly.set($event)">
            View selected only
        </ui-checkbox>
        @if (searchSummary) {
        <div class="permission-tree__search-summary">
            Showing {{ searchSummary.results }} results in {{ searchSummary.categories }} categories
        </div>
        }
        <div class="permission-tree__chips" *ngIf="selectedModuleChips.length">
            @for (chip of visibleModuleChips; track chip.id) {
            <ui-button
                class="permission-tree__chip"
                size="sm"
                variant="ghost"
                (click)="clearModuleSelection(chip.id)">
                <span>{{ chip.name }}</span>
                <span class="permission-tree__chip-count">{{ chip.count }}</span>
                <span class="permission-tree__chip-close">×</span>
            </ui-button>
            }
            @if (overflowModuleCount > 0) {
            <span class="permission-tree__chip-overflow">+{{ overflowModuleCount }} more</span>
            }
        </div>
    </div>
    @if (permissionTreeValue.length === 0) {
    <div class="empty-state">
        <p>No permissions available</p>
    </div>
    } @else if (viewSelectedOnly() && selectedCount === 0) {
    <div class="empty-state">
        <p class="empty-state__title">No permissions selected</p>
        <p class="empty-state__body">Select permissions to build this role.</p>
        <ui-button
            class="empty-state__action"
            size="sm"
            variant="ghost"
            (click)="viewSelectedOnly.set(false)">
            Clear filter
        </ui-button>
    </div>
    } @else if (displayedTree.length === 0 && search().trim().length) {
    <div class="empty-state">
        <p class="empty-state__title">No results</p>
        <p class="empty-state__body">Try a different search term.</p>
    </div>
    } @else if (displayedTree.length === 0) {
    <div class="empty-state">
        <p>No permissions match your search</p>
    </div>
    } @else {
    <div class="permission-list" role="tree">
        @for (permission of displayedTree; track permission.id) {
        <div class="permission-item" [class.has-children]="hasChildren(permission)" [class.is-expanded]="isExpanded(permission.id)">
            <!-- Permission Header -->
            <div
                #treeRow
                class="permission-header permission-row"
                role="treeitem"
                [attr.aria-expanded]="hasChildren(permission) ? isExpanded(permission.id) : null"
                [attr.aria-level]="1"
                tabindex="0"
                (keydown)="handleRowKeydown($event, permission, true)"
                (click)="viewMode() === 'detailed' && hasChildren(permission) && toggleNode(permission.id)">
                <!-- Expand/Collapse Icon -->
            @if (hasChildren(permission) && viewMode() === 'detailed') {
                <ui-button class="expand-btn" type="button" size="sm" variant="ghost">
                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none"
                        stroke="currentColor" stroke-width="2" [class.expanded]="isExpanded(permission.id)">
                        <polyline points="9 18 15 12 9 6"></polyline>
                    </svg>
                </ui-button>
                } @else {
                <span class="expand-placeholder"></span>
                }

                <!-- Checkbox -->
                <ui-checkbox
                    class="permission-checkbox"
                    [checked]="hasChildren(permission) ? moduleSelectionState(permission).checked : isSelected(permission.id)"
                    [indeterminate]="hasChildren(permission) ? moduleSelectionState(permission).indeterminate : isIndeterminate(permission)"
                    [disabled]="readOnly"
                    [hideLabel]="true"
                    (click)="$event.stopPropagation()"
                    (checkedChange)="togglePermission(permission)">
                </ui-checkbox>

                <!-- Permission Info -->
                <div class="permission-info">
                    <div class="permission-name">
                        <span class="permission-icon">
                            @switch (iconKey(permission)) {
                            @case ('users') {
                            <svg viewBox="0 0 24 24" aria-hidden="true">
                                <path d="M17 21a4 4 0 0 0-4-4H7a4 4 0 0 0-4 4"></path>
                                <circle cx="9" cy="7" r="4"></circle>
                                <path d="M23 21a4 4 0 0 0-3-3.87"></path>
                                <path d="M16 3.13a4 4 0 0 1 0 7.75"></path>
                            </svg>
                            }
                            @case ('book') {
                            <svg viewBox="0 0 24 24" aria-hidden="true">
                                <path d="M4 19.5A2.5 2.5 0 0 1 6.5 17H20"></path>
                                <path d="M4 4.5A2.5 2.5 0 0 1 6.5 2H20v20H6.5A2.5 2.5 0 0 1 4 19.5z"></path>
                                <path d="M8 2v15"></path>
                            </svg>
                            }
                            @case ('calendar') {
                            <svg viewBox="0 0 24 24" aria-hidden="true">
                                <rect x="3" y="4" width="18" height="18" rx="2"></rect>
                                <path d="M16 2v4M8 2v4M3 10h18"></path>
                            </svg>
                            }
                            @case ('settings') {
                            <svg viewBox="0 0 24 24" aria-hidden="true">
                                <circle cx="12" cy="12" r="3"></circle>
                                <path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1-2.83 2.83l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-4 0v-.09a1.65 1.65 0 0 0-1-1.51 1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 1 1-2.83-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1 0-4h.09a1.65 1.65 0 0 0 1.51-1 1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 1 1 2.83-2.83l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 4 0v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 1 1 2.83 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9c0 .66.39 1.26 1 1.51H21a2 2 0 0 1 0 4h-.09a1.65 1.65 0 0 0-1.51 1z"></path>
                            </svg>
                            }
                            @case ('shield') {
                            <svg viewBox="0 0 24 24" aria-hidden="true">
                                <path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"></path>
                            </svg>
                            }
                            @case ('chart') {
                            <svg viewBox="0 0 24 24" aria-hidden="true">
                                <path d="M3 3v18h18"></path>
                                <rect x="7" y="12" width="3" height="6"></rect>
                                <rect x="12" y="9" width="3" height="9"></rect>
                                <rect x="17" y="6" width="3" height="12"></rect>
                            </svg>
                            }
                            @default {
                            <svg viewBox="0 0 24 24" aria-hidden="true">
                                <path d="M22 19a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h5l2 2h9a2 2 0 0 1 2 2z"></path>
                            </svg>
                            }
                            }
                        </span>
                        <span class="name-text" [innerHTML]="highlightText(permission.displayName)"></span>
                        @if (hasChildren(permission)) {
                        <span class="permission-children-count">· {{ permissionCount(permission) }} permissions</span>
                        <span class="permission-status" [class]="'permission-status--' + moduleStatus(permission).state">
                            @if (moduleStatus(permission).state === 'all') {
                            <svg viewBox="0 0 16 16" aria-hidden="true">
                                <path d="M13.5 4.5l-6 6-3-3" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"></path>
                            </svg>
                            }
                            <span>{{ moduleStatus(permission).label }}</span>
                            <span class="permission-status__count">({{ moduleStatus(permission).count }})</span>
                        </span>
                        }
                    </div>
                    @if (permission.description) {
                    <div class="permission-description" [innerHTML]="highlightText(permission.description)"></div>
                    }
                </div>

                <!-- Action Badges -->
                @if (!hasChildren(permission) && permission.actions?.length) {
                <div class="permission-actions">
                    @for (action of displayActions(permission.actions); track action) {
                    <span class="action-badge" [class]="'action-' + action">
                        {{ action | uppercase }}
                    </span>
                    }
                </div>
                }
            </div>

            <!-- Children -->
            @if (viewMode() === 'detailed' && hasChildren(permission) && isExpanded(permission.id)) {
            <div class="permission-children" role="group">
                @for (row of rowsForGroup(permission); track row.permission.id) {
                <div
                    #treeRow
                    class="permission-child-row permission-row"
                    role="treeitem"
                    [attr.aria-level]="row.depth + 2"
                    tabindex="0"
                    [class.is-nested]="row.depth > 0"
                    (keydown)="handleRowKeydown($event, row.permission, false)"
                >
                    <ui-checkbox
                        class="permission-checkbox"
                        [checked]="hasChildren(row.permission) ? moduleSelectionState(row.permission).checked : isSelected(row.permission.id)"
                        [indeterminate]="hasChildren(row.permission) ? moduleSelectionState(row.permission).indeterminate : false"
                        [disabled]="readOnly"
                        [hideLabel]="true"
                        (click)="$event.stopPropagation()"
                        (checkedChange)="togglePermission(row.permission)">
                    </ui-checkbox>
                    <div class="permission-child-info">
                        <div class="permission-child-name">
                            <span class="permission-icon">
                                @switch (iconKey(row.permission)) {
                                @case ('users') {
                                <svg viewBox="0 0 24 24" aria-hidden="true">
                                    <path d="M17 21a4 4 0 0 0-4-4H7a4 4 0 0 0-4 4"></path>
                                    <circle cx="9" cy="7" r="4"></circle>
                                    <path d="M23 21a4 4 0 0 0-3-3.87"></path>
                                    <path d="M16 3.13a4 4 0 0 1 0 7.75"></path>
                                </svg>
                                }
                                @case ('book') {
                                <svg viewBox="0 0 24 24" aria-hidden="true">
                                    <path d="M4 19.5A2.5 2.5 0 0 1 6.5 17H20"></path>
                                    <path d="M4 4.5A2.5 2.5 0 0 1 6.5 2H20v20H6.5A2.5 2.5 0 0 1 4 19.5z"></path>
                                    <path d="M8 2v15"></path>
                                </svg>
                                }
                                @case ('calendar') {
                                <svg viewBox="0 0 24 24" aria-hidden="true">
                                    <rect x="3" y="4" width="18" height="18" rx="2"></rect>
                                    <path d="M16 2v4M8 2v4M3 10h18"></path>
                                </svg>
                                }
                                @case ('settings') {
                                <svg viewBox="0 0 24 24" aria-hidden="true">
                                    <circle cx="12" cy="12" r="3"></circle>
                                    <path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1-2.83 2.83l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-4 0v-.09a1.65 1.65 0 0 0-1-1.51 1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 1 1-2.83-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1 0-4h.09a1.65 1.65 0 0 0 1.51-1 1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 1 1 2.83-2.83l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 4 0v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 1 1 2.83 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9c0 .66.39 1.26 1 1.51H21a2 2 0 0 1 0 4h-.09a1.65 1.65 0 0 0-1.51 1z"></path>
                                </svg>
                                }
                                @case ('shield') {
                                <svg viewBox="0 0 24 24" aria-hidden="true">
                                    <path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"></path>
                                </svg>
                                }
                                @case ('chart') {
                                <svg viewBox="0 0 24 24" aria-hidden="true">
                                    <path d="M3 3v18h18"></path>
                                    <rect x="7" y="12" width="3" height="6"></rect>
                                    <rect x="12" y="9" width="3" height="9"></rect>
                                    <rect x="17" y="6" width="3" height="12"></rect>
                                </svg>
                                }
                                @default {
                                <svg viewBox="0 0 24 24" aria-hidden="true">
                                    <path d="M22 19a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h5l2 2h9a2 2 0 0 1 2 2z"></path>
                                </svg>
                                }
                                }
                            </span>
                            <span class="name-text" [innerHTML]="highlightText(row.permission.displayName)"></span>
                            @if (isSensitive(row.permission)) {
                            <span class="permission-risk" title="This permission grants access to sensitive data.">
                                <svg viewBox="0 0 24 24" aria-hidden="true">
                                    <path d="M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z"></path>
                                    <path d="M12 9v4"></path>
                                    <path d="M12 17h.01"></path>
                                </svg>
                            </span>
                            }
                        </div>
                        @if (row.permission.description) {
                        <div class="permission-child-desc" [innerHTML]="highlightText(row.permission.description)"></div>
                        }
                    </div>
                    @if (row.permission.actions?.length) {
                    <div class="permission-child-actions">
                        @for (action of displayActions(row.permission.actions); track action) {
                        <span class="permission-action-chip">{{ action | uppercase }}</span>
                        }
                    </div>
                    }
                </div>
                }
            </div>
            }
        </div>
        }
    </div>
    }
</div>
