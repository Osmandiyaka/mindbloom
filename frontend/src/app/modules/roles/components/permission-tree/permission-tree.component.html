<div class="permission-tree">
    <div class="permission-tree__toolbar">
        <app-search-input placeholder="Search permissionsâ€¦" (search)="search.set($event)"></app-search-input>
        <div class="permission-tree__toolbar-actions">
            <button type="button" class="permission-tree__link" (click)="expandAll()">Expand all</button>
            <span class="permission-tree__divider">/</span>
            <button type="button" class="permission-tree__link" (click)="collapseAll()">Collapse all</button>
            <span class="permission-tree__count">Selected: {{ selectedCount }}</span>
        </div>
    </div>
    @if (permissionTreeValue.length === 0) {
    <div class="empty-state">
        <p>No permissions available</p>
    </div>
    } @else if (filteredTree.length === 0) {
    <div class="empty-state">
        <p>No permissions match your search</p>
    </div>
    } @else {
    <div class="permission-list">
        @for (permission of filteredTree; track permission.id) {
        <div class="permission-item" [class.has-children]="hasChildren(permission)">
            <!-- Permission Header -->
            <div class="permission-header" (click)="hasChildren(permission) && toggleNode(permission.id)">
                <!-- Expand/Collapse Icon -->
                @if (hasChildren(permission)) {
                <button class="expand-btn" type="button">
                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none"
                        stroke="currentColor" stroke-width="2" [class.expanded]="isExpanded(permission.id)">
                        <polyline points="9 18 15 12 9 6"></polyline>
                    </svg>
                </button>
                } @else {
                <span class="expand-placeholder"></span>
                }

                <!-- Checkbox -->
                <label class="checkbox-container" (click)="$event.stopPropagation()">
                    @if (hasChildren(permission)) {
                    <input
                        type="checkbox"
                        [checked]="moduleSelectionState(permission).checked"
                        [indeterminate]="moduleSelectionState(permission).indeterminate"
                        [disabled]="readOnly"
                        (change)="togglePermission(permission, $event)"
                    />
                    } @else {
                    <input type="checkbox" [checked]="isSelected(permission.id)"
                        [disabled]="readOnly"
                        [indeterminate]="isIndeterminate(permission)" (change)="togglePermission(permission, $event)" />
                    }
                    <span class="checkmark"></span>
                </label>

                <!-- Permission Info -->
                <div class="permission-info">
                    <div class="permission-name">
                        @if (permission.icon) {
                        <span class="permission-icon">{{ permission.icon }}</span>
                        }
                        <span class="name-text">{{ permission.displayName }}</span>
                        @if (hasChildren(permission)) {
                        <span class="permission-count-badge">
                            {{ moduleCoverage(permission).enabled }}/{{ moduleCoverage(permission).total }}
                        </span>
                        }
                    </div>
                    @if (permission.description) {
                    <div class="permission-description">{{ permission.description }}</div>
                    }
                </div>

                <!-- Action Badges -->
                @if (!hasChildren(permission)) {
                <div class="permission-actions">
                    @for (action of displayActions(permission.actions); track action) {
                    <span class="action-badge" [class]="'action-' + action">
                        {{ action }}
                    </span>
                    }
                </div>
                }
            </div>

            <!-- Children -->
            @if (hasChildren(permission) && isExpanded(permission.id)) {
            <div class="permission-children">
                @for (child of permission.children; track child.id) {
                <div class="child-permission">
                    <label class="checkbox-container">
                        <input type="checkbox" [checked]="isSelected(child.id)"
                            [disabled]="readOnly"
                            (change)="togglePermission(child, $event)" />
                        <span class="checkmark"></span>
                    </label>

                    <div class="permission-info">
                        <div class="permission-name">
                            @if (child.icon) {
                            <span class="permission-icon">{{ child.icon }}</span>
                            }
                            <span class="name-text">{{ child.displayName }}</span>
                        </div>
                        @if (child.description) {
                        <div class="permission-description">{{ child.description }}</div>
                        }
                    </div>

                    <div class="permission-actions">
                        @for (action of displayActions(child.actions); track action) {
                        <span class="action-badge" [class]="'action-' + action">
                            {{ action }}
                        </span>
                        }
                    </div>
                </div>
                }
            </div>
            }
        </div>
        }
    </div>
    }
</div>
