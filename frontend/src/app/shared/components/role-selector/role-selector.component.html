<button type="button" class="role-trigger" (click)="open()">
  <div class="icon-chip">
    <svg viewBox="0 0 24 24" aria-hidden="true">
      <path
        d="M12 12c2.21 0 4-1.79 4-4S14.21 4 12 4 8 5.79 8 8s1.79 4 4 4Zm0 2c-3.31 0-6 1.79-6 4v1h12v-1c0-2.21-2.69-4-6-4Z"
        fill="currentColor" />
      <path
        d="M17 12.87a4.001 4.001 0 0 0 0-7.74 5.99 5.99 0 0 1 0 7.74ZM19 14a5.99 5.99 0 0 0-4.9 2.55c1.66.4 2.9 1.34 3.39 2.45H22v-1c0-2-1.79-4-3-4Z"
        opacity="0.6" fill="currentColor" />
    </svg>
  </div>
  <div class="trigger-text">
    <span>Select roles</span>
    <small>{{ selectedCount() ? selectedCount() + ' selected' : 'System & custom roles' }}</small>
  </div>
  <span class="pill" *ngIf="selectedCount()">{{ selectedCount() }}</span>
</button>

<div class="role-selector-overlay" *ngIf="isOpen()">
  <div class="modal" role="dialog" aria-modal="true">
    <header class="modal-header">
      <div>
        <p class="eyebrow">Roles</p>
        <h2>Assign roles to invitees</h2>
        <p class="subtitle">System roles and tenant-defined roles, all in one list.</p>
      </div>
      <button class="icon-btn" (click)="close()" aria-label="Close">
        <svg viewBox="0 0 24 24">
          <path d="M6 6l12 12M6 18 18 6" stroke="currentColor" stroke-width="2" stroke-linecap="round" />
        </svg>
      </button>
    </header>

    <div class="toolbar">
      <app-search-input class="search-field" placeholder="Search roles" (search)="search.set($event)"></app-search-input>
      <span class="selected-indicator">
        <svg viewBox="0 0 24 24">
          <path d="M9.5 17 5 12.5l1.5-1.5L9.5 14l8-8 1.5 1.5-9.5 9.5Z" fill="currentColor" />
        </svg>
        {{ selectedCount() }} selected
      </span>
    </div>

    <div class="table-wrapper">
      <table>
        <thead>
          <tr>
            <th style="width: 48px;"></th>
            <th>Role</th>
            <th>Type</th>
            <th>Permissions</th>
          </tr>
        </thead>
        <tbody>
          <tr *ngFor="let role of filteredRoles()">
            <td>
              <label class="checkbox">
                <input type="checkbox" [checked]="isSelected(role.id)" (change)="toggle(role)" />
                <span></span>
              </label>
            </td>
            <td class="role-name">
              <span class="role-icon" [class.system]="role.isSystemRole">
                <svg viewBox="0 0 24 24">
                  <path d="M12 2 3 7l9 5 9-5-9-5Zm0 9-9-5v11l9 5 9-5V6l-9 5Z" fill="currentColor" />
                </svg>
              </span>
              <div>
                <div class="name">{{ role.name }}</div>
                <div class="meta">{{ role.description || 'No description' }}</div>
              </div>
            </td>
            <td>
              <span class="chip" [class.system]="role.isSystemRole" [class.custom]="!role.isSystemRole">
                <svg viewBox="0 0 24 24">
                  <path d="M12 2 3 7v10l9 5 9-5V7l-9-5Zm0 2.18 6 3.33v6.98l-6 3.33-6-3.33V7.51l6-3.33Z"
                    fill="currentColor" />
                </svg>
                {{ role.isSystemRole ? 'System' : 'Custom' }}
              </span>
            </td>
            <td>
              <span class="pill neutral">
                <svg viewBox="0 0 24 24">
                  <path d="M12 2a10 10 0 1 0 .001 20.001A10 10 0 0 0 12 2Zm1 15h-2v-2h2v2Zm0-4h-2V7h2v6Z"
                    fill="currentColor" />
                </svg>
                {{ role.permissions.length || 0 }} perms
              </span>
            </td>
          </tr>
        </tbody>
      </table>
      <p *ngIf="!filteredRoles().length" class="empty">No roles match your search.</p>
    </div>

    <footer class="modal-footer">
      <button class="ghost" (click)="close()">Cancel</button>
      <button class="primary" (click)="confirm()">
        <svg viewBox="0 0 24 24">
          <path d="m9 16-4-4 1.41-1.41L9 13.17l8.59-8.58L19 6l-10 10Z" fill="currentColor" />
        </svg>
        Use {{ selectedCount() }} role{{ selectedCount() === 1 ? '' : 's' }}
      </button>
    </footer>
  </div>
</div>
